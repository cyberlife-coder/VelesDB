# Plan 08-04: /query/explain Route & Server Integration

**Phase:** 8 — VelesQL Execution Completeness
**Requirement:** VP-013
**Estimate:** 1-2h
**Depends on:** Plans 08-01 to 08-03

---

## Goal

Route the `/query/explain` endpoint in the server and update the `/query` handler to use `Database::execute_query()` for JOIN/compound support.

---

## Tasks

### Task 1: Route /query/explain Endpoint

**File:** `crates/velesdb-server/src/main.rs`

Add the missing route:

```rust
.route("/query", post(query))
.route("/query/explain", post(explain))  // <-- ADD THIS LINE
.route("/collections/{name}/match", post(match_query))
```

Also update the import to include `explain`:

```rust
use velesdb_server::{
    ..., explain, ...
};
```

**Test:** `cargo test` passes, then manual verify with:
```bash
curl -X POST http://localhost:8080/query/explain \
  -H "Content-Type: application/json" \
  -d '{"query": "SELECT * FROM docs WHERE category = '\''tech'\'' LIMIT 10", "params": {}}'
```

### Task 2: Update /query Handler to Use Database::execute_query()

**File:** `crates/velesdb-server/src/handlers/query.rs`

Replace the current flow:
```rust
// BEFORE: Single-collection only
let collection = state.db.get_collection(&select.from).ok_or(...)?;
let results = collection.execute_query(&parsed, &req.params)?;
```

With:
```rust
// AFTER: Cross-collection JOIN + compound support
let results = state.db.execute_query(&parsed, &req.params)?;
```

This delegates to `Database::execute_query()` which handles:
- FROM collection resolution
- Base query execution
- JOIN post-processing
- Compound query post-processing

**Tests:**
- Existing server tests must still pass
- `test_query_with_join_via_server` — integration test
- `test_query_explain_endpoint_routed` — 200 response from /query/explain

### Task 3: Quality Gates

```powershell
cargo fmt --all --check
cargo clippy -- -D warnings
cargo test --workspace
cargo build --release
```

---

## Acceptance Criteria

- [ ] `POST /query/explain` returns 200 with query plan
- [ ] Swagger/OpenAPI shows /query/explain endpoint
- [ ] `/query` handler uses `Database::execute_query()` for cross-collection support
- [ ] All existing server tests pass (no regression)
- [ ] All quality gates pass

---

## Files

| File | Action |
|------|--------|
| `crates/velesdb-server/src/main.rs` | **Modify** — add `/query/explain` route + import |
| `crates/velesdb-server/src/handlers/query.rs` | **Modify** — use `Database::execute_query()` |

---
*Created: 2026-02-09*
