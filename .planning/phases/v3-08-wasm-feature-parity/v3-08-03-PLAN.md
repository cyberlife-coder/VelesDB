---
phase: v3-08
plan: 03
name: WASM ColumnStore IndexedDB Persistence
wave: 3
depends_on: [v3-08-02]
autonomous: true
parallel_safe: false
---

# Phase v3-08 Plan 03: WASM ColumnStore IndexedDB Persistence

## Objective

Add IndexedDB persistence for `ColumnStoreWasm`, following the same pattern as
`GraphPersistence`. Enables offline-first PWA with persistent structured data.

## Context

**Requirements addressed:** WASM Feature Parity — persistent Column Store in browser
**Phase goal contribution:** Without persistence, Column Store data is lost on page reload.

**Pattern:** Reuse the same `GraphPersistence` IndexedDB pattern:
- Namespaced keys (`{store_name}:row:{pk}`)
- Metadata store for schema and row count
- Async save/load via `wasm-bindgen-futures`

## Tasks

### Task 1: Create `column_store_persistence.rs`

**Files:** `crates/velesdb-wasm/src/column_store_persistence.rs` (new)

**Action:**
Create `ColumnStorePersistence` with:
- `new()` → sync constructor
- `init()` → async, opens IndexedDB database
- `save(name: &str, store: &ColumnStoreWasm)` → serialize schema + rows to IndexedDB
- `load(name: &str)` → deserialize from IndexedDB → `ColumnStoreWasm`
- `list_stores()` → list saved column store names
- `delete_store(name: &str)` → remove a saved store

**Serialization strategy:**
- Metadata: `{name}:meta` → JSON `{schema, row_count, pk_column, version}`
- Rows: `{name}:row:{pk}` → JSON row object (one IndexedDB entry per row)
- String table: `{name}:strings` → serialized string intern table

### Task 2: Register Module + Tests

**Files:** `crates/velesdb-wasm/src/lib.rs`, test file

**Tests:** (require wasm-pack, structural verification only in native)
1. `test_column_persistence_save_load_roundtrip` — save schema + rows, load back, verify equality
2. `test_column_persistence_metadata` — verify metadata includes schema and PK info

## Success Criteria

- [ ] `ColumnStorePersistence` struct with save/load/list/delete
- [ ] Schema + data + string table survive IndexedDB roundtrip
- [ ] Same API pattern as `GraphPersistence`
- [ ] All workspace tests pass

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-wasm/src/column_store_persistence.rs` (new)
- `crates/velesdb-wasm/src/lib.rs` (add mod)
