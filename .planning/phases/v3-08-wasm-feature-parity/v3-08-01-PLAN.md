---
phase: v3-08
plan: 01
name: Extract ColumnStore from Persistence Gate
wave: 1
depends_on: [v3-01]
autonomous: true
parallel_safe: true
---

# Phase v3-08 Plan 01: Extract ColumnStore from Persistence Gate

## Objective

Make `column_store` module available without the `persistence` feature flag, just like
`graph` was extracted in v3-01 Plan 02. Only `from_collection.rs` truly depends on
`Collection` — everything else is pure in-memory data structures.

## Context

**Requirements addressed:** WASM Feature Parity — Column Store availability
**Phase goal contribution:** Without this, WASM cannot import `ColumnStore` at all.

**Current state:** `column_store` is gated behind `#[cfg(feature = "persistence")]` in `lib.rs`.
Actual deps: `roaring`, `rustc_hash`, `std::collections` — zero persistence deps.
Only `from_collection.rs` uses `crate::collection::Collection`.

## Tasks

### Task 1: Gate `from_collection.rs` Behind Persistence

**Files:** `crates/velesdb-core/src/column_store/mod.rs`

**Action:**
1. Add `#[cfg(feature = "persistence")]` to `pub mod from_collection;` declaration
2. Add `#[cfg(all(test, feature = "persistence"))]` to `mod from_collection_tests;`
3. Keep all other submodules unconditional

**Verify:**
```powershell
cargo check --package velesdb-core --no-default-features
cargo check --package velesdb-core
```

### Task 2: Remove Persistence Gate from ColumnStore Module

**Files:** `crates/velesdb-core/src/lib.rs`

**Action:**
1. Change `#[cfg(feature = "persistence")] pub mod column_store;` → `pub mod column_store;`
2. Change `#[cfg(all(test, feature = "persistence"))] mod column_store_tests;` → `#[cfg(test)] mod column_store_tests;`
3. Move `column_store` re-exports out of the `#[cfg(feature = "persistence")]` block
4. Add `column_store` to the non-persistence re-exports section

**Verify:**
```powershell
cargo check --package velesdb-core --no-default-features
cargo check --package velesdb-wasm
cargo test --workspace
```

### Task 3: Verify WASM Can Import ColumnStore

**Files:** `crates/velesdb-wasm/Cargo.toml` (read-only check)

**Action:**
1. Verify `velesdb-core` dependency in WASM uses `default-features = false`
2. Confirm `cargo check --package velesdb-wasm` sees `ColumnStore`, `TypedColumn`, etc.
3. Run `cargo test --workspace` — zero regressions

**Done when:**
- `ColumnStore` importable from `velesdb_core::column_store::*` without `persistence`
- `from_collection` only available with `persistence`
- All existing tests pass
- WASM crate can `use velesdb_core::column_store::ColumnStore;`

## Verification

```powershell
cargo check --package velesdb-core --no-default-features
cargo check --package velesdb-wasm
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] `column_store` module unconditionally compiled (no `persistence` gate)
- [ ] `from_collection` still requires `persistence` feature
- [ ] All 3,260+ tests pass
- [ ] WASM crate can import `ColumnStore`

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-core/src/lib.rs` (re-exports)
- `crates/velesdb-core/src/column_store/mod.rs` (feature gate on from_collection)

**Shared read files:** Everything else
