---
phase: v3-08
plan: 04
name: Expose Metrics + Half Precision to WASM
wave: 3
depends_on: [v3-08-01]
autonomous: true
parallel_safe: true
---

# Phase v3-08 Plan 04: Expose Metrics + Half Precision to WASM

## Objective

Expose core's IR metrics (recall, precision, nDCG, MRR) and half-precision (f16/bf16)
modules to WASM via thin bindings. These are already available without `persistence` —
they just need `#[wasm_bindgen]` wrappers.

## Context

**Requirements addressed:** WASM Feature Parity — quality evaluation + memory optimization
**Phase goal contribution:**
- **Metrics:** Allows agents in the browser to evaluate search quality locally
- **Half Precision:** Reduces WASM memory by 50% for embeddings (f32 → f16)

**Current state:** Both modules compile without `persistence` but have no WASM bindings.

## Tasks

### Task 1: WASM Metrics Binding

**Files:** `crates/velesdb-wasm/src/metrics.rs` (new)

**Action:**
Expose core metrics functions via `#[wasm_bindgen]`:

```rust
/// Compute recall@k: proportion of relevant items retrieved.
#[wasm_bindgen]
pub fn recall_at_k(retrieved: &[u64], relevant: &[u64], k: usize) -> f64

/// Compute precision@k: proportion of retrieved items that are relevant.
#[wasm_bindgen]
pub fn precision_at_k(retrieved: &[u64], relevant: &[u64], k: usize) -> f64

/// Compute nDCG@k: normalized discounted cumulative gain.
#[wasm_bindgen]
pub fn ndcg_at_k(retrieved: &[u64], relevant: &[u64], k: usize) -> f64

/// Compute MRR: mean reciprocal rank.
#[wasm_bindgen]
pub fn mrr(retrieved: &[u64], relevant: &[u64]) -> f64

/// Compute hit rate: fraction of queries with at least one relevant result.
#[wasm_bindgen]
pub fn hit_rate(retrieved: &[u64], relevant: &[u64]) -> f64
```

These are direct delegates to `velesdb_core::metrics::*`.

### Task 2: WASM Half Precision Binding

**Files:** `crates/velesdb-wasm/src/half_precision.rs` (new)

**Action:**
Expose f16/bf16 conversion for memory-efficient embedding storage:

```rust
/// Convert f32 vector to f16 bytes (2 bytes per element, 50% memory savings).
#[wasm_bindgen]
pub fn f32_to_f16(vector: &[f32]) -> Vec<u8>

/// Convert f16 bytes back to f32 vector.
#[wasm_bindgen]
pub fn f16_to_f32(bytes: &[u8]) -> Vec<f32>

/// Convert f32 vector to bf16 bytes.
#[wasm_bindgen]
pub fn f32_to_bf16(vector: &[f32]) -> Vec<u8>

/// Convert bf16 bytes back to f32 vector.
#[wasm_bindgen]
pub fn bf16_to_f32(bytes: &[u8]) -> Vec<f32>
```

### Task 3: Register Modules + Tests

**Files:** `crates/velesdb-wasm/src/lib.rs`

**Tests:**
1. `test_recall_at_k` — verify recall calculation
2. `test_precision_at_k` — verify precision calculation
3. `test_ndcg_at_k` — verify nDCG calculation
4. `test_f32_f16_roundtrip` — convert f32→f16→f32, verify within tolerance
5. `test_f32_bf16_roundtrip` — same for bf16
6. `test_f16_memory_savings` — verify output is half the input size

## Verification

```powershell
cargo check --package velesdb-wasm
cargo clippy --package velesdb-wasm -- -D warnings
cargo test --package velesdb-wasm -- metrics half_precision
cargo test --workspace
```

## Success Criteria

- [ ] 5 IR metrics functions exposed to WASM
- [ ] f16/bf16 conversion functions exposed to WASM
- [ ] 6+ tests passing
- [ ] All workspace tests pass

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-wasm/src/metrics.rs` (new)
- `crates/velesdb-wasm/src/half_precision.rs` (new)
- `crates/velesdb-wasm/src/lib.rs` (add mod declarations — coordinate with Plan 02/03)
