---
phase: v3-08
plan: 05
name: Equivalence Tests + Phase Verification
wave: 4
depends_on: [v3-08-02, v3-08-03, v3-08-04]
autonomous: true
parallel_safe: false
---

# Phase v3-08 Plan 05: Equivalence Tests + Phase Verification

## Objective

Create equivalence tests proving WASM ColumnStore produces identical results to core
ColumnStore for the same data. Verify all phase deliverables meet success criteria.
Final quality gate for the phase.

## Context

**Requirements addressed:** WASM Feature Parity — correctness guarantee
**Phase goal contribution:** Ensures the binding layer doesn't introduce bugs.

## Tasks

### Task 1: ColumnStore Equivalence Tests

**Files:** `crates/velesdb-wasm/tests/column_store_equivalence_tests.rs` (new)

**Test scenarios:**

1. **Schema equivalence** — same schema definition produces same column structure
2. **Insert + filter equivalence** — same rows + same filter query → same row indices
3. **Upsert equivalence** — upsert same PK → same row state in both
4. **Delete + vacuum equivalence** — delete + vacuum → same active rows
5. **String interning equivalence** — same strings → same filter results
6. **Batch upsert equivalence** — same batch → same store state
7. **TTL equivalence** — same TTL + expire → same surviving rows
8. **Bitmap filter equivalence** — bitmap AND/OR produce same results as Vec filters

### Task 2: Metrics Equivalence Tests

**Files:** same test file

1. `test_recall_equivalence` — WASM recall == core recall for same data
2. `test_ndcg_equivalence` — WASM nDCG == core nDCG
3. `test_f16_roundtrip_equivalence` — WASM f16 roundtrip == core f16 roundtrip

### Task 3: Full Phase Verification

**Action:**
Run complete quality gates:

```powershell
cargo fmt --all --check
cargo clippy --workspace -- -D warnings
cargo test --workspace
cargo deny check
cargo build --release
```

Verify deleted reimplementations stay deleted:
```powershell
@("simd.rs", "quantization.rs", "filter.rs", "fusion.rs") | ForEach-Object {
    $path = "crates/velesdb-wasm/src/$_"
    if (Test-Path $path) { Write-Error "FAIL: $_ should be deleted" }
}
```

Verify new WASM exports:
```powershell
cargo doc --package velesdb-wasm --no-deps 2>&1 | Select-String "ColumnStoreWasm|metrics|half_precision"
```

## Success Criteria

- [ ] 8+ ColumnStore equivalence tests passing
- [ ] 3+ Metrics/HalfPrecision equivalence tests passing
- [ ] All workspace tests pass
- [ ] All 5 quality gates pass (fmt, clippy, deny, test, release build)
- [ ] WASM crate exports: `VectorStore`, `GraphStore`, `ColumnStoreWasm`, `SemanticMemory`
- [ ] WASM crate exports: `recall_at_k`, `precision_at_k`, `ndcg_at_k`, `mrr`, `hit_rate`
- [ ] WASM crate exports: `f32_to_f16`, `f16_to_f32`, `f32_to_bf16`, `bf16_to_f32`
