---
phase: v3-08
plan: 02
name: WASM ColumnStore Binding
wave: 2
depends_on: [v3-08-01]
autonomous: true
parallel_safe: false
---

# Phase v3-08 Plan 02: WASM ColumnStore Binding

## Objective

Create `#[wasm_bindgen]` bindings for `ColumnStore`, exposing schema definition, CRUD
operations, filtering, and TTL to JavaScript. Follow the same pattern as `GraphStore`
(thin wrapper + conversion at boundary).

## Context

**Requirements addressed:** WASM Feature Parity — ColumnStore in browser
**Phase goal contribution:** This is the core deliverable — makes the "Column" in
"Vector + Graph + Column" available in the browser.

**After Plan 01:** `ColumnStore` is importable by WASM crate.

## Tasks

### Task 1: Create `column_store.rs` WASM Binding

**Files:** `crates/velesdb-wasm/src/column_store.rs` (new)

**Action:**
Create a `ColumnStoreWasm` struct wrapping `velesdb_core::column_store::ColumnStore`:

```rust
#[wasm_bindgen]
pub struct ColumnStoreWasm {
    store: ColumnStore,
}
```

**Methods to expose:**

Schema & Construction:
- `new()` → empty store
- `with_schema(schema: JsValue)` → from JSON `[{"name": "age", "type": "int"}, ...]`
- `with_primary_key(schema: JsValue, pk_column: &str)` → with PK for O(1) lookups
- `add_column(name: &str, col_type: &str)` — "int", "float", "string", "bool"
- `column_names()` → `Vec<String>`

CRUD:
- `insert_row(values: JsValue)` → from JSON `{"age": 25, "name": "Alice"}`
- `upsert_row(values: JsValue)` → insert or update by PK
- `batch_upsert(rows: JsValue)` → array of row objects
- `get_row(pk: i64)` → JSON object or null
- `delete_row(pk: i64)` → bool
- `row_count()`, `active_row_count()`, `deleted_row_count()`

Filtering:
- `filter_eq(column: &str, value: JsValue)` → `Vec<u32>` (row indices)
- `filter_gt(column: &str, value: JsValue)` → `Vec<u32>`
- `filter_lt(column: &str, value: JsValue)` → `Vec<u32>`
- `filter_range(column: &str, low: JsValue, high: JsValue)` → `Vec<u32>`
- `filter_in(column: &str, values: JsValue)` → `Vec<u32>`
- `get_rows_by_indices(indices: &[u32])` → JSON array of row objects

TTL:
- `set_row_ttl(pk: i64, ttl_seconds: u64)` — set expiry
- `expire_rows(now_timestamp: u64)` → number expired

Maintenance:
- `vacuum()` → compact deleted rows
- `clear()` → remove all data
- `memory_usage()` → estimated bytes

**String interning:** Handle transparently — when JS passes `"Alice"`, the binding
interns it via `string_table.get_or_intern("Alice")` before storing as `StringId`.

### Task 2: Register Module in lib.rs

**Files:** `crates/velesdb-wasm/src/lib.rs`

**Action:**
1. Add `mod column_store;`
2. Add `pub use column_store::ColumnStoreWasm;`

### Task 3: Tests

**Files:** `crates/velesdb-wasm/src/column_store_tests.rs` (new)

**Test scenarios:**
1. `test_create_schema_and_insert` — create with schema, insert rows, verify count
2. `test_primary_key_upsert` — upsert same PK twice, verify update not duplicate
3. `test_filter_eq_int` — filter by integer equality
4. `test_filter_eq_string` — filter by string equality (verifies interning)
5. `test_filter_range` — range filter on int column
6. `test_filter_in_string` — IN filter with multiple values
7. `test_delete_and_vacuum` — delete rows, verify excluded from filters, vacuum compacts
8. `test_batch_upsert` — batch insert multiple rows
9. `test_ttl_expire` — set TTL, expire, verify removed
10. `test_memory_usage` — verify non-zero after inserts

## Verification

```powershell
cargo check --package velesdb-wasm
cargo clippy --package velesdb-wasm -- -D warnings
cargo test --package velesdb-wasm -- column_store
cargo test --workspace
```

## Success Criteria

- [ ] `ColumnStoreWasm` exposed via `#[wasm_bindgen]`
- [ ] Full CRUD: schema, insert, upsert, get, delete, batch
- [ ] All 6 filter types working (eq_int, eq_string, gt, lt, range, in)
- [ ] TTL (set_row_ttl + expire_rows) working
- [ ] Vacuum working
- [ ] String interning handled transparently
- [ ] 10+ tests passing
- [ ] All workspace tests pass

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-wasm/src/column_store.rs` (new)
- `crates/velesdb-wasm/src/column_store_tests.rs` (new)
- `crates/velesdb-wasm/src/lib.rs` (add mod declaration)
