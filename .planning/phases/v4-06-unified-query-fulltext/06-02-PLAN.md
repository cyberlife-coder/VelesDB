# Plan 06-02: BM25 + NEAR VelesQL Integration (VP-011)

## Objective

Ensure VelesQL queries combining full-text `MATCH 'keyword'` with vector `NEAR $v` correctly dispatch to the existing `hybrid_search()` method, and validate BM25/Trigram integration paths.

**Estimate:** 2-3h
**Wave:** 1 (parallel with 06-01)

---

## Context

### Current State
- `hybrid_search()` in `text.rs` works correctly at the Collection API level
- `execute_query()` partially handles `MATCH`:
  - `(None, None, Some(Match))` → calls `text_search()` (BM25 only)
  - `(Some(vector), None, Some(cond))` → checks for MATCH and calls `hybrid_search()`
- **Gap:** The MATCH condition extraction in `execute_query()` only works in one branch
- **Gap:** NEAR + MATCH 'keyword' + metadata filter not tested end-to-end via VelesQL

### Target State
- `WHERE vector NEAR $v AND MATCH 'keyword'` → `hybrid_search()`
- `WHERE MATCH 'keyword' AND category = 'tech'` → `text_search_with_filter()`
- `WHERE vector NEAR $v AND MATCH 'keyword' AND category = 'tech'` → `hybrid_search_with_filter()`
- All paths tested via VelesQL `execute_query()`

---

## Tasks

### Task 1: TDD — Write BM25+NEAR VelesQL integration tests

**Files:** `crates/velesdb-core/src/collection/search/query/bm25_integration_tests.rs`

**Action:**
1. Create test file with tests for:
   - `test_velesql_match_keyword_only` — `WHERE MATCH 'rust'` → text_search
   - `test_velesql_near_and_match` — `WHERE vector NEAR $v AND MATCH 'rust'` → hybrid_search
   - `test_velesql_match_with_filter` — `WHERE MATCH 'rust' AND category = 'tech'` → text_search_with_filter
   - `test_velesql_near_match_filter` — three-way combination
   - `test_velesql_match_with_limit` — LIMIT respected
   - `test_velesql_match_with_order_by` — ORDER BY works after text search
2. Register test module in `mod.rs`

**Verify:** `cargo test bm25_integration_tests -- --no-run`

**Done:** Test file created, module registered

### Task 2: Improve MATCH condition extraction in execute_query()

**Files:** `crates/velesdb-core/src/collection/search/query/extraction.rs`

**Action:**
1. Add/improve `extract_match_query()` to recursively find `Condition::Match` in AND trees
2. Ensure it works in ALL branches of execute_query(), not just the `(Some(vector), None, Some)` branch
3. Extract remaining metadata filter after removing MATCH condition (similar to how similarity is extracted)

**Verify:** `cargo check --package velesdb-core`

**Done:** Match extraction works in all condition tree positions

### Task 3: Wire three-way dispatch in execute_query()

**Files:** `crates/velesdb-core/src/collection/search/query/mod.rs`

**Action:**
1. After extracting vector_search and similarity conditions, also extract text_match:
   ```
   let text_match = filter_condition.as_ref().and_then(Self::extract_match_query);
   ```
2. Add dispatch logic for combinations:
   - `(Some(vector), text_match=Some(query), Some(filter))` → `hybrid_search_with_filter()`
   - `(Some(vector), text_match=Some(query), None)` → `hybrid_search()`
   - `(None, text_match=Some(query), Some(filter))` → `text_search_with_filter()`
3. Ensure the remaining filter excludes the already-extracted MATCH condition

**Verify:** `cargo test bm25_integration_tests`

**Done:** All BM25 integration tests pass GREEN

### Task 4: Verify edge cases and quality gates

**Files:** Various

**Action:**
1. Empty MATCH query string → return empty results (not error)
2. MATCH + NEAR_FUSED → return clear error (unsupported combination for now)
3. MATCH + similarity() → return clear error or handle gracefully
4. Run full test suite and clippy

**Verify:** `cargo test --workspace && cargo clippy --package velesdb-core -- -D warnings`

**Done:** All tests pass, clippy clean, no regressions

---

## Success Criteria

- [ ] All 6+ tests pass for BM25 VelesQL integration
- [ ] `WHERE vector NEAR $v AND MATCH 'keyword'` dispatches correctly
- [ ] `WHERE MATCH 'keyword' AND metadata = value` works
- [ ] Three-way combination works
- [ ] `cargo clippy -- -D warnings` clean
- [ ] `cargo test --workspace` passes (no regressions)
