# Plan 06-01: NEAR_FUSED Execution Wiring (VP-012)

## Objective

Wire the existing `VectorFusedSearch` AST node through `execute_query()` to the existing `multi_query_search()` infrastructure, enabling end-to-end execution of `NEAR_FUSED` queries.

**Estimate:** 3-4h
**Wave:** 1 (parallel with 06-02)

---

## Context

### Current State
- **Parser:** ✅ `grammar.pest` parses `vector NEAR_FUSED [$v1, $v2] USING FUSION 'rrf'`
- **AST:** ✅ `VectorFusedSearch { vectors, fusion }` in `ast/condition.rs`
- **Validation:** ✅ Counted as vector search condition in both validators
- **Execution:** ❌ `execute_query()` ignores `VectorFusedSearch` — falls through as identity

### Target State
- `execute_query()` detects `VectorFusedSearch` condition
- Resolves vector parameters from `params` map
- Maps `FusionConfig` → `FusionStrategy`
- Calls `self.multi_query_search()` with resolved vectors + strategy
- Applies metadata filters post-fusion
- ORDER BY + LIMIT work correctly

---

## Tasks

### Task 1: TDD — Write NEAR_FUSED execution tests

**Files:** `crates/velesdb-core/src/collection/search/query/near_fused_tests.rs`

**Action:**
1. Create test file with tests for:
   - `test_near_fused_rrf_basic` — 2 vectors, RRF fusion, verify results
   - `test_near_fused_average_strategy` — Average fusion
   - `test_near_fused_maximum_strategy` — Maximum fusion
   - `test_near_fused_weighted_strategy` — Weighted fusion (avg=0.5, max=0.3, hit=0.2)
   - `test_near_fused_with_metadata_filter` — NEAR_FUSED + AND category = 'x'
   - `test_near_fused_with_limit` — Verify LIMIT respected
   - `test_near_fused_single_vector` — Degenerate case: 1 vector
   - `test_near_fused_parameter_resolution` — Vectors from $params
   - `test_near_fused_plus_similarity_is_error` — NEAR_FUSED + similarity() → Error
2. Register test module in `mod.rs`

**Verify:** `cargo test near_fused_tests -- --no-run` (compiles but may fail — RED phase)

**Done:** Test file created, module registered

### Task 2: Extract NEAR_FUSED condition from WHERE clause

**Files:** `crates/velesdb-core/src/collection/search/query/extraction.rs`

**Action:**
1. Add `extract_fused_vector_search()` method to extract `VectorFusedSearch` from condition tree
2. Resolve vector parameters (handle `VectorExpr::Parameter` → lookup in params, `VectorExpr::Literal` → use directly)
3. Map `FusionConfig` → `crate::fusion::FusionStrategy`:
   **IMPORTANT:** `VectorFusedSearch.fusion` is `FusionConfig { strategy: String, params: HashMap<String, f64> }`.
   Match on `fusion.strategy.to_lowercase()` String, NOT on `FusionStrategyType` enum:
   - `"rrf"` → `FusionStrategy::RRF { k }` where k = params.get("k") or 60
   - `"average"` | `"avg"` → `FusionStrategy::Average`
   - `"maximum"` | `"max"` → `FusionStrategy::Maximum`
   - `"weighted"` → `FusionStrategy::weighted(avg, max, hit)?` — extract from params
   - Unknown → `Error::Config("Unknown fusion strategy: '...'. Supported: rrf, average, maximum, weighted")`
4. **SecDev fix:** For "weighted", do NOT call `FusionConfig::weighted()` (it panics on invalid input).
   Instead, extract params manually and call `FusionStrategy::weighted()` which returns `Result<_, FusionError>`.
   Validate: avg_weight, max_weight, hit_weight exist in params, are non-negative, sum to 1.0 — all via Result, never assert.
5. Return `Option<(Vec<Vec<f32>>, FusionStrategy)>` — resolved vectors + strategy

**Verify:** `cargo check --package velesdb-core`

**Done:** Extraction function compiles, handles all FusionConfig variants

### Task 3: Wire NEAR_FUSED into execute_query()

**Files:** `crates/velesdb-core/src/collection/search/query/mod.rs`

**Action:**
1. After existing `vector_search` extraction, add check for `VectorFusedSearch`:
   ```
   let mut fused_search = None;
   if let Some(ref cond) = stmt.where_clause {
       fused_search = self.extract_fused_vector_search(cond, params)?;
   }
   ```
2. Add new match arm in the dispatch block for fused search:
   - `(fused_vectors, fusion_strategy)` → call `self.multi_query_search()`
   - Apply metadata filter from remaining WHERE conditions
   - Apply ORDER BY + LIMIT
3. Handle the case where both NEAR and NEAR_FUSED are present → return error

**Verify:** `cargo test near_fused_tests`

**Done:** All NEAR_FUSED tests pass GREEN

### Task 4: Handle edge cases and error paths

**Files:** `crates/velesdb-core/src/collection/search/query/mod.rs`, `extraction.rs`

**Action:**
1. Empty vector list → clear error message
2. Dimension mismatch between vectors → Error::DimensionMismatch
3. Unknown fusion strategy string → Error::Config with helpful message listing supported strategies
4. Invalid fusion params (e.g. weights don't sum to 1.0) → propagate FusionError (never panic)
   **SecDev:** `FusionConfig::weighted()` uses `assert!` which would CRASH the server.
   Must bypass it and use `FusionStrategy::weighted()` which returns `Result`.
5. NEAR_FUSED + similarity() → **return Error::Config** with clear message
   - Reason: NEAR_FUSED already handles multi-vector fusion; adding similarity()
     threshold filtering on fused scores has undefined semantics in v1
   - Message: "NEAR_FUSED cannot be combined with similarity() — use NEAR for single-vector with threshold"
6. NEAR_FUSED + NEAR in same query → **return Error::Config** (conflicting vector search modes)

**Verify:** `cargo test near_fused_tests && cargo clippy --package velesdb-core -- -D warnings`

**Done:** All edge cases handled, clippy clean

---

## Success Criteria

- [ ] All 9+ tests pass for NEAR_FUSED execution (including Weighted + error cases)
- [ ] `cargo clippy -- -D warnings` clean
- [ ] `cargo test --workspace` passes (no regressions)
- [ ] NEAR_FUSED queries with all 4 fusion strategies work
- [ ] Metadata filters + ORDER BY + LIMIT work with NEAR_FUSED
