---
phase: 4.3
plan: 3
name: "Integrations — Replace NotImplementedError with real delegation"
wave: 2
depends_on: [04.3-01, 04.3-02]
autonomous: true
parallel_safe: true
---

# Phase 4.3 Plan 03: Integrations — Replace NotImplementedError with Delegation

## Objective

Replace `NotImplementedError` guards in LangChain and LlamaIndex integrations with real delegation to the Python SDK's `match_query()` and `explain()` methods (added in Plans 01-02).

## Context

**Requirements addressed:** Single source of truth — integrations must delegate to SDK, not block features
**Why now:** Plans 01-02 add `match_query()` and `explain()` to PyO3's `Collection`. The integrations currently raise:
```python
raise NotImplementedError("EXPLAIN planned for v2.0.")
raise NotImplementedError("MATCH execution engine planned for v2.0.")
```
This is **factually wrong** — both features are fully implemented in core.

**Integration pattern:** `self._collection.match_query(...)` / `self._collection.explain(...)`

## Tasks

### Task 1: Update LangChain tests — expect real results (TDD — RED)

**Files:** `integrations/langchain/tests/test_query_analysis.py`

**Action:**
Replace tests that expect `NotImplementedError` with tests that expect real delegation:

1. **`TestExplain.test_explain_returns_dict`** — Mock `self._collection.explain()` to return a plan dict. Verify `explain()` returns it.
2. **`TestExplain.test_explain_validates_query`** — SecurityError on injection still applies (validation is pre-delegation).
3. **`TestExplain.test_explain_no_collection`** — ValueError when collection not initialized still applies.
4. **`TestExplain.test_explain_with_params`** — Mock `self._collection.explain()` with params.
5. **`TestMatchQuery.test_match_query_returns_query_result`** — Mock `self._collection.match_query()` to return match results. Verify conversion to `Document` list.
6. **`TestMatchQuery.test_match_query_validates_query`** — SecurityError on injection still applies.
7. **`TestMatchQuery.test_match_query_no_collection`** — Empty result when no collection.
8. **`TestMatchQuery.test_match_query_with_params`** — Mock with params.
9. **`TestMatchQuery.test_match_query_empty_results`** — Empty list → empty documents.

Also update `integrations/langchain/tests/test_collection_index.py`:
- `TestNotImplementedMethods` class — Replace `NotImplementedError` expectations with real delegation tests.

**Verify:**
```powershell
cd integrations/langchain; python -m pytest tests/test_query_analysis.py -x --no-header 2>&1 | Select-Object -First 20
```

**Done when:**
- Tests fail (RED) because `explain()` and `match_query()` still raise NotImplementedError

---

### Task 2: Implement LangChain explain() delegation (TDD — GREEN)

**Files:** `integrations/langchain/src/langchain_velesdb/vectorstore.py`

**Action:**
Replace:
```python
def explain(self, query_str: str, params: Optional[dict] = None, **kwargs: Any) -> dict:
    ...
    raise NotImplementedError("EXPLAIN planned for v2.0.")
```

With:
```python
def explain(self, query_str: str, params: Optional[dict] = None, **kwargs: Any) -> dict:
    """Get the query execution plan for a VelesQL query."""
    _validate_query_input(query_str)
    if self._collection is None:
        raise ValueError(_ERR_COLLECTION_NOT_INIT)
    return self._collection.explain(query_str)
```

**Verify:**
```powershell
cd integrations/langchain; python -m pytest tests/test_query_analysis.py::TestExplain -x
```

---

### Task 3: Implement LangChain match_query() delegation (TDD — GREEN)

**Files:** `integrations/langchain/src/langchain_velesdb/vectorstore.py`

**Action:**
Replace:
```python
def match_query(self, query_str: str, params: Optional[dict] = None, **kwargs: Any) -> list[Document]:
    ...
    raise NotImplementedError("MATCH execution engine planned for v2.0.")
```

With delegation that:
1. Validates input with `_validate_query_input(query_str)`
2. Checks collection initialized
3. Calls `self._collection.match_query(query_str, params=params, **kwargs)`
4. Converts results to LangChain `Document` objects:
   - `page_content` = str(projected) or str(bindings)
   - `metadata` = full result dict (node_id, depth, path, bindings, score, projected)

**Verify:**
```powershell
cd integrations/langchain; python -m pytest tests/test_query_analysis.py::TestMatchQuery -x
```

---

### Task 4: Update LlamaIndex tests — expect real results (TDD — RED)

**Files:** `integrations/llamaindex/tests/test_query_analysis.py`, `integrations/llamaindex/tests/test_collection_index.py`

**Action:**
Same pattern as Task 1 but for LlamaIndex:
- Replace `NotImplementedError` expectations with delegation expectations
- Mock `self._collection.explain()` and `self._collection.match_query()`
- `match_query()` returns `VectorStoreQueryResult` (LlamaIndex type) instead of `Document` list

**Verify:**
```powershell
cd integrations/llamaindex; python -m pytest tests/test_query_analysis.py -x --no-header 2>&1 | Select-Object -First 20
```

---

### Task 5: Implement LlamaIndex explain() and match_query() delegation (TDD — GREEN)

**Files:** `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`

**Action:**
Same pattern as Tasks 2-3 but for LlamaIndex:

`explain()`:
```python
def explain(self, query_str: str, params: Optional[dict] = None, **kwargs: Any) -> dict:
    _validate_query_input(query_str)
    if self._collection is None:
        raise ValueError(_ERR_COLLECTION_NOT_INIT)
    return self._collection.explain(query_str)
```

`match_query()`:
```python
def match_query(self, query_str: str, params: Optional[dict] = None, **kwargs: Any) -> VectorStoreQueryResult:
    _validate_query_input(query_str)
    if self._collection is None:
        return VectorStoreQueryResult(nodes=[], similarities=[], ids=[])
    results = self._collection.match_query(query_str, params=params, **kwargs)
    # Convert to VectorStoreQueryResult
    nodes, similarities, ids = [], [], []
    for r in results:
        node = TextNode(text=str(r.get('projected', r.get('bindings', {}))),
                       id_=str(r['node_id']),
                       metadata=r)
        nodes.append(node)
        similarities.append(r.get('score', 0.0) or 0.0)
        ids.append(str(r['node_id']))
    return VectorStoreQueryResult(nodes=nodes, similarities=similarities, ids=ids)
```

**Verify:**
```powershell
cd integrations/llamaindex; python -m pytest tests/test_query_analysis.py -x
```

---

## Verification

After all tasks:

```powershell
cd integrations/langchain; python -m pytest tests/ -x
cd integrations/llamaindex; python -m pytest tests/ -x
```

## Success Criteria

- [x] LangChain `explain()` delegates to `self._collection.explain()`
- [x] LangChain `match_query()` delegates to `self._collection.match_query()` and returns `Document` list
- [x] LlamaIndex `explain()` delegates to `self._collection.explain()`
- [x] LlamaIndex `match_query()` delegates to `self._collection.match_query()` and returns `VectorStoreQueryResult`
- [x] Zero `NotImplementedError` for MATCH or EXPLAIN in integration code
- [x] All integration tests pass
- [x] Security validation (injection protection) preserved
- [x] Collection-not-initialized checks preserved

## Parallel Safety

**Exclusive write files:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py`
- `integrations/langchain/tests/test_query_analysis.py`
- `integrations/langchain/tests/test_collection_index.py`
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`
- `integrations/llamaindex/tests/test_query_analysis.py`
- `integrations/llamaindex/tests/test_collection_index.py`

**No conflicts with Plans 01-02** (different crates/directories)

## Output

**Files modified:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py` — Replace NotImplementedError
- `integrations/langchain/tests/test_query_analysis.py` — Expect real delegation
- `integrations/langchain/tests/test_collection_index.py` — Update NotImplemented tests
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py` — Replace NotImplementedError
- `integrations/llamaindex/tests/test_query_analysis.py` — Expect real delegation
- `integrations/llamaindex/tests/test_collection_index.py` — Update NotImplemented tests
