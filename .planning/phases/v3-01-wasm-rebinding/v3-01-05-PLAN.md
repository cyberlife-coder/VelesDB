---
phase: v3-01
plan: 05
name: Agent + Clippy Cleanup + Equivalence Tests
wave: 5
depends_on: [v3-01-03, v3-01-04]
autonomous: true
parallel_safe: false
---

# Phase v3-01 Plan 05: Agent + Clippy Cleanup + Equivalence Tests

## Objective

Complete the WASM rebinding by addressing the Agent module, removing blanket clippy suppressions (ECO-16), and creating equivalence tests that prove WASM search/graph results are identical to core for the same data. This is the final plan ensuring correctness and code quality.

## Context

**Requirements addressed:** ECO-16 (clippy suppression), ECO-01 (final verification)
**Phase goal contribution:** Quality gate — confirms the rebinding is correct and WASM code quality is restored.

**After Plans 03-04:**
- VectorStore delegates search/filter/fusion/quantization to core
- GraphStore delegates CRUD/traversal to core's InMemoryEdgeStore
- ~1,200+ lines of reimplemented code deleted
- But `agent.rs` still uses the old VectorStore directly
- 16 blanket clippy allows still suppress all quality checks

## Tasks

### Task 1: Assess and Update Agent Module

**Files:** `crates/velesdb-wasm/src/agent.rs`, `crates/velesdb-wasm/src/lib.rs`

**Action:**
The `SemanticMemory` struct (agent.rs, 176 lines) wraps `VectorStore` with a `contents: HashMap<u64, String>` for text storage. It provides:
- `store(id, content, embedding)` — insert vector + save text
- `query(embedding, k)` — search + return text content
- `remove(id)`, `clear()`, `len()`

**Decision tree:**
1. Check if core's `agent` module (behind persistence) has equivalent functionality
2. If YES and it can be extracted to non-persistence: bind to core
3. If NO or extraction is too complex: KEEP `agent.rs` as-is — it's a thin wrapper over VectorStore (which now delegates to core), so it's acceptable. The reimplementation is only the content HashMap, not search logic.

Most likely outcome: **KEEP** agent.rs since it's a thin WASM-specific wrapper (~50 lines of actual logic) that composes VectorStore + text content. The search logic already delegates to core via the VectorStore changes in Plan 03.

If keeping, verify it works correctly with the updated VectorStore API.

**Verify:**
```powershell
cargo check --package velesdb-wasm
cargo test --package velesdb-wasm -- agent
```

**Done when:**
- Agent module assessed and either bound to core or confirmed as acceptable thin wrapper
- Agent works with updated VectorStore
- Decision documented in commit message

---

### Task 2: Remove Blanket Clippy Suppressions (ECO-16)

**Files:** `crates/velesdb-wasm/src/lib.rs`

**Action:**
Replace the 16 blanket `#![allow(...)]` at the top of `lib.rs` with targeted allows only where needed.

**Current suppressions (lib.rs lines 1-16):**
```rust
#![allow(clippy::pedantic)]          // DELETE — enable pedantic
#![allow(clippy::nursery)]           // DELETE — enable nursery
#![allow(clippy::missing_errors_doc)]  // KEEP on individual fns
#![allow(clippy::missing_panics_doc)] // KEEP on individual fns
#![allow(clippy::must_use_candidate)] // KEEP on individual fns
#![allow(clippy::needless_pass_by_value)] // KEEP — wasm_bindgen requires owned JsValue
#![allow(clippy::similar_names)]      // KEEP on individual fns if needed
#![allow(clippy::module_name_repetitions)] // KEEP — WASM module naming style
#![allow(clippy::unused_self)]        // KEEP on individual methods
#![allow(clippy::redundant_closure_for_method_calls)] // DELETE
#![allow(clippy::cast_precision_loss)] // KEEP on individual lines
#![allow(clippy::cast_possible_truncation)] // KEEP on individual lines
#![allow(clippy::cast_sign_loss)]     // KEEP on individual lines
#![allow(clippy::too_many_lines)]     // DELETE — files should be short now
#![allow(clippy::manual_let_else)]    // DELETE
```

**Process:**
1. Remove ALL 16 blanket allows
2. Run `cargo clippy --package velesdb-wasm -- -D warnings`
3. For each warning, choose:
   - **Fix the code** (preferred) — e.g., add return types, fix casts
   - **Add targeted `#[allow]` with `// Reason:` comment** on the specific line/function — for wasm_bindgen FFI boundary issues that can't be fixed
4. Expected wasm_bindgen-necessary allows:
   - `needless_pass_by_value` on functions taking `JsValue` (wasm_bindgen signature requirement)
   - `missing_errors_doc` on `#[wasm_bindgen]` methods (docs go in JS/TS, not Rust)
5. Iterate until `cargo clippy -- -D warnings` passes with zero blanket allows

**Verify:**
```powershell
cargo clippy --package velesdb-wasm -- -D warnings
# Confirm no blanket allows remain
rg "#!\[allow\(clippy::" crates/velesdb-wasm/src/lib.rs
```

**Done when:**
- Zero `#![allow(clippy::...)]` blanket suppressions in lib.rs
- Every remaining `#[allow]` is on a specific item with a `// Reason:` comment
- `cargo clippy -- -D warnings` passes

---

### Task 3: Create Equivalence Tests — WASM Search == Core Search

**Files:** `crates/velesdb-wasm/tests/equivalence_tests.rs` (new), `crates/velesdb-wasm/src/lib_tests.rs`

**Action:**
Create tests that prove WASM produces identical results to core for the same input data. This is the key success criterion for the entire phase.

**Test scenarios:**

1. **Vector search equivalence:**
   ```rust
   // Insert same vectors into WASM VectorStore and core Collection
   // Run same query on both
   // Assert: same IDs returned in same order, scores within epsilon
   ```

2. **Filtered search equivalence:**
   - Same vectors + payloads in both
   - Same JSON filter
   - Assert: identical result sets

3. **Multi-query fusion equivalence:**
   - Same multiple query vectors
   - Same fusion strategy (average, maximum, rrf)
   - Assert: identical fused results

4. **Storage mode equivalence:**
   - Full, SQ8, Binary modes
   - Same data inserted
   - Assert: search results consistent across modes (recall may differ due to quantization, but order should be stable)

5. **Graph traversal equivalence:**
   - Same nodes/edges in WASM GraphStore and core InMemoryEdgeStore
   - Same BFS/DFS queries
   - Assert: identical traversal results (same nodes, same depths)

6. **ECO-06 regression test:**
   - `insert_batch()` with SQ8 mode
   - Verify vectors are actually quantized (not stored as Full)
   - Search still returns correct results

7. **ECO-07 regression test:**
   - `hybrid_search()` with SQ8 mode
   - Verify text component is not silently dropped
   - Either correct hybrid results or explicit error

**Note:** These tests run as native Rust tests (not `wasm-pack test`), comparing WASM types directly against core types. The WASM types work in native Rust too.

**Verify:**
```powershell
cargo test --package velesdb-wasm -- equivalence
cargo test --package velesdb-wasm
```

**Done when:**
- 7+ equivalence test scenarios pass
- ECO-06 and ECO-07 regression tests included
- All existing WASM tests still pass

---

## Verification

After all tasks complete:

```powershell
# Full quality gates
cargo fmt --all --check
cargo clippy --package velesdb-wasm -- -D warnings
cargo test --package velesdb-wasm
cargo test --workspace
cargo deny check
cargo build --release

# Verify no blanket allows
rg "#!\[allow\(clippy::" crates/velesdb-wasm/src/lib.rs | Measure-Object -Line
# Expected: 0 lines

# Verify deleted reimplementations
@("simd.rs", "quantization.rs", "filter.rs", "fusion.rs") | ForEach-Object {
    $path = "crates/velesdb-wasm/src/$_"
    if (Test-Path $path) { Write-Error "FAIL: $_ should be deleted" }
    else { Write-Host "OK: $_ deleted" }
}
```

## Success Criteria

- [ ] Agent module assessed and working with updated VectorStore
- [ ] Zero blanket `#![allow(clippy::...)]` in lib.rs
- [ ] Every targeted `#[allow]` has a `// Reason:` comment
- [ ] `cargo clippy --package velesdb-wasm -- -D warnings` passes
- [ ] 7+ equivalence tests proving WASM == core for identical data
- [ ] ECO-06 regression test: insert_batch respects storage_mode
- [ ] ECO-07 regression test: hybrid_search handles non-Full mode
- [ ] All workspace tests pass
- [ ] All quality gates pass

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-wasm/src/lib.rs` (clippy allows removal)
- `crates/velesdb-wasm/src/agent.rs` (assessment/update)
- `crates/velesdb-wasm/tests/equivalence_tests.rs` (new)
- `crates/velesdb-wasm/src/lib_tests.rs` (potential updates)

**Shared read files:** `crates/velesdb-core/src/`
**Conflicts with:** Plan 03, Plan 04 (shared write on `lib.rs` — sequential wave prevents conflict)

## Output

**Files created:**
- `crates/velesdb-wasm/tests/equivalence_tests.rs` — WASM ↔ Core equivalence tests

**Files modified:**
- `crates/velesdb-wasm/src/lib.rs` — Remove 16 blanket clippy allows, add targeted allows
- `crates/velesdb-wasm/src/agent.rs` — Updated for new VectorStore API (if needed)
- `crates/velesdb-wasm/src/lib_tests.rs` — Updated tests (if needed)
