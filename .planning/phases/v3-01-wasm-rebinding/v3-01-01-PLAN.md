---
phase: v3-01
plan: 01
name: Audit WASM → Core Mapping
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase v3-01 Plan 01: Audit WASM → Core Mapping

## Objective

Map every WASM public function to its velesdb-core equivalent. Identify exact gaps where core needs new non-persistence exports. Produce a definitive mapping document that drives all subsequent plans.

## Context

**Requirements addressed:** ECO-01, ECO-02, ECO-06, ECO-07, ECO-16, ECO-17
**Phase goal contribution:** Foundation — without this mapping, rebinding would miss functions or introduce regressions

## Tasks

### Task 1: Map VectorStore API to Core Equivalents

**Files:** `crates/velesdb-wasm/src/lib.rs`, `crates/velesdb-wasm/src/store_search.rs`, `crates/velesdb-wasm/src/store_insert.rs`, `crates/velesdb-wasm/src/store_get.rs`, `crates/velesdb-wasm/src/store_new.rs`

**Action:**
For every `#[wasm_bindgen]` method on `VectorStore`, document:
- Method signature and behavior
- Core module/function that provides this (or "GAP" if missing)
- Whether the WASM version reimplements or delegates

Expected findings:
- `search()`, `similarity_search()`, `search_with_filter()` → core's `DistanceMetric::calculate()` already used for distance, but scoring loop, sort, and filter are reimplemented
- `insert()`, `insert_batch()` → data layout is WASM-specific (flat Vec, no mmap) — keep layout, fix ECO-06 (insert_batch ignores storage_mode)
- `hybrid_search()` → reimplements text+vector fusion — fix ECO-07 (silently drops text for non-Full)
- `multi_query_search()` → uses own `fusion.rs` — core has `FusionStrategy`
- `export_to_bytes()`, `import_from_bytes()`, `save()`, `load()` → WASM-specific (IndexedDB) — keep

**Verify:**
```powershell
# Count all wasm_bindgen methods
rg "#\[wasm_bindgen" crates/velesdb-wasm/src/ --count
```

**Done when:**
- Every VectorStore public method has a mapping entry
- ECO-06 and ECO-07 gap documented

---

### Task 2: Map GraphStore + Agent API to Core Equivalents

**Files:** `crates/velesdb-wasm/src/graph.rs`, `crates/velesdb-wasm/src/graph_persistence.rs`, `crates/velesdb-wasm/src/graph_worker.rs`, `crates/velesdb-wasm/src/agent.rs`

**Action:**
For every `#[wasm_bindgen]` method on `GraphStore`, `GraphNode`, `GraphEdge`, `SemanticMemory`:
- Map to core equivalent (EdgeStore methods, BFS/DFS iterators)
- Identify that `EdgeStore` is behind `persistence` feature — GAP
- Document that `agent` module is behind `persistence` feature — GAP
- Catalog graph_persistence.rs (IndexedDB) and graph_worker.rs (Web Worker) as WASM-specific (keep)

Key gap: Core's `EdgeStore` and `GraphEdge`/`GraphNode` are in `collection::graph` which requires persistence. Need to extract graph types to a non-persistence module.

**Verify:**
```powershell
rg "#\[wasm_bindgen" crates/velesdb-wasm/src/graph.rs --count
rg "#\[wasm_bindgen" crates/velesdb-wasm/src/agent.rs --count
```

**Done when:**
- Every GraphStore/Agent public method has a mapping entry
- Persistence-gated gaps clearly documented

---

### Task 3: Catalog Reimplemented Modules + Core Availability

**Files:** `crates/velesdb-wasm/src/simd.rs`, `crates/velesdb-wasm/src/filter.rs`, `crates/velesdb-wasm/src/fusion.rs`, `crates/velesdb-wasm/src/quantization.rs`, `crates/velesdb-wasm/src/text_search.rs`, `crates/velesdb-wasm/src/vector_ops.rs`, `crates/velesdb-wasm/src/velesql.rs`

**Action:**
For each internal module, classify as:
- **DELETE**: Full reimplementation of core module → replace with core import
- **KEEP**: WASM-specific functionality (IndexedDB, Web Worker, JsValue conversion)
- **REFACTOR**: Partially delegates but has own logic → simplify to pure delegation

Expected classification:
| WASM Module | Lines | Classification | Core Equivalent | Notes |
|-------------|-------|---------------|-----------------|-------|
| `simd.rs` | 274 | DELETE | `DistanceMetric::calculate()` | `wide` crate, dead code (unused) |
| `vector_ops.rs` | 260 | REFACTOR | `DistanceMetric::calculate()` | Already delegates distance, reimplements loop/sort |
| `quantization.rs` | 148 | DELETE | `velesdb_core::quantization` | Core has SQ8/Binary |
| `filter.rs` | 264 | DELETE | `velesdb_core::filter` | JSON DSL → convert to core's Condition type |
| `fusion.rs` | 145 | DELETE | `velesdb_core::fusion::FusionStrategy` | Direct reimplementation |
| `text_search.rs` | 115 | DELETE | Core text search (if available no-persist) | Substring matching |
| `velesql.rs` | 478 | KEEP | Already binds to core's Parser | ✅ Proper binding |
| `serialization.rs` | ~180 | KEEP | WASM-specific binary format | IndexedDB compat |
| `persistence.rs` | ~130 | KEEP | WASM-specific IndexedDB | Browser storage |
| `parsing.rs` | ~150 | KEEP | WASM-specific helpers | JsValue parsing |

Also verify: Can `wide` crate dependency be removed from Cargo.toml?

**Verify:**
```powershell
# Check if simd.rs functions are called anywhere
rg "simd::" crates/velesdb-wasm/src/ --glob "!simd.rs"
# Check if wide crate is used outside simd.rs
rg "wide::" crates/velesdb-wasm/src/ --glob "!simd.rs"
```

**Done when:**
- Classification table complete for all 21 source files
- DELETE/KEEP/REFACTOR decision for each
- `wide` dependency removal confirmed safe
- Mapping document written to `.planning/phases/v3-01-wasm-rebinding/AUDIT.md`

---

## Verification

After all tasks complete:

```powershell
# Mapping document exists
Test-Path ".planning/phases/v3-01-wasm-rebinding/AUDIT.md"
```

## Success Criteria

- [ ] Every WASM public method mapped to core equivalent or marked as GAP
- [ ] Persistence-gated gaps identified (EdgeStore, agent, text search)
- [ ] DELETE/KEEP/REFACTOR classification for all 21 source files
- [ ] `wide` crate removal confirmed safe
- [ ] Mapping document committed

## Parallel Safety

**Exclusive write files:** `.planning/phases/v3-01-wasm-rebinding/AUDIT.md` (new)
**Shared read files:** All `crates/velesdb-wasm/src/*.rs`, `crates/velesdb-core/src/lib.rs`
**Conflicts with:** none

## Output

**Files created:**
- `.planning/phases/v3-01-wasm-rebinding/AUDIT.md` — Complete mapping document
