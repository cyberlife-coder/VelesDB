---
phase: v3-01
plan: 03
name: WASM VectorStore Rebinding
wave: 3
depends_on: [v3-01-02]
autonomous: true
parallel_safe: false
---

# Phase v3-01 Plan 03: WASM VectorStore Rebinding

## Objective

Replace WASM's reimplemented vector search, filter, fusion, quantization, and text search modules with direct delegation to velesdb-core. Fix ECO-06 (insert_batch ignores storage_mode) and ECO-07 (hybrid_search silently drops text for non-Full). Delete ~1,200 lines of reimplemented code.

## Context

**Requirements addressed:** ECO-01, ECO-06, ECO-07, ECO-17
**Phase goal contribution:** This is the core of the rebinding — VectorStore becomes a thin WASM wrapper over core's algorithms.

**What stays:** VectorStore struct with its in-memory data layout (ids, data buffers, payloads) — WASM can't use mmap, so the data layout is legitimately WASM-specific. Also: serialization.rs, persistence.rs (IndexedDB), velesql.rs, parsing.rs.

**What gets deleted/replaced:**
- `simd.rs` (274L) → DELETE entirely, `wide` crate removed from Cargo.toml
- `vector_ops.rs` (260L) → REFACTOR to thin wrapper using `DistanceMetric::calculate()`
- `quantization.rs` (148L) → DELETE, use `velesdb_core::quantization`
- `filter.rs` (264L) → DELETE, use `velesdb_core::filter::json_to_condition()` from Plan 02
- `fusion.rs` (145L) → DELETE, use `velesdb_core::fusion::FusionStrategy`
- `text_search.rs` (115L) → REFACTOR to use core's text matching if available, or keep as minimal util
- `store_search.rs` (357L) → REFACTOR to delegate to core modules
- `store_insert.rs` (112L) → FIX ECO-06 (respect storage_mode in insert_batch)
- `store_get.rs` (71L) → Keep (thin accessor)
- `store_new.rs` (82L) → Keep (WASM-specific constructors)

## Tasks

### Task 1: Delete simd.rs and Remove `wide` Dependency

**Files:** `crates/velesdb-wasm/src/simd.rs`, `crates/velesdb-wasm/src/lib.rs`, `crates/velesdb-wasm/Cargo.toml`

**Action:**
1. Verify `simd.rs` functions are not called from anywhere (they have `#[allow(dead_code)]`)
2. Delete `simd.rs` file entirely
3. Remove `mod simd;` from `lib.rs`
4. Remove `wide = "0.7"` from `Cargo.toml`

This is the simplest deletion — `simd.rs` is dead code. Core's `DistanceMetric::calculate()` already handles all distance computation via `simd_native` dispatch.

**Verify:**
```powershell
# No references to simd module remain
rg "simd::" crates/velesdb-wasm/src/ --glob "!simd.rs"
rg "mod simd" crates/velesdb-wasm/src/
# Build passes
cargo check --package velesdb-wasm
```

**Done when:**
- `simd.rs` deleted
- `wide` dependency removed
- `cargo check --package velesdb-wasm` passes

---

### Task 2: Replace quantization.rs with Core Imports

**Files:** `crates/velesdb-wasm/src/quantization.rs`, `crates/velesdb-wasm/src/store_insert.rs`, `crates/velesdb-wasm/src/lib.rs`

**Action:**
1. Identify all callers of WASM's `quantization::*` functions
2. Replace with `velesdb_core::quantization::*` equivalents:
   - `compute_sq8_params()` → `velesdb_core::quantization::QuantizedVector::quantize()` or equivalent
   - `quantize_sq8()` → core's SQ8 quantization
   - `dequantize_sq8()` → core's dequantization
   - `pack_binary()` → core's `BinaryQuantizedVector`
3. Delete `quantization.rs`
4. Remove `mod quantization;` from `lib.rs`
5. Update callers in `store_insert.rs` to use core imports

If core's quantization API doesn't exactly match (different struct layout), create thin adapter functions in `store_insert.rs` that call core's math but adapt to WASM's flat buffer layout.

**Verify:**
```powershell
cargo check --package velesdb-wasm
cargo test --package velesdb-wasm
```

**Done when:**
- `quantization.rs` deleted
- All quantization uses core's implementations
- Tests pass

---

### Task 3: Replace filter.rs with Core's json_to_condition

**Files:** `crates/velesdb-wasm/src/filter.rs`, `crates/velesdb-wasm/src/store_search.rs`, `crates/velesdb-wasm/src/lib.rs`

**Action:**
1. Replace WASM's `matches_filter()` with core's `filter::json_to_condition()` + `Filter::matches()`
2. In `store_search.rs`, change `search_with_filter_impl`:
   ```rust
   // Before: crate::filter::matches_filter(payload, &filter_obj)
   // After:
   use velesdb_core::filter::{json_to_condition, Filter};
   let condition = json_to_condition(&filter_obj);
   let filter = condition.map(Filter::new);
   // Then use filter.matches(payload) in the search loop
   ```
3. Delete `filter.rs`
4. Remove `mod filter;` from `lib.rs`

**Verify:**
```powershell
cargo check --package velesdb-wasm
cargo test --package velesdb-wasm
```

**Done when:**
- `filter.rs` deleted
- Filter evaluation delegates to core
- Existing filter tests adapted and pass

---

### Task 4: Replace fusion.rs with Core's FusionStrategy

**Files:** `crates/velesdb-wasm/src/fusion.rs`, `crates/velesdb-wasm/src/store_search.rs`, `crates/velesdb-wasm/src/lib.rs`

**Action:**
1. In `store_search.rs::multi_query_search_impl`, replace `fusion::fuse_results()` with core's `FusionStrategy`:
   ```rust
   use velesdb_core::fusion::FusionStrategy;
   let strategy = match strategy_str {
       "average" | "avg" => FusionStrategy::Average,
       "maximum" | "max" => FusionStrategy::Maximum,
       _ => FusionStrategy::Rrf { k: rrf_k.unwrap_or(60) },
   };
   let fused = strategy.fuse(&all_results);
   ```
2. Delete `fusion.rs`
3. Remove `mod fusion;` from `lib.rs`
4. Update `store_search.rs` imports

**Verify:**
```powershell
cargo check --package velesdb-wasm
cargo test --package velesdb-wasm
```

**Done when:**
- `fusion.rs` deleted
- Multi-query fusion delegates to core's `FusionStrategy`
- Results match previous behavior

---

### Task 5: Simplify vector_ops.rs and Fix ECO-06/ECO-07

**Files:** `crates/velesdb-wasm/src/vector_ops.rs`, `crates/velesdb-wasm/src/store_search.rs`, `crates/velesdb-wasm/src/store_insert.rs`, `crates/velesdb-wasm/src/lib.rs`

**Action:**
1. **Simplify vector_ops.rs**: It already delegates to `metric.calculate()`. Remove `parse_operator()` (dead code). Keep `compute_scores()` and `sort_results()` as thin helpers since they manage the WASM-specific flat buffer layout. Potentially rename to `scoring.rs` for clarity.

2. **Fix ECO-06 (insert_batch ignores storage_mode):**
   In `VectorStore::insert_batch()` (lib.rs line 546-568), currently it always pushes to `self.data` (Full mode only). Fix to respect `self.storage_mode`:
   - For SQ8: quantize vector and push to `data_sq8`, `sq8_mins`, `sq8_scales`
   - For Binary: pack binary and push to `data_binary`
   - Use core's quantization functions (from Task 2)

3. **Fix ECO-07 (hybrid_search drops text for non-Full):**
   In `VectorStore::hybrid_search()` (lib.rs line 329-351), currently returns `self.search(query_vector, k)` for non-Full mode, silently dropping the text query. Fix:
   - For SQ8/Binary: perform vector search with dequantization, then apply text filtering as post-filter
   - Or return an explicit error explaining hybrid search limitation with quantized storage

4. **Simplify text_search.rs**: If core doesn't provide a non-persistence text search utility, keep this as a minimal (~50 line) WASM helper. Otherwise delete and use core's.

**Verify:**
```powershell
cargo check --package velesdb-wasm
cargo test --package velesdb-wasm
# Specific regression tests for ECO-06 and ECO-07
```

**Done when:**
- `insert_batch()` respects storage_mode for SQ8 and Binary
- `hybrid_search()` doesn't silently drop text query
- `vector_ops.rs` simplified to thin scoring helper
- Dead code removed

---

## Verification

After all tasks complete:

```powershell
# Build
cargo check --package velesdb-wasm

# Tests
cargo test --package velesdb-wasm

# Core still passes
cargo test --workspace

# Clippy
cargo clippy --package velesdb-wasm -- -D warnings

# Verify deleted files
# simd.rs, quantization.rs, filter.rs, fusion.rs should not exist
```

## Success Criteria

- [ ] `simd.rs` deleted, `wide` dependency removed
- [ ] `quantization.rs` deleted, uses core's quantization
- [ ] `filter.rs` deleted, uses core's `json_to_condition()`
- [ ] `fusion.rs` deleted, uses core's `FusionStrategy`
- [ ] `vector_ops.rs` simplified to thin scoring helper
- [ ] ECO-06 fixed: `insert_batch()` respects storage_mode
- [ ] ECO-07 fixed: `hybrid_search()` handles non-Full mode correctly
- [ ] `cargo check --package velesdb-wasm` passes
- [ ] All WASM tests pass

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-wasm/src/lib.rs` (mod declarations, VectorStore methods)
- `crates/velesdb-wasm/src/store_search.rs` (search implementations)
- `crates/velesdb-wasm/src/store_insert.rs` (insert_batch fix)
- `crates/velesdb-wasm/src/vector_ops.rs` (simplification)
- `crates/velesdb-wasm/Cargo.toml` (remove `wide`)

**Files deleted:**
- `crates/velesdb-wasm/src/simd.rs`
- `crates/velesdb-wasm/src/quantization.rs`
- `crates/velesdb-wasm/src/filter.rs`
- `crates/velesdb-wasm/src/fusion.rs`

**Shared read files:** `crates/velesdb-core/src/filter/`, `crates/velesdb-core/src/fusion/`, `crates/velesdb-core/src/quantization/`
**Conflicts with:** Plan 04, Plan 05 (all write `velesdb-wasm/src/lib.rs`)

## Output

**Files deleted:**
- `crates/velesdb-wasm/src/simd.rs` — dead SIMD reimplementation
- `crates/velesdb-wasm/src/quantization.rs` — replaced by core
- `crates/velesdb-wasm/src/filter.rs` — replaced by core
- `crates/velesdb-wasm/src/fusion.rs` — replaced by core

**Files modified:**
- `crates/velesdb-wasm/Cargo.toml` — remove `wide` dependency
- `crates/velesdb-wasm/src/lib.rs` — remove mod declarations, fix insert_batch, fix hybrid_search
- `crates/velesdb-wasm/src/store_search.rs` — delegate to core modules
- `crates/velesdb-wasm/src/store_insert.rs` — use core quantization
- `crates/velesdb-wasm/src/vector_ops.rs` — simplify to thin helper
