---
phase: v4-01
plan: 1
name: Wire ORDER BY into MATCH execution pipeline
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase v4-01 Plan 01: Wire ORDER BY into MATCH Execution Pipeline

## Objective

Wire the existing `order_match_results` method into `execute_match` and `execute_match_with_similarity` so that ORDER BY clauses in MATCH queries are actually applied to results. Currently ORDER BY is parsed and stored in `ReturnClause.order_by` but silently ignored during execution.

## Context

**Requirements addressed:** VP-006
**Phase goal contribution:** Completes ORDER BY property path support that was partially implemented (method exists, unit tests pass, but execution pipeline never calls it).

**Root cause:** `execute_match` (3 return paths) and `execute_match_with_similarity` never read `return_clause.order_by`. The `order_match_results` method in `similarity.rs:183-227` is dead code from the pipeline's perspective.

## Tasks

### Task 1: Add `apply_match_order_by` helper to avoid 3x duplication

**Files:** `crates/velesdb-core/src/collection/search/query/match_exec/similarity.rs`

**Action:**
Add a helper method that iterates over `return_clause.order_by` items and calls `order_match_results` for each:

```rust
/// Applies ORDER BY from ReturnClause to match results (VP-006).
pub(crate) fn apply_match_order_by(
    results: &mut Vec<MatchResult>,
    return_clause: &ReturnClause,
) -> Result<()> {
    if let Some(ref order_by_items) = return_clause.order_by {
        // Apply ORDER BY items in reverse (last = primary sort, like SQL)
        for ob in order_by_items.iter().rev() {
            Self::order_match_results(results, &ob.expression, ob.descending)?;
        }
    }
    Ok(())
}
```

**Verify:**
```powershell
cargo check -p velesdb-core
```

**Done when:**
- Helper compiles and is accessible from `mod.rs`

---

### Task 2: Wire ORDER BY into `execute_match` (3 return paths)

**Files:** `crates/velesdb-core/src/collection/search/query/match_exec/mod.rs`

**Action:**
In `execute_match`, apply ORDER BY before returning results in all 3 code paths:
1. **No-relationship path** (line ~166): After aggregation check, before `return Ok(results)`
2. **Multi-hop path** (line ~186): After aggregation check, before `return Ok(results)`
3. **Single-hop path** (line ~253): After aggregation check, before `Ok(results)`

For each path, insert before the final `Ok(results)`:
```rust
// VP-006: Apply ORDER BY if present
Self::apply_match_order_by(&mut results, &match_clause.return_clause)?;
```

Important: ORDER BY must be applied AFTER aggregation check (aggregation changes result set) but BEFORE returning.

**Verify:**
```powershell
cargo test -p velesdb-core --lib -- order_match --nocapture
```

**Done when:**
- Existing `order_match_results` unit tests still pass
- `execute_match` respects ORDER BY from ReturnClause

---

### Task 3: Fix ORDER BY in `execute_match_with_similarity`

**Files:** `crates/velesdb-core/src/collection/search/query/match_exec/similarity.rs`

**Action:**
Currently `execute_match_with_similarity` (lines 160-172) hardcodes a similarity DESC sort regardless of `return_clause.order_by`. Fix logic:

1. If `return_clause.order_by` is `Some` → use `apply_match_order_by` (user's explicit ORDER BY)
2. If `return_clause.order_by` is `None` → keep current default (similarity DESC for similarity queries)

Replace lines 160-172:
```rust
// Apply ORDER BY: explicit clause takes precedence, else default similarity sort
if match_clause.return_clause.order_by.is_some() {
    Self::apply_match_order_by(&mut scored_results, &match_clause.return_clause)?;
} else {
    // Default: sort by similarity score (metric-aware)
    if higher_is_better {
        scored_results.sort_by(|a, b| b.score.unwrap_or(0.0).total_cmp(&a.score.unwrap_or(0.0)));
    } else {
        scored_results.sort_by(|a, b| {
            a.score.unwrap_or(f32::MAX).total_cmp(&b.score.unwrap_or(f32::MAX))
        });
    }
}
```

**Verify:**
```powershell
cargo test --test readme_scenarios hero_query -- --nocapture
cargo test -p velesdb-core --lib -- order_match --nocapture
```

**Done when:**
- Hero query tests still pass (they use ORDER BY similarity() DESC → explicit clause)
- Similarity queries without ORDER BY still sort by similarity DESC (default)

---

### Task 4: Add E2E test for ORDER BY property in MATCH

**Files:** `crates/velesdb-core/tests/readme_scenarios/match_simple.rs`

**Action:**
Add `test_bs4_order_by_timestamp` using the existing BS4 setup:

```rust
#[test]
fn test_bs4_order_by_timestamp() {
    // Use build_match_clause with ORDER BY conv.timestamp DESC
    // Execute and verify results are sorted by timestamp descending
    // Recent convs (1700200000, 1700100000) should appear in that order
}
```

Also update `test_bs4_agent_memory` to include ORDER BY conv.timestamp DESC now that VP-006 is fixed.

**Verify:**
```powershell
cargo test --test readme_scenarios match_simple -- --nocapture
```

**Done when:**
- `test_bs4_order_by_timestamp` passes — results sorted by conv.timestamp DESC
- Existing BS1/BS4 tests unaffected

---

## Verification

After all tasks complete:

```powershell
cargo test -p velesdb-core --lib -- order_match --nocapture
cargo test --test readme_scenarios match_simple -- --nocapture
cargo test --test readme_scenarios hero_query -- --nocapture
cargo clippy -p velesdb-core -- -D warnings
```

## Success Criteria

- [ ] `execute_match` applies ORDER BY from `return_clause.order_by`
- [ ] `execute_match_with_similarity` respects explicit ORDER BY, defaults to similarity sort
- [ ] E2E test `test_bs4_order_by_timestamp` verifies property ORDER BY in multi-hop MATCH
- [ ] Existing hero_query and match_simple tests unaffected
- [ ] Clippy clean

## Parallel Safety

**Exclusive write files:**
- `crates/velesdb-core/src/collection/search/query/match_exec/mod.rs`
- `crates/velesdb-core/src/collection/search/query/match_exec/similarity.rs`
- `crates/velesdb-core/tests/readme_scenarios/match_simple.rs`

**Shared read files:** helpers.rs, graph_pattern.rs, condition.rs
**Conflicts with:** Plan 02 does NOT touch these files → safe to parallel
