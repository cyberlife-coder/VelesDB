---
phase: 4.1
plan: 01
name: Collection & Index Management
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase 4.1 Plan 01: Collection & Index Management

## Objective

Add `list_collections()`, `delete_collection()`, `create_index()`, `list_indexes()`, and `delete_index()` to both LangChain and LlamaIndex vectorstores. These 5 methods cover collection lifecycle and property index management — critical for production agent workflows that need to manage their own storage and optimize query performance.

## Context

**Requirements addressed:** Audit gaps #1-5 (collection mgmt + index mgmt)  
**Phase goal contribution:** 5 of 10 missing features closed. Agents can now manage collections and create indexes to accelerate WHERE filters.

## Tasks

### Task 1: Add 5 methods to LangChain VelesDBVectorStore

**Files:** `integrations/langchain/src/langchain_velesdb/vectorstore.py`

**Action:**
Add these 5 methods to the `VelesDBVectorStore` class, after the existing `is_metadata_only()` method:

1. **`list_collections()`** — Instance method. Delegates to `self._get_db().list_collections()`. Returns `List[dict]`. No validation needed (no user input).

2. **`delete_collection(name)`** — Instance method. Validates `name` with `validate_collection_name()`. Delegates to `self._get_db().delete_collection(name)`. Returns `None`. If deleting the current collection, sets `self._collection = None`.

3. **`create_index(label, property)`** — Instance method. Validates both params with `validate_collection_name()` (same pattern — alphanumeric + underscore). Delegates to `self._collection.create_index(label=label, property=property)`. Returns `dict` (index info). Raises `ValueError` if collection not initialized.

4. **`list_indexes()`** — Instance method. Delegates to `self._collection.list_indexes()`. Returns `List[dict]`. Raises `ValueError` if collection not initialized.

5. **`delete_index(label, property)`** — Instance method. Validates both params. Delegates to `self._collection.delete_index(label=label, property=property)`. Returns `None`. Raises `ValueError` if collection not initialized.

Pattern: follow existing methods like `flush()`, `is_empty()`, `get_collection_info()` for style.

**Verify:**
```bash
cd integrations/langchain && python -c "from langchain_velesdb import VelesDBVectorStore; print([m for m in dir(VelesDBVectorStore) if m in ('list_collections','delete_collection','create_index','list_indexes','delete_index')])"
```

**Done when:**
- All 5 methods exist on VelesDBVectorStore
- Each method has docstring with Args/Returns/Raises
- Security validation on all user-provided string params
- Delegation to velesdb SDK (zero business logic)

---

### Task 2: Add 5 methods to LlamaIndex VelesDBVectorStore

**Files:** `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`

**Action:**
Add the same 5 methods to the LlamaIndex `VelesDBVectorStore` class. Identical logic and validation, but adapted to LlamaIndex patterns:

1. **`list_collections()`** — Same as LangChain. Uses `self._get_db().list_collections()`.
2. **`delete_collection(name)`** — Same. Resets `self._collection = None` if current.
3. **`create_index(label, property)`** — Same delegation.
4. **`list_indexes()`** — Same delegation.
5. **`delete_index(label, property)`** — Same delegation.

Place after `is_metadata_only()`, before `velesql()`.

**Verify:**
```bash
cd integrations/llamaindex && python -c "from llamaindex_velesdb import VelesDBVectorStore; print([m for m in dir(VelesDBVectorStore) if m in ('list_collections','delete_collection','create_index','list_indexes','delete_index')])"
```

**Done when:**
- All 5 methods exist on LlamaIndex VelesDBVectorStore
- Docstrings match LangChain style
- Same validation and delegation pattern

---

### Task 3: Add tests for both integrations

**Files:** `integrations/langchain/tests/test_collection_index.py`, `integrations/llamaindex/tests/test_collection_index.py`

**Action:**
Create new test files (one per integration) with mock-based tests:

**LangChain tests (≥12 tests):**
- `test_list_collections_returns_list` — mock `db.list_collections()` → verify returns list of dicts
- `test_list_collections_empty` — returns `[]` when no collections
- `test_delete_collection_valid` — mock `db.delete_collection()` called with correct name
- `test_delete_collection_resets_current` — if deleting current collection, `_collection` becomes None
- `test_delete_collection_invalid_name` — SecurityError on bad name
- `test_create_index_delegates` — mock `collection.create_index()` called with label+property
- `test_create_index_no_collection` — ValueError when collection not initialized
- `test_create_index_invalid_label` — SecurityError on injection attempt
- `test_list_indexes_delegates` — mock `collection.list_indexes()` returns list
- `test_list_indexes_no_collection` — ValueError when not initialized
- `test_delete_index_delegates` — mock `collection.delete_index()` called correctly
- `test_delete_index_invalid_params` — SecurityError on bad params

**LlamaIndex tests (≥12 tests):** Mirror the LangChain tests with LlamaIndex types.

Use `unittest.mock.patch` / `MagicMock` for all SDK calls. No server dependency.

**Verify:**
```bash
cd integrations/langchain && python -m pytest tests/test_collection_index.py -v
cd integrations/llamaindex && python -m pytest tests/test_collection_index.py -v
```

**Done when:**
- All 24+ tests pass
- No server dependency
- Each method has happy path + error path + security test

---

## Verification

After all tasks complete:

```bash
cd integrations/langchain && python -m pytest tests/ -v --tb=short
cd integrations/llamaindex && python -m pytest tests/ -v --tb=short
```

## Success Criteria

- [ ] `list_collections()` returns `List[dict]` in both integrations
- [ ] `delete_collection(name)` validates name and delegates in both
- [ ] `create_index(label, property)` validates and delegates in both
- [ ] `list_indexes()` returns `List[dict]` in both
- [ ] `delete_index(label, property)` validates and delegates in both
- [ ] 24+ new tests pass (12 per integration)
- [ ] Zero regression on existing tests
- [ ] All inputs validated via `velesdb_common`

## Parallel Safety

**Exclusive write files:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py`
- `integrations/langchain/tests/test_collection_index.py` (new)
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`
- `integrations/llamaindex/tests/test_collection_index.py` (new)

**Shared read files:**
- `integrations/common/src/velesdb_common/security.py` (validators)

**Conflicts with:** Plan 04.1-02, 04.1-03, 04.1-04 all write to the same vectorstore files → **sequential execution required**

## Output

**Files modified:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py` — +5 methods
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py` — +5 methods

**Files created:**
- `integrations/langchain/tests/test_collection_index.py` — 12+ tests
- `integrations/llamaindex/tests/test_collection_index.py` — 12+ tests
