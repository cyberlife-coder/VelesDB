---
phase: 4.1
plan: 02
name: Query Analysis — explain + match_query
wave: 2
depends_on: [04.1-01]
autonomous: true
parallel_safe: false
---

# Phase 4.1 Plan 02: Query Analysis — explain + match_query

## Objective

Add `explain()` and `match_query()` to both LangChain and LlamaIndex vectorstores. `explain()` gives agents observability into query plans. `match_query()` unlocks VelesDB's killer feature — Cypher-like MATCH graph traversal for multi-hop reasoning directly from Python.

## Context

**Requirements addressed:** Audit gaps #6 (explain) and #7 (match_query)  
**Phase goal contribution:** 2 of 10 missing features closed. Agents gain query plan analysis and graph traversal queries — the two most impactful cognitive features.

## Tasks

### Task 1: Add explain() and match_query() to LangChain VelesDBVectorStore

**Files:** `integrations/langchain/src/langchain_velesdb/vectorstore.py`

**Action:**
Add these 2 methods to `VelesDBVectorStore`, after the index management methods added in Plan 01:

1. **`explain(query_str, params=None)`** — Instance method.
   - Validates `query_str` with `validate_query()`.
   - Delegates to `self._collection.explain(query_str, params)`.
   - Returns `dict` (raw query plan with steps, cost, features).
   - Raises `ValueError` if collection not initialized.
   - Raises `SecurityError` if query fails validation.
   - Docstring includes example output structure: `{"steps": [...], "cost": {...}, "features": {...}}`.

2. **`match_query(query_str, params=None)`** — Instance method.
   - Validates `query_str` with `validate_query()`.
   - Delegates to `self._collection.match_query(query_str, params)`.
   - Converts results to `List[Document]` (framework-native).
   - Each result's payload → `Document(page_content=text, metadata={...})`.
   - Raises `ValueError` if collection not initialized.
   - Raises `SecurityError` if query fails validation.
   - Docstring includes MATCH query example:
     ```python
     results = store.match_query(
         "MATCH (a:Person)-[:KNOWS]->(b) RETURN b"
     )
     ```

Pattern: follow existing `query()` method for conversion logic (payload → Document).

**Verify:**
```bash
cd integrations/langchain && python -c "from langchain_velesdb import VelesDBVectorStore; print([m for m in dir(VelesDBVectorStore) if m in ('explain','match_query')])"
```

**Done when:**
- Both methods exist on LangChain VelesDBVectorStore
- `explain()` returns raw dict, `match_query()` returns `List[Document]`
- Both validate query strings via `validate_query()`
- Zero business logic — pure delegation + type conversion

---

### Task 2: Add explain() and match_query() to LlamaIndex VelesDBVectorStore

**Files:** `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`

**Action:**
Add the same 2 methods to the LlamaIndex `VelesDBVectorStore`:

1. **`explain(query_str, params=None)`** — Same as LangChain. Returns `dict`.

2. **`match_query(query_str, params=None)`** — Same delegation but returns `VectorStoreQueryResult` (LlamaIndex native).
   - Each result → `TextNode(text=text, id_=node_id, metadata={...})`.
   - Similarities list populated from result scores.
   - IDs list populated from node_id fields.
   - Pattern: follow existing `velesql()` method for conversion.

Place after `velesql()` method.

**Verify:**
```bash
cd integrations/llamaindex && python -c "from llamaindex_velesdb import VelesDBVectorStore; print([m for m in dir(VelesDBVectorStore) if m in ('explain','match_query')])"
```

**Done when:**
- Both methods exist on LlamaIndex VelesDBVectorStore
- `explain()` returns `dict`, `match_query()` returns `VectorStoreQueryResult`
- Same validation and delegation pattern

---

### Task 3: Add tests for both integrations

**Files:** `integrations/langchain/tests/test_query_analysis.py`, `integrations/llamaindex/tests/test_query_analysis.py`

**Action:**
Create new test files with mock-based tests:

**LangChain tests (≥8 tests):**
- `test_explain_returns_dict` — mock `collection.explain()` → verify dict returned
- `test_explain_validates_query` — SecurityError on SQL injection
- `test_explain_no_collection` — ValueError when not initialized
- `test_explain_with_params` — params dict passed through correctly
- `test_match_query_returns_documents` — mock `collection.match_query()` → verify `List[Document]`
- `test_match_query_validates_query` — SecurityError on malicious input
- `test_match_query_no_collection` — ValueError when not initialized
- `test_match_query_converts_payload` — verify payload → Document conversion (text + metadata)

**LlamaIndex tests (≥8 tests):** Mirror with LlamaIndex types:
- `match_query` returns `VectorStoreQueryResult` with `TextNode` objects
- Verify similarities and IDs lists populated correctly

Mock data should look like:
```python
# explain() mock return
{"steps": [{"type": "scan", "collection": "docs"}], "cost": {"estimated_rows": 100}, "features": {"similarity": True}}

# match_query() mock return
[{"id": 1, "payload": {"text": "Alice knows Bob", "node_id": "1", "label": "Person"}, "score": 0.95}]
```

**Verify:**
```bash
cd integrations/langchain && python -m pytest tests/test_query_analysis.py -v
cd integrations/llamaindex && python -m pytest tests/test_query_analysis.py -v
```

**Done when:**
- All 16+ tests pass
- No server dependency
- Each method has happy path + error path + security test

---

## Verification

After all tasks complete:

```bash
cd integrations/langchain && python -m pytest tests/ -v --tb=short
cd integrations/llamaindex && python -m pytest tests/ -v --tb=short
```

## Success Criteria

- [ ] `explain()` returns `dict` (raw plan) in both integrations
- [ ] `match_query()` returns `List[Document]` in LangChain
- [ ] `match_query()` returns `VectorStoreQueryResult` in LlamaIndex
- [ ] Both methods validate query strings via `validate_query()`
- [ ] 16+ new tests pass (8 per integration)
- [ ] Zero regression on existing tests + Plan 01 tests
- [ ] MATCH queries with injection attempts are rejected

## Parallel Safety

**Exclusive write files:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py`
- `integrations/langchain/tests/test_query_analysis.py` (new)
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py`
- `integrations/llamaindex/tests/test_query_analysis.py` (new)

**Shared read files:**
- `integrations/common/src/velesdb_common/security.py` (validators)

**Conflicts with:** Plans 04.1-01, 04.1-03, 04.1-04 write to same vectorstore files → **sequential after Plan 01**

## Output

**Files modified:**
- `integrations/langchain/src/langchain_velesdb/vectorstore.py` — +2 methods (explain, match_query)
- `integrations/llamaindex/src/llamaindex_velesdb/vectorstore.py` — +2 methods (explain, match_query)

**Files created:**
- `integrations/langchain/tests/test_query_analysis.py` — 8+ tests
- `integrations/llamaindex/tests/test_query_analysis.py` — 8+ tests
