---
phase: 02-unsafe-code-audit-testing-foundation
plan: 05
type: execute
wave: 1
depends_on: ["02-04"]
files_modified:
  - crates/velesdb-core/src/perf_optimizations.rs
  - crates/velesdb-core/src/simd_neon_prefetch.rs
  - crates/velesdb-core/src/storage/mmap.rs
  - crates/velesdb-core/src/index/hnsw/index/mod.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 14 unsafe sites across 4 files pass strict SAFETY template verification"
    - "SAFETY comments follow AGENTS template: header + condition bullets + Reason line"
    - "Verification script reports 0 violations for all 4 gap-closure files"
  artifacts:
    - path: "crates/velesdb-core/src/perf_optimizations.rs"
      provides: "7 unsafe sites with template-complete SAFETY documentation"
      contains: ["// Reason:", "// - Condition:"]
    - path: "crates/velesdb-core/src/simd_neon_prefetch.rs"
      provides: "3 unsafe sites with template-complete SAFETY documentation"
      contains: ["// Reason:", "// - Condition:"]
    - path: "crates/velesdb-core/src/storage/mmap.rs"
      provides: "3 unsafe sites with template-complete SAFETY documentation"
      contains: ["// Reason:", "// - Condition:"]
    - path: "crates/velesdb-core/src/index/hnsw/index/mod.rs"
      provides: "1 unsafe site with template-complete SAFETY documentation"
      contains: ["// Reason:", "// - Condition:"]
  key_links:
    - from: "scripts/verify_unsafe_safety_template.py"
      to: "all 4 gap-closure files"
      via: "python scripts/verify_unsafe_safety_template.py --files ... --strict"
      pattern: "PASSED: All unsafe blocks have complete SAFETY documentation"
---

<objective>
Normalize SAFETY comment format in 4 remaining files to pass strict AGENTS template verification. The files already have SAFETY headers but lack the complete template format (condition bullets + Reason line).

Purpose: Complete RUST-04 compliance by ensuring all unsafe code has machine-verifiable SAFETY documentation.
Output: 14 unsafe sites with template-complete SAFETY comments that pass `verify_unsafe_safety_template.py --strict`
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-04-SUMMARY.md
@scripts/verify_unsafe_safety_template.py

## Gap Closure Background

From 02-unsafe-code-audit-testing-foundation-VERIFICATION.md:
- 02-04 successfully closed gaps in simd_native.rs, vector_store.rs, vacuum.rs
- Re-verification discovered 4 additional files with partial SAFETY documentation
- These files have SAFETY headers but missing condition bullet format and Reason lines

## Files Requiring Format Normalization

### 1. perf_optimizations.rs (7 unsafe sites)
- Line ~100: `alloc()` - needs Reason line + condition bullet format
- Line ~185: `copy_nonoverlapping()` in insert_at - needs Reason line + condition bullet format
- Line ~243: `slice::from_raw_parts()` in get - needs Reason line + condition bullet format
- Line ~266: `slice::from_raw_parts()` in get_unchecked - needs Reason line + condition bullet format
- Line ~277: `data.as_ptr().add()` in prefetch - needs Reason line + condition bullet format
- Line ~285: `_mm_prefetch()` - needs Reason line + condition bullet format
- Line ~353: `dealloc()` in resize - needs Reason line + condition bullet format
- Line ~401: `dealloc()` in Drop - needs Reason line + condition bullet format

**Note:** Lines 60 and 65 (Send/Sync impls) already have complete template format.

### 2. simd_neon_prefetch.rs (3 unsafe sites)
- Line ~42: `prefetch_read_l1()` asm block - needs Reason line
- Lines ~136, ~144: pointer arithmetic in prefetch_vector_neon - need full SAFETY template

### 3. storage/mmap.rs (3 unsafe sites)
- Line ~117: `MmapMut::map_mut()` in new() - needs Reason line + condition bullet format
- Line ~206: `MmapMut::map_mut()` in ensure_capacity - needs Reason line + condition bullet format

### 4. index/hnsw/index/mod.rs (1 unsafe site)
- Line ~147: `ManuallyDrop::drop()` in Drop impl - needs Reason line + condition bullet format

## Required Template Format

```rust
// SAFETY: [Brief summary of invariant]
// - Condition 1: [Specific condition]
// - Condition 2: [Specific condition]
// Reason: [Why unsafe is necessary]
unsafe { ... }
```

The verifier script checks for:
1. `// SAFETY:` header (case insensitive)
2. `// - Condition:` or `// * Condition:` bullets
3. `// Reason:` line
</context>

<tasks>

<task type="auto">
  <name>Task 1: Normalize SAFETY template in perf_optimizations.rs (7 sites)</name>
  <files>crates/velesdb-core/src/perf_optimizations.rs</files>
  <action>
Update 7 unsafe blocks to use strict AGENTS template format (header + condition bullets + Reason line).

Sites to update:
1. Line ~100: `alloc()` call in `ContiguousVectors::new()`
   - Keep: `// SAFETY: alloc requires a valid non-zero layout.`
   - Change: Convert "Condition 1:" and "Condition 2:" to "// - Condition 1:" and "// - Condition 2:"
   - Add: `// Reason: Manual allocation is required for aligned contiguous SIMD-friendly storage.`

2. Line ~185: `copy_nonoverlapping()` in `insert_at()`
   - Keep: `// SAFETY: We ensured capacity covers index, data is non-null (NonNull invariant)`
   - Add: `// - Condition 1: Capacity was verified to cover the target index.`
   - Add: `// - Condition 2: Both source and destination pointers are valid and properly aligned.`
   - Add: `// Reason: Efficient bulk memory copy for vector insertion.`

3. Line ~243: `slice::from_raw_parts()` in `get()`
   - Keep: `// SAFETY: Index is within bounds (checked against count, which is <= capacity)`
   - Add: `// - Condition 1: index < count ensures access is within initialized range.`
   - Add: `// - Condition 2: data is non-null per NonNull invariant.`
   - Add: `// Reason: Zero-copy slice creation from contiguous storage.`

4. Line ~266: `slice::from_raw_parts()` in `get_unchecked()`
   - Keep: `// SAFETY: Caller guarantees index < count, data is non-null (NonNull invariant)`
   - Add: `// - Condition 1: Caller contract ensures index < count.`
   - Add: `// - Condition 2: data is non-null per NonNull invariant.`
   - Add: `// Reason: Performance-critical path requiring unchecked access.`

5. Line ~277: `data.as_ptr().add()` in `prefetch()`
   - Keep: `// SAFETY: index < count implies valid offset, data is non-null (NonNull invariant)`
   - Add: `// - Condition 1: Bounds check ensures offset is within allocated range.`
   - Add: `// - Condition 2: NonNull guarantees pointer is valid.`
   - Add: `// Reason: Prefetch hint requires pointer to target cache line.`

6. Line ~285: `_mm_prefetch()` in `prefetch()`
   - Keep: `// SAFETY: _mm_prefetch is a hint instruction that cannot cause undefined behavior.`
   - Add: `// - Condition 1: The pointer is valid (derived from data.as_ptr() with bounds-checked offset).`
   - Add: `// - Condition 2: Prefetch hints are architecturally safe even on invalid addresses.`
   - Add: `// Reason: CPU cache warming for upcoming vector access.`

7. Line ~353: `dealloc()` in `resize()`
   - Keep: `// SAFETY: self.data was allocated with old_layout, is non-null (NonNull invariant)`
   - Add: `// - Condition 1: old_layout matches the allocation parameters.`
   - Add: `// - Condition 2: Pointer is non-null per NonNull invariant.`
   - Add: `// Reason: Free old buffer after data migration to new buffer.`

8. Line ~401: `dealloc()` in `Drop`
   - Keep: `// SAFETY: data was allocated with this layout, is non-null (NonNull invariant)`
   - Add: `// - Condition 1: Layout matches original allocation parameters.`
   - Add: `// - Condition 2: Pointer is non-null per NonNull invariant.`
   - Add: `// Reason: Release allocated memory when ContiguousVectors is dropped.`

Ensure each SAFETY block follows exact format:
- Single line with `// SAFETY:` (capitalized)
- One or more lines with `// - Condition N:` (numbered bullets)
- Single line with `// Reason:` (capitalized R)
- Then the `unsafe { ... }` block

DO NOT modify the Send/Sync impls at lines 60 and 65 - they already have correct format.
  </action>
  <verify>
python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/perf_optimizations.rs --strict
  </verify>
  <done>Script reports "PASSED: All unsafe blocks have complete SAFETY documentation" with 0 violations for perf_optimizations.rs</done>
</task>

<task type="auto">
  <name>Task 2: Normalize SAFETY template in simd_neon_prefetch.rs (3 sites)</name>
  <files>crates/velesdb-core/src/simd_neon_prefetch.rs</files>
  <action>
Update 3 unsafe blocks to use strict AGENTS template format.

Sites to update:
1. Line ~42: `prefetch_read_l1()` asm block
   - Current: Has SAFETY header but no Reason line, uses plain text conditions
   - Update to:
   ```rust
   // SAFETY: `asm!(prfm ...)` emits a prefetch hint only.
   // - Condition 1: `prfm` does not dereference memory architecturally.
   // - Condition 2: Invalid pointers are tolerated by hardware for prefetch hints.
   // Reason: Stable Rust lacks a fully-stable aarch64 prefetch intrinsic.
   unsafe { ... }
   ```

2. Lines ~136: pointer arithmetic in `prefetch_vector_neon()`
   - Current: Has SAFETY comment but no header
   - Update to:
   ```rust
   // SAFETY: Pointer arithmetic stays within `vector` bounds.
   // - Condition 1: This branch only runs when at least one full extra cache line exists (>64 bytes).
   // - Condition 2: The offset is exactly one cache line (64 bytes) from the start.
   // Reason: Prefetch second cache line for large vectors.
   let ptr = unsafe { (vector.as_ptr() as *const u8).add(cache_line_size) };
   ```

3. Lines ~144: pointer arithmetic in `prefetch_vector_neon()`
   - Current: Has SAFETY comment but no header
   - Update to:
   ```rust
   // SAFETY: Pointer arithmetic stays within `vector` bounds.
   // - Condition 1: This branch only runs when at least two full extra cache lines exist (>128 bytes).
   // - Condition 2: The offset is exactly two cache lines (128 bytes) from the start.
   // Reason: Prefetch third cache line for very large vectors.
   let ptr = unsafe { (vector.as_ptr() as *const u8).add(cache_line_size * 2) };
   ```

DO NOT modify prefetch_read_l2, prefetch_read_l3, or prefetch_write_l1 - they already have correct format.
  </action>
  <verify>
python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/simd_neon_prefetch.rs --strict
  </verify>
  <done>Script reports "PASSED: All unsafe blocks have complete SAFETY documentation" with 0 violations for simd_neon_prefetch.rs</done>
</task>

<task type="auto">
  <name>Task 3: Normalize SAFETY template in storage/mmap.rs (3 sites)</name>
  <files>crates/velesdb-core/src/storage/mmap.rs</files>
  <action>
Update 3 unsafe blocks to use strict AGENTS template format.

Sites to update:
1. Line ~117: `MmapMut::map_mut()` in `new()`
   - Current: Has SAFETY header but no Reason line, uses plain text conditions
   - Update to:
   ```rust
   // SAFETY: data_file is a valid, open file with set_len() called to ensure
   // the mapping range is fully allocated.
   // - Condition 1: File was opened with read+write permissions.
   // - Condition 2: set_len() was called to ensure the file has INITIAL_SIZE bytes.
   // - Condition 3: MmapMut requires readable and writable file, guaranteed by OpenOptions.
   // Reason: Memory mapping requires unsafe due to potential for undefined behavior if file is truncated externally.
   let mmap = unsafe { MmapMut::map_mut(&data_file)? };
   ```

2. Line ~206: `MmapMut::map_mut()` in `ensure_capacity()`
   - Current: Has SAFETY header but no Reason line, uses plain text conditions
   - Update to:
   ```rust
   // SAFETY: data_file has been resized with set_len(new_len) above,
   // ensuring the new mapping range is fully allocated.
   // - Condition 1: File was resized to new_len before remapping.
   // - Condition 2: Old mmap is dropped when we assign the new one.
   // - Condition 3: File remains open with read+write permissions.
   // Reason: Memory mapping requires unsafe; resizing ensures mapping doesn't exceed file bounds.
   *mmap = unsafe { MmapMut::map_mut(&self.data_file)? };
   ```

3. Line ~400: `mmap.as_ptr().add().cast()` in `retrieve_ref()`
   - Current: Has SAFETY header but uses different format (EPIC-032/US-001 style)
   - Update to AGENTS template:
   ```rust
   // SAFETY: We've validated that offset + vector_size <= mmap.len(), offset is 4-byte aligned,
   // and the pointer is derived from the mmap which is held by the guard.
   // - Condition 1: Bounds check passed (offset + vector_size <= mmap.len()).
   // - Condition 2: Alignment verified (offset % 4 == 0).
   // - Condition 3: Pointer derived from valid mmap held by VectorSliceGuard.
   // - Condition 4: All writes via store() use f32-aligned offsets.
   // Reason: Zero-copy vector access via memory mapping requires raw pointer operations.
   #[allow(clippy::cast_ptr_alignment)]
   let ptr = unsafe { mmap.as_ptr().add(offset).cast::<f32>() };
   ```

Remove or convert the P2 Audit comment line if it conflicts with template format.
  </action>
  <verify>
python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/storage/mmap.rs --strict
  </verify>
  <done>Script reports "PASSED: All unsafe blocks have complete SAFETY documentation" with 0 violations for storage/mmap.rs</done>
</task>

<task type="auto">
  <name>Task 4: Normalize SAFETY template in index/hnsw/index/mod.rs (1 site)</name>
  <files>crates/velesdb-core/src/index/hnsw/index/mod.rs</files>
  <action>
Update 1 unsafe block to use strict AGENTS template format.

Site to update:
1. Lines ~135-148: `ManuallyDrop::drop()` in `Drop` impl
   - Current: Has SAFETY header but uses plain text explanation, no condition bullets or Reason line
   - Update to:
   ```rust
   // SAFETY: We must drop inner BEFORE io_holder because inner (HnswInner)
   // borrows from io_holder. ManuallyDrop lets us control this order.
   // - Condition 1: inner is wrapped in ManuallyDrop to prevent automatic drop.
   // - Condition 2: We acquire a write lock before dropping to ensure exclusive access.
   // - Condition 3: ManuallyDrop::drop is only called once in this Drop impl.
   // - Condition 4: For loaded indices, io_holder outlives inner; for new indices, io_holder is None.
   // Reason: Self-referential struct pattern requires manual drop order control to prevent use-after-free.
   unsafe {
       ManuallyDrop::drop(&mut *self.inner.write());
   }
   ```

Remove the second SAFETY comment block (lines 144-145) as it's redundant. Keep only one comprehensive SAFETY block before the unsafe statement.
  </action>
  <verify>
python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/index/hnsw/index/mod.rs --strict
  </verify>
  <done>Script reports "PASSED: All unsafe blocks have complete SAFETY documentation" with 0 violations for index/hnsw/index/mod.rs</done>
</task>

<task type="auto">
  <name>Task 5: Run full verification and quality gates</name>
  <files>
    - crates/velesdb-core/src/perf_optimizations.rs
    - crates/velesdb-core/src/simd_neon_prefetch.rs
    - crates/velesdb-core/src/storage/mmap.rs
    - crates/velesdb-core/src/index/hnsw/index/mod.rs
  </files>
  <action>
Run comprehensive verification to confirm all 14 unsafe sites pass strict template checks.

1. Verify all 4 files together:
   ```bash
   python scripts/verify_unsafe_safety_template.py \
     --files crates/velesdb-core/src/perf_optimizations.rs \
             crates/velesdb-core/src/simd_neon_prefetch.rs \
             crates/velesdb-core/src/storage/mmap.rs \
             crates/velesdb-core/src/index/hnsw/index/mod.rs \
     --strict
   ```

2. Run quality gates:
   ```bash
   cargo fmt --all --check
   cargo clippy -p velesdb-core -- -D warnings
   cargo test -p velesdb-core --lib
   ```

3. Update inventory evidence (if applicable):
   - Add verification results to 02-unsafe-audit-inventory.md
   - Document that all 15 inventory files now pass strict verification
  </action>
  <verify>
python scripts/verify_unsafe_safety_template.py \
  --files crates/velesdb-core/src/perf_optimizations.rs \
          crates/velesdb-core/src/simd_neon_prefetch.rs \
          crates/velesdb-core/src/storage/mmap.rs \
          crates/velesdb-core/src/index/hnsw/index/mod.rs \
  --strict
cargo fmt --all --check
cargo clippy -p velesdb-core -- -D warnings
  </verify>
  <done>
All verification passes:
- Script reports 0 violations for all 4 files
- cargo fmt passes
- cargo clippy passes with 0 warnings
  </done>
</task>

</tasks>

<verification>
### Deterministic Re-verification

After completing all tasks, run:

```bash
# Verify gap-closure files
python scripts/verify_unsafe_safety_template.py \
  --files crates/velesdb-core/src/perf_optimizations.rs \
          crates/velesdb-core/src/simd_neon_prefetch.rs \
          crates/velesdb-core/src/storage/mmap.rs \
          crates/velesdb-core/src/index/hnsw/index/mod.rs \
  --strict

# Expected output:
# ========================================
# Files checked: 4
# Files with violations: 0
# Total violations: 0
#
# PASSED: All unsafe blocks have complete SAFETY documentation
```

### Quality Gates

- [ ] `cargo fmt --all --check`: pass
- [ ] `cargo clippy -p velesdb-core -- -D warnings`: pass
- [ ] `cargo test -p velesdb-core --lib`: all pass
</verification>

<success_criteria>
- All 14 unsafe sites across 4 files pass strict SAFETY template verification
- Each SAFETY comment includes: header line, condition bullets (// - Condition:), Reason line (// Reason:)
- Verification script reports 0 violations
- All quality gates pass (fmt, clippy, tests)
- No functional code changes - documentation-only modifications
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-05-SUMMARY.md`

The SUMMARY should document:
- 14 unsafe sites normalized across 4 files
- All sites now pass strict AGENTS template verification
- Quality gate results
- Phase 02 RUST-04 requirement is fully satisfied
</output>
