---
phase: 02-unsafe-code-audit-testing-foundation
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - crates/velesdb-core/tests/simd_property_tests.rs
  - crates/velesdb-core/src/simd_native_tests.rs
autonomous: true
must_haves:
  truths:
    - "SIMD distance operations are property-tested against scalar references over varied dimensions and values"
    - "Float comparisons use explicit tolerance policy, avoiding flaky architecture-specific failures"
    - "Property-test failures produce reproducible counterexamples for debugging"
  artifacts:
    - path: "crates/velesdb-core/tests/simd_property_tests.rs"
      provides: "proptest-based SIMD vs scalar equivalence suite"
      min_lines: 180
    - path: "crates/velesdb-core/src/simd_native_tests.rs"
      provides: "Module-level hookup or helper exports needed by property tests"
  key_links:
    - from: "crates/velesdb-core/tests/simd_property_tests.rs"
      to: "crates/velesdb-core/src/simd_native.rs"
      via: "dot/squared_l2/cosine/hamming/jaccard public entrypoints"
      pattern: "dot_product_native|squared_l2_native|cosine_similarity_native|hamming_distance_native|jaccard_similarity_native"
    - from: "crates/velesdb-core/tests/simd_property_tests.rs"
      to: "scalar reference implementations"
      via: "property assertions with absolute/relative tolerance policy"
      pattern: "prop_assert!"
---

<objective>
Establish property-based SIMD correctness verification as the testing foundation for later refactors.

Purpose: Fulfill TEST-01 by proving SIMD outputs stay equivalent to scalar references across broad randomized input space.
Output: New proptest suite with explicit tolerance matrix and reproducible execution settings.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-RESEARCH.md
@crates/velesdb-core/src/simd_native.rs
@crates/velesdb-core/src/simd_native_tests.rs
@crates/velesdb-core/tests/recall_validation.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SIMD property test suite with scalar references</name>
  <files>
    crates/velesdb-core/tests/simd_property_tests.rs
  </files>
  <action>
    Create `simd_property_tests.rs` using `proptest` to compare SIMD-backed public functions against scalar references.

    Cover at minimum:
    - `dot_product_native`
    - `squared_l2_native` (and/or `euclidean_native` via sqrt relation)
    - `cosine_similarity_native` with clamp-aware assertions
    - `hamming_distance_native`
    - `jaccard_similarity_native`

    Include dimensions that stress tails and boundary behavior (0/1/small/non-SIMD-width/large).
    Use bounded input ranges and operation-specific tolerance checks (absolute + relative where needed).
  </action>
  <verify>cargo test -p velesdb-core --test simd_property_tests -- --nocapture</verify>
  <done>Property tests run successfully and validate SIMD equivalence against scalar references for all targeted metrics.</done>
</task>

<task type="auto">
  <name>Task 2: Encode reproducibility and non-flaky tolerance policy</name>
  <files>
    crates/velesdb-core/tests/simd_property_tests.rs
    crates/velesdb-core/src/simd_native_tests.rs
  </files>
  <action>
    Define a clear tolerance matrix in test code (per metric) and configure proptest cases to balance signal and runtime.

    Add deterministic/reproducible settings already aligned with repo patterns (`ProptestConfig`, explicit case counts), and document constraints when architecture-level floating-point differences cannot be eliminated.

    If helper exposure is needed for test ergonomics, make minimal changes in `simd_native_tests.rs` only.
  </action>
  <verify>cargo test -p velesdb-core --test simd_property_tests && cargo test -p velesdb-core simd_native_tests</verify>
  <done>Property suite is stable across repeated local runs and documents tolerance rationale for non-bit-exact operations.</done>
</task>

<task type="auto">
  <name>Task 3: Run phase-level validation commands for SIMD test foundation</name>
  <files>
    crates/velesdb-core/tests/simd_property_tests.rs
  </files>
  <action>
    Execute the quality checks required for this plan after property tests are in place.
  </action>
  <verify>cargo fmt --all --check && cargo clippy -p velesdb-core -- -D warnings && cargo test -p velesdb-core --test simd_property_tests</verify>
  <done>Formatting, linting, and SIMD property tests pass with no warnings/errors.</done>
</task>

</tasks>

<verification>
Run `cargo test -p velesdb-core --test simd_property_tests -- --nocapture`, then `cargo clippy -p velesdb-core -- -D warnings`, then `cargo fmt --all --check`.
Verify tests include randomized dimensions and explicit tolerances for float operations.
</verification>

<success_criteria>
TEST-01 is satisfied with reproducible property-based SIMD equivalence checks and clear tolerance policies suitable for cross-architecture CI.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-03-SUMMARY.md`
</output>
