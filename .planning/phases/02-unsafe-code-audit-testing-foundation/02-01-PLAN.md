---
phase: 02-unsafe-code-audit-testing-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/simd_neon.rs
  - crates/velesdb-core/src/storage/guard.rs
autonomous: true
must_haves:
  truths:
    - "Every explicit unsafe block and unsafe impl in SIMD and guard modules is auditable with full SAFETY template comments"
    - "Existing clear SAFETY comments remain stable; only weak or inaccurate comments are changed"
    - "Public return-value-significant APIs in audited files emit compiler warnings when results are ignored"
  artifacts:
    - path: "crates/velesdb-core/src/simd_native.rs"
      provides: "Centralized invariant documentation and per-block SAFETY references for repeated unsafe SIMD patterns"
    - path: "crates/velesdb-core/src/simd_neon.rs"
      provides: "Template-complete SAFETY comments for NEON unsafe dispatch calls"
    - path: "crates/velesdb-core/src/storage/guard.rs"
      provides: "Template-complete SAFETY comments for unsafe impl Send/Sync and from_raw_parts usage"
    - path: "crates/velesdb-core/src/simd_native.rs"
      provides: "#[must_use] annotations on return-value-critical public APIs"
  key_links:
    - from: "crates/velesdb-core/src/simd_native.rs"
      to: "unsafe { ... } callsites"
      via: "shared invariant section + per-block SAFETY references"
      pattern: "SAFETY:.*Reason:"
    - from: "crates/velesdb-core/src/storage/guard.rs"
      to: "unsafe impl Send/Sync"
      via: "explicit invariants tied to epoch and aliasing guarantees"
      pattern: "unsafe impl (Send|Sync).*SAFETY"
---

<objective>
Audit and harden unsafe usage in SIMD and storage guard code so each unsafe operation is reviewable and justified.

Purpose: Satisfy RUST-04/RUST-05 and BUG-02 foundations by making unsafe invariants explicit without unnecessary churn.
Output: Updated SIMD/guard source files with full-template SAFETY docs, selective comment fixes, and targeted #[must_use] annotations.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-RESEARCH.md
@.planning/phases/01-foundation-fixes/01-05-SUMMARY.md
@crates/velesdb-core/src/simd_native.rs
@crates/velesdb-core/src/simd_neon.rs
@crates/velesdb-core/src/storage/guard.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build unsafe inventory and apply template-complete SAFETY docs</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/simd_neon.rs
    crates/velesdb-core/src/storage/guard.rs
  </files>
  <action>
    Audit every explicit `unsafe {}` and `unsafe impl` in the three target files and ensure each has a full template comment:
    - `// SAFETY: ...`
    - `// - Condition ...`
    - `// Reason: ...`

    Honor locked decisions exactly:
    - Do not churn clear existing SAFETY comments for style-only differences.
    - Only rewrite weak, ambiguous, or behavior-mismatched comments.
    - For repeated SIMD unsafe patterns, add one shared invariant section near the relevant helper/region and reference it at callsites with concise per-block conditions.
    - Where assumptions cannot be directly proven in code/tests, document explicit constraints and rationale.

    Keep unsafe scopes unchanged unless a minimal narrowing is needed to make invariant boundaries clearer.
  </action>
  <verify>rg -n "unsafe\\s*\\{|unsafe impl" crates/velesdb-core/src/simd_native.rs crates/velesdb-core/src/simd_neon.rs crates/velesdb-core/src/storage/guard.rs && rg -n "SAFETY:|Reason:" crates/velesdb-core/src/simd_native.rs crates/velesdb-core/src/simd_neon.rs crates/velesdb-core/src/storage/guard.rs</verify>
  <done>Every explicit unsafe block and unsafe impl in the audited files has template-complete SAFETY documentation, with no stylistic-only churn of already clear comments.</done>
</task>

<task type="auto">
  <name>Task 2: Apply targeted #[must_use] and fix inaccurate nearby comments</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/simd_neon.rs
    crates/velesdb-core/src/storage/guard.rs
  </files>
  <action>
    Apply `#[must_use]` to public functions in these files where ignored return values indicate bugs (RUST-05), and avoid side-effect-only APIs.

    While editing, resolve BUG-02 scope in these files by correcting only comments that are inaccurate or misleading relative to code behavior.
    - Keep accurate comments untouched.
    - If evidence for a claim is indirect, adjust wording to factual constraints instead of certainty statements.
  </action>
  <verify>cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Return-value-critical APIs in audited files are covered by #[must_use], and all edited comments in those files are behavior-accurate.</done>
</task>

<task type="auto">
  <name>Task 3: Run focused regression checks for audited modules</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/simd_neon.rs
    crates/velesdb-core/src/storage/guard.rs
  </files>
  <action>
    Execute focused checks to validate no regressions from safety-documentation and attribute updates:
    1) SIMD unit tests
    2) storage guard tests
    3) crate lint gate
  </action>
  <verify>cargo test -p velesdb-core simd_native_tests && cargo test -p velesdb-core storage::tests && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Focused tests and clippy pass, confirming documentation/annotation changes are non-breaking.</done>
</task>

</tasks>

<verification>
Run `cargo test -p velesdb-core simd_native_tests`, `cargo test -p velesdb-core storage::tests`, and `cargo clippy -p velesdb-core -- -D warnings`.
Confirm every explicit unsafe site in the three files has the full SAFETY template and that only unclear/incorrect comments changed.
</verification>

<success_criteria>
RUST-04 coverage is complete for target SIMD/guard files, RUST-05 is applied where ignoring return values is a bug, and BUG-02 fixes are limited to objectively inaccurate comments.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-01-SUMMARY.md`
</output>
