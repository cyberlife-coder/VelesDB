---
phase: 02-unsafe-code-audit-testing-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/simd_neon.rs
  - crates/velesdb-core/src/storage/guard.rs
  - crates/velesdb-core/src/alloc_guard.rs
  - crates/velesdb-core/src/perf_optimizations.rs
  - crates/velesdb-core/src/simd_neon_prefetch.rs
  - crates/velesdb-core/src/storage/compaction.rs
  - crates/velesdb-core/src/storage/mmap.rs
  - crates/velesdb-core/src/storage/vector_bytes.rs
  - crates/velesdb-core/src/collection/graph/memory_pool.rs
  - crates/velesdb-core/src/index/trigram/simd.rs
  - crates/velesdb-core/src/index/hnsw/index/mod.rs
  - crates/velesdb-core/src/index/hnsw/index/vacuum.rs
  - crates/velesdb-core/src/index/hnsw/vector_store.rs
  - crates/velesdb-core/src/index/hnsw/native_inner.rs
autonomous: true
must_haves:
  truths:
    - "Every explicit unsafe block and unsafe impl in `crates/velesdb-core/src` non-test modules is inventoried and either template-complete or fixed in this phase"
    - "Existing clear SAFETY comments remain stable; only weak or inaccurate comments are changed"
    - "Public return-value-significant APIs across unsafe-bearing audited modules emit compiler warnings when results are ignored"
    - "BUG-02 scope is explicit and verifiable: only unsafe-adjacent and invariant comments inside the declared inventory boundary are edited"
  artifacts:
    - path: ".planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md"
      provides: "Unsafe and #[must_use] closure ledger with per-file site counts, statuses, and completion evidence"
    - path: "crates/velesdb-core/src/simd_native.rs"
      provides: "Centralized invariant documentation and per-block SAFETY references for repeated unsafe SIMD patterns"
    - path: "crates/velesdb-core/src/simd_neon.rs"
      provides: "Template-complete SAFETY comments for NEON unsafe dispatch calls"
    - path: "crates/velesdb-core/src/storage/guard.rs"
      provides: "Template-complete SAFETY comments for unsafe impl Send/Sync and from_raw_parts usage"
  key_links:
    - from: ".planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md"
      to: "crates/velesdb-core/src/**/*.rs (non-test files with unsafe sites)"
      via: "per-file unsafe count + status rows"
      pattern: "file: .*\\nunsafe_sites: .*\\nsafety_status: .*\\nmust_use_status: .*"
    - from: "crates/velesdb-core/src/simd_native.rs"
      to: "unsafe { ... } callsites"
      via: "shared invariant section + per-block SAFETY references"
      pattern: "SAFETY:.*Reason:"
---

<objective>
Audit and harden unsafe usage with closure evidence across all in-scope core modules, not just the original three files.

Purpose: Fully satisfy RUST-04 and RUST-05 while making BUG-02 comment-audit scope explicit and measurable.
Output: Inventory-led unsafe/must_use audit plus targeted source updates using full SAFETY template with minimal churn.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-RESEARCH.md
@.planning/phases/01-foundation-fixes/01-05-SUMMARY.md
@crates/velesdb-core/src/simd_native.rs
@crates/velesdb-core/src/simd_neon.rs
@crates/velesdb-core/src/storage/guard.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build explicit unsafe + comment-audit inventory boundary</name>
  <files>
    .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
  </files>
  <action>
    Create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md` as the closure ledger.

    Declare BUG-02 scope boundary explicitly:
    - In scope: every non-test file under `crates/velesdb-core/src` containing `unsafe {}`, `unsafe impl`, or `unsafe fn`.
    - Out of scope in this plan: parser files (`velesql/parser/*`, handled in Plan 02-02), test-only files, and prose/docs.

    For each in-scope file, record:
    - `file:` path
    - `unsafe_sites:` count
    - `safety_status:` `covered|needs_fix|fixed`
    - `must_use_status:` `not_needed|needs_add|added`
    - `comment_audit_status:` `accurate|corrected`

    This inventory is mandatory proof for RUST-04/RUST-05 closure beyond the original three files.
  </action>
  <verify>rg -n -e "unsafe\s*\{" -e "unsafe impl" -e "unsafe fn" crates/velesdb-core/src && rg -n "^file: |unsafe_sites:|safety_status:|must_use_status:|comment_audit_status:" .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md</verify>
  <done>The inventory exists, includes every in-scope unsafe-bearing non-test source file, and states explicit in-scope/out-of-scope BUG-02 boundary.</done>
</task>

<task type="auto">
  <name>Task 2: Close SAFETY-template coverage from inventory findings</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/simd_neon.rs
    crates/velesdb-core/src/storage/guard.rs
    crates/velesdb-core/src/alloc_guard.rs
    crates/velesdb-core/src/perf_optimizations.rs
    crates/velesdb-core/src/simd_neon_prefetch.rs
    crates/velesdb-core/src/storage/compaction.rs
    crates/velesdb-core/src/storage/mmap.rs
    crates/velesdb-core/src/storage/vector_bytes.rs
    crates/velesdb-core/src/collection/graph/memory_pool.rs
    crates/velesdb-core/src/index/trigram/simd.rs
    crates/velesdb-core/src/index/hnsw/index/mod.rs
    crates/velesdb-core/src/index/hnsw/index/vacuum.rs
    crates/velesdb-core/src/index/hnsw/vector_store.rs
    crates/velesdb-core/src/index/hnsw/native_inner.rs
    .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
  </files>
  <action>
    For each `safety_status: needs_fix` entry, update only weak/unclear comments to full SAFETY template:
    - `// SAFETY: ...`
    - `// - Condition ...`
    - `// Reason: ...`

    Honor locked decisions:
    - Keep clear existing SAFETY comments unchanged.
    - Rewrite only unclear/inaccurate comments.
    - Prefer one centralized invariant section plus per-block references for repeated SIMD patterns.
    - Prefer evidence-backed assumptions; otherwise document explicit constraints.

    Keep unsafe scopes unchanged unless minimal narrowing is required for invariant clarity. Update inventory statuses as items are closed.
  </action>
  <verify>! rg -n "safety_status:\s*needs_fix" .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md</verify>
  <done>No inventory rows remain with `safety_status: needs_fix`, and all edited unsafe sites use the full SAFETY template without style-only churn.</done>
</task>

<task type="auto">
  <name>Task 3: Complete broad #[must_use] audit and quality closure</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/simd_neon.rs
    crates/velesdb-core/src/storage/guard.rs
    crates/velesdb-core/src/alloc_guard.rs
    crates/velesdb-core/src/perf_optimizations.rs
    crates/velesdb-core/src/simd_neon_prefetch.rs
    crates/velesdb-core/src/storage/compaction.rs
    crates/velesdb-core/src/storage/mmap.rs
    crates/velesdb-core/src/storage/vector_bytes.rs
    crates/velesdb-core/src/collection/graph/memory_pool.rs
    crates/velesdb-core/src/index/trigram/simd.rs
    crates/velesdb-core/src/index/hnsw/index/mod.rs
    crates/velesdb-core/src/index/hnsw/index/vacuum.rs
    crates/velesdb-core/src/index/hnsw/vector_store.rs
    crates/velesdb-core/src/index/hnsw/native_inner.rs
    .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
  </files>
  <action>
    Apply `#[must_use]` to public/pubrestricted functions where ignoring the return value indicates a bug, across all inventory files.

    Do not annotate side-effect-only APIs. Record each file as `must_use_status: added` or `must_use_status: not_needed` in the inventory with a short rationale.

    Enforce BUG-02 boundary from Task 1: do not expand comment rewrites beyond unsafe-adjacent/invariant comments.
  </action>
  <verify>! rg -n "must_use_status:\s*needs_add" .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md && cargo test -p velesdb-core simd_native_tests && cargo test -p velesdb-core storage::tests && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>RUST-05 coverage is closed across inventory files, and focused tests/lints pass after unsafe + must_use changes.</done>
</task>

</tasks>

<verification>
Run `cargo test -p velesdb-core simd_native_tests`, `cargo test -p velesdb-core storage::tests`, and `cargo clippy -p velesdb-core -- -D warnings`.
Confirm `.planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md` has no `needs_fix`/`needs_add` statuses and contains explicit BUG-02 scope boundaries.
</verification>

<success_criteria>
RUST-04 and RUST-05 are closed for all in-scope non-test unsafe-bearing core modules (beyond the original three files), and BUG-02 fixes are scope-bounded with audit evidence.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-01-SUMMARY.md`
</output>
