---
phase: 02-unsafe-code-audit-testing-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/velesql/parser/select.rs
  - crates/velesdb-core/src/velesql/parser/values.rs
  - crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
autonomous: true
must_haves:
  truths:
    - "Known BUG markers in parser code are resolved into stable behavior with regression coverage"
    - "Parser comments describe current behavior/invariants, not stale bug history"
    - "Phase 2 parser changes preserve zero-breaking-change behavior while reducing fragility"
  artifacts:
    - path: "crates/velesdb-core/src/velesql/parser/select.rs"
      provides: "Fragility fixes for aggregate/HAVING parsing points previously marked BUG"
    - path: "crates/velesdb-core/src/velesql/parser/values.rs"
      provides: "Stable correlation extraction logic and corrected comments"
    - path: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      provides: "Regression tests for BUG-marker scenarios"
  key_links:
    - from: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      to: "crates/velesdb-core/src/velesql/parser/select.rs"
      via: "Parser::parse regression assertions for aggregate/HAVING behavior"
      pattern: "Parser::parse"
    - from: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      to: "crates/velesdb-core/src/velesql/parser/values.rs"
      via: "correlation extraction behavior assertions"
      pattern: "correlat|subquery"
---

<objective>
Stabilize VelesQL parser fragility points and retire BUG-marker debt with executable regression tests.

Purpose: Deliver BUG-03 and parser-side BUG-02 by replacing fragile/comment-driven behavior with clear invariants and tests.
Output: Parser fixes in select/values modules and updated regression tests that lock the intended behavior.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-RESEARCH.md
@crates/velesdb-core/src/velesql/parser/select.rs
@crates/velesdb-core/src/velesql/parser/values.rs
@crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace BUG-marker fragility with stable parser logic</name>
  <files>
    crates/velesdb-core/src/velesql/parser/select.rs
    crates/velesdb-core/src/velesql/parser/values.rs
  </files>
  <action>
    Resolve the known BUG-marker sites in `select.rs` and `values.rs` with permanent code-level handling.
    - Keep semantics backward compatible.
    - Prefer minimal logic changes that remove fragile branching and implicit assumptions.
    - At each edited location, ensure behavior can be validated by tests instead of comment claims.

    Convert stale `BUG-* FIX` comments into concise behavior/invariant comments where needed.
  </action>
  <verify>rg -n "BUG-" crates/velesdb-core/src/velesql/parser/select.rs crates/velesdb-core/src/velesql/parser/values.rs</verify>
  <done>BUG-marker locations in select/values are implemented as stable logic and no longer rely on historical bug comments to explain correctness.</done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests covering fixed parser fragility cases</name>
  <files>
    crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
  </files>
  <action>
    Add or extend parser regression tests for each fixed fragility scenario:
    - aggregate/star handling constraints (e.g., COUNT(*) vs others)
    - HAVING logical operator capture behavior
    - correlated-subquery field extraction and deduplication behavior

    Keep tests deterministic and explicit about expected parse success/failure and extracted AST behavior.
  </action>
  <verify>cargo test -p velesdb-core pr_review_bugfix_tests -- --nocapture</verify>
  <done>Each previous BUG-marker scenario has an automated regression test that fails if fragility regresses.</done>
</task>

<task type="auto">
  <name>Task 3: Validate parser module quality gates</name>
  <files>
    crates/velesdb-core/src/velesql/parser/select.rs
    crates/velesdb-core/src/velesql/parser/values.rs
    crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
  </files>
  <action>
    Run parser-focused and lint validation to confirm fixes are stable and warning-free.
  </action>
  <verify>cargo test -p velesdb-core parser:: && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Parser tests pass and clippy reports zero warnings for velesdb-core after parser changes.</done>
</task>

</tasks>

<verification>
Run `cargo test -p velesdb-core pr_review_bugfix_tests -- --nocapture`, `cargo test -p velesdb-core parser::`, and `cargo clippy -p velesdb-core -- -D warnings`.
Confirm known BUG marker behavior is covered by tests and comments describe current behavior.
</verification>

<success_criteria>
BUG-03 is closed for the documented parser hotspots, BUG-02 parser comments are accurate, and parser regressions are locked by tests.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-02-SUMMARY.md`
</output>
