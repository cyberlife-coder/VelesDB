---
phase: 4
plan: 3
name: "Module Split — collection/graph (6 files)"
wave: 2
depends_on: []
autonomous: true
---

# Phase 4 Plan 03: Module Split — collection/graph

## Objective

Split the 6 oversized files in `collection/graph/` into focused submodules. These files share the graph domain but are internally independent — each can be split without affecting the others.

## Targets

| File | Lines | Split Strategy |
|------|------:|---------------|
| `property_index.rs` | 1106 | index ops, range queries, iteration, serialization |
| `cart.rs` | 918 | tree structure, insert/delete, traversal, rebalancing |
| `memory_pool.rs` | 598 | allocation, deallocation, compaction, stats |
| `degree_router.rs` | 551 | routing logic, statistics, cache management |
| `metrics.rs` | 542 | metric definitions, computation, aggregation |
| `edge_concurrent.rs` | 511 | shard management, concurrent read/write ops |

**Total: 4226 lines → target ~12 submodules, all <500 lines**

## Tasks

### Task 1: Split `property_index.rs` (1106 lines)

Convert to `property_index/` directory module:
- `mod.rs` — `PropertyIndex` struct definition + facade re-exports
- `ops.rs` — insert, delete, update operations
- `query.rs` — range queries, exact match, prefix search
- `iter.rs` — iteration and serialization

### Task 2: Split `cart.rs` (918 lines)

Convert to `cart/` directory module:
- `mod.rs` — `CARTree` struct + facade
- `build.rs` — tree construction and rebalancing
- `search.rs` — traversal and nearest-neighbor search
- `node.rs` — node types, splitting logic

### Task 3: Split `memory_pool.rs` (598 lines)

Convert to `memory_pool/` directory module:
- `mod.rs` — `MemoryPool` struct + facade
- `allocator.rs` — allocation and deallocation logic
- `compaction.rs` — pool compaction and defragmentation

### Task 4: Split `degree_router.rs` (551 lines)

Convert to `degree_router/` directory module:
- `mod.rs` — `DegreeRouter` struct + facade
- `routing.rs` — routing decision logic
- `stats.rs` — statistics tracking and cache

### Task 5: Split `metrics.rs` (542 lines)

Convert to `graph_metrics/` or split within existing directory:
- `mod.rs` or `metrics/mod.rs` — facade
- `metrics/computation.rs` — metric calculation logic
- `metrics/types.rs` — metric type definitions

### Task 6: Split `edge_concurrent.rs` (511 lines)

Convert to `edge_concurrent/` directory module:
- `mod.rs` — `ConcurrentEdgeStore` struct + facade
- `shard.rs` — shard management and distribution
- `ops.rs` — concurrent read/write operations

## Pattern (same for all splits)

```rust
// mod.rs — Facade pattern
mod ops;
mod query;

pub use ops::{insert, delete};
pub use query::{range_query, exact_match};

pub struct PropertyIndex { /* ... */ }
```

## Verification

Per task:
```powershell
cargo check --workspace
cargo test -p velesdb-core graph
```

Final:
```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] 6 files converted to directory modules
- [ ] All submodules <500 lines
- [ ] Zero public API changes (re-exports preserve paths)
- [ ] All graph tests pass
- [ ] All workspace tests pass
