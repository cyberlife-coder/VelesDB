---
phase: 4
plan: 3
name: GPU Error Handling Tests
wave: 2
depends_on: ["04-01"]
autonomous: true
---

# Phase 4 Plan 03: GPU Error Handling Tests

## Objective

Add comprehensive tests verifying graceful degradation when GPU is unavailable or operations fail. Currently, all GPU tests only cover happy paths (GPU present → compute → verify results). This plan ensures no panics occur on GPU errors and that the fallback to CPU SIMD is seamless.

## Context

**Requirements addressed:** TEST-03
**Phase goal contribution:** Satisfies "GPU resilience" success criterion — tests verify graceful handling when GPU is unavailable or operations fail; no panics on GPU errors.
**Dependency:** Plan 04-01 must be completed first (GPU functions return Result instead of panicking).

## Tasks

### Task 1: Test GPU unavailability graceful fallback

**Files:** `crates/velesdb-core/src/gpu_tests.rs`

**Action:**
Add tests verifying the system behaves correctly when GPU is not available:

1. **`test_compute_backend_fallback_to_simd`** — Verify `ComputeBackend::best_available()` returns `Simd` when no GPU is present (this partially exists but needs strengthening)

2. **`test_gpu_accelerator_none_without_gpu`** — On systems without GPU, verify `GpuAccelerator::new()` returns `None` gracefully (no panic, no hang)

3. **`test_gpu_available_false_consistent`** — Call `is_available()` multiple times, verify it's consistent and cached (no repeated adapter probing)

These tests should work on CI environments without GPU by using `#[cfg(not(feature = "gpu"))]` guards for compile-time tests, and runtime `if gpu.is_none()` guards for feature-gated tests.

**Verify:**
```powershell
cargo test -p velesdb-core gpu
```

**Done when:**
- Tests verify GPU unavailability is handled gracefully
- No panics or hangs when GPU is absent
- Tests pass on both GPU and non-GPU systems

---

### Task 2: Test GPU parameter validation errors

**Files:** `crates/velesdb-core/src/gpu/gpu_backend_tests.rs`

**Action:**
Add tests for the error paths introduced in Plan 04-01 (parameter validation now returns Result):

1. **`test_batch_cosine_zero_dimension`** — Verify `batch_cosine_similarity(&vectors, &query, 0)` returns empty vec (not error — this is an early return)

2. **`test_batch_cosine_dimension_mismatch`** — Verify mismatched query/vector dimensions are handled (query dim ≠ declared dimension)

3. **`test_batch_euclidean_empty_vectors`** — Verify empty vector input returns empty results

4. **`test_batch_dot_product_single_element`** — Verify edge case with dimension=1

5. **`test_batch_cosine_large_batch`** — Verify large batch (1000+ vectors) processes correctly or returns appropriate error

All tests must use `#[serial(gpu)]` attribute to avoid GPU resource contention.

**Verify:**
```powershell
cargo test -p velesdb-core gpu_backend_tests
```

**Done when:**
- Parameter edge cases tested
- Error paths verified (no panics)
- All tests pass with and without GPU feature

---

### Task 3: Test GPU map-async failure handling

**Files:** `crates/velesdb-core/src/gpu/gpu_backend_tests.rs`

**Action:**
Test the GPU buffer read-back failure path. After Plan 04-01, the map-async failure in `batch_cosine_similarity` (line 290) should return an error instead of silent zero vectors.

1. **`test_batch_cosine_result_readback`** — On GPU systems, verify successful readback produces valid results (regression test for the Result conversion)

2. **`test_gpu_operations_no_panic_on_any_input`** — Fuzz-like test: feed various edge-case inputs (empty, single, very large dimension, NaN, Inf) and verify no panics occur

```rust
#[test]
#[serial(gpu)]
fn test_gpu_operations_no_panic_on_any_input() {
    if let Some(gpu) = GpuAccelerator::new() {
        let edge_cases: Vec<(Vec<f32>, Vec<f32>, usize)> = vec![
            (vec![], vec![], 0),
            (vec![1.0], vec![1.0], 1),
            (vec![f32::NAN], vec![1.0], 1),
            (vec![f32::INFINITY], vec![1.0], 1),
            (vec![0.0; 1024], vec![0.0; 1024], 1024),
        ];
        for (vectors, query, dim) in edge_cases {
            // Should not panic — may return error or empty
            let _ = gpu.batch_cosine_similarity(&vectors, &query, dim);
            let _ = gpu.batch_euclidean_distance(&vectors, &query, dim);
            let _ = gpu.batch_dot_product(&vectors, &query, dim);
        }
    }
}
```

**Verify:**
```powershell
cargo test -p velesdb-core gpu -- --include-ignored
```

**Done when:**
- No panics on any edge-case GPU input
- Error paths return proper Result or empty vec
- All GPU tests pass

---

## Verification

After all tasks complete:

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] GPU unavailability tested — graceful fallback to SIMD verified
- [ ] Parameter validation errors tested — no panics on invalid inputs
- [ ] Map-async failure path tested — error instead of silent zeros
- [ ] Edge-case inputs (NaN, Inf, empty, zero-dim) tested — no panics
- [ ] All tests pass on both GPU and non-GPU environments
- [ ] All workspace quality gates pass

## Output

**Files modified:**
- `gpu_tests.rs` — new fallback/availability tests
- `gpu/gpu_backend_tests.rs` — new error path and edge-case tests
