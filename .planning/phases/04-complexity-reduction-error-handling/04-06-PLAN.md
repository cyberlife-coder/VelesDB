---
phase: 4
plan: 6
name: "Module Split — velesql + column_store + query_cost (4 files)"
wave: 2
depends_on: []
autonomous: true
---

# Phase 4 Plan 06: Module Split — velesql + column_store + query_cost

## Objective

Split the 4 remaining oversized files in the SQL/data layer into focused submodules. These files handle VelesQL validation, query explanation, column storage, and query cost estimation.

## Targets

| File | Lines | Split Strategy |
|------|------:|---------------|
| `velesql/validation.rs` | 638 | type validation, semantic checks, constraint validation |
| `column_store/mod.rs` | 618 | schema definition, CRUD operations, filtering |
| `velesql/explain.rs` | 564 | plan generation, cost estimation, output formatting |
| `collection/query_cost/plan_generator.rs` | 514 | plan enumeration, cost model application, plan selection |

**Total: 2334 lines → target ~10 submodules, all <500 lines**

## Tasks

### Task 1: Split `velesql/validation.rs` (638 lines)

Convert to `validation/` directory module:
- `mod.rs` — `Validator` struct + facade
- `types.rs` — type checking and coercion rules
- `semantic.rs` — semantic validation (table/column existence, scope)
- `constraints.rs` — constraint validation (NOT NULL, UNIQUE, CHECK)

### Task 2: Split `column_store/mod.rs` (618 lines)

`column_store` is already a directory. Extract logic from `mod.rs`:
- Keep `mod.rs` as facade (<200 lines) — struct definition + re-exports
- `schema.rs` — schema definition, `with_primary_key`, field management
- `ops.rs` — CRUD operations (insert, update, delete, get)
- `filter.rs` already exists — verify it handles all filtering

**Note:** `with_primary_key` panic removal is handled in Plan 04-01. This plan only moves code, doesn't change signatures.

### Task 3: Split `velesql/explain.rs` (564 lines)

Convert to `explain/` directory module:
- `mod.rs` — `ExplainPlan` struct + facade
- `generator.rs` — plan tree generation from AST
- `formatter.rs` — human-readable output formatting (EXPLAIN output)

### Task 4: Split `collection/query_cost/plan_generator.rs` (514 lines)

Convert to `plan_generator/` directory module:
- `mod.rs` — `PlanGenerator` struct + facade
- `enumeration.rs` — plan enumeration and candidate generation
- `selection.rs` — cost-based plan selection and pruning

## Verification

```powershell
cargo check --workspace
cargo test -p velesdb-core velesql
cargo test -p velesdb-core column_store
cargo test -p velesdb-core query_cost
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] 4 files converted to directory modules or reduced below 500 lines
- [ ] All submodules <500 lines
- [ ] Zero public API changes
- [ ] All VelesQL, column_store, and query_cost tests pass
- [ ] All workspace tests pass
