---
phase: 4
plan: 2
name: Complexity Reduction & Naming Clarity
wave: 1
depends_on: none
autonomous: true
---

# Phase 4 Plan 02: Complexity Reduction & Naming Clarity

## Objective

Reduce cognitive complexity of all functions below the 25-threshold configured in `.clippy.toml`, and audit public API naming for clarity. Currently 1 function exceeds the threshold: `dot_product_avx2_4acc` at 37/25.

## Context

**Requirements addressed:** QUAL-03, QUAL-04
**Phase goal contribution:** Satisfies "complexity compliance", "clear naming", and "clippy clean" success criteria.

## Tasks

### Task 1: Reduce cognitive complexity of `dot_product_avx2_4acc`

**Files:** `crates/velesdb-core/src/simd_native/x86_avx2.rs`

**Action:**
The function `dot_product_avx2_4acc` (line 38) has cognitive complexity 37/25 due to deeply nested remainder handling with 3 levels of if/else for 16/8/scalar tail processing.

Strategy: Extract the remainder handling into a dedicated helper function `process_avx2_dot_remainder`:

```rust
/// Processes remainder elements (0-31) after the main 4-acc SIMD loop.
///
/// # Safety
/// Same requirements as `dot_product_avx2_4acc`.
#[cfg(target_arch = "x86_64")]
#[target_feature(enable = "avx2", enable = "fma")]
#[inline]
unsafe fn process_avx2_dot_remainder(a: &[f32], b: &[f32], base: usize, remainder: usize) -> f32 {
    // Move the 16/8/scalar cascade here
}
```

Then call it from the main function:
```rust
let base = simd_len * 32;
let remainder = len - base;
if remainder > 0 {
    result += process_avx2_dot_remainder(a, b, base, remainder);
}
```

Key constraints:
- The helper must also have `#[target_feature(enable = "avx2", enable = "fma")]` since it uses AVX2 intrinsics
- The helper must be `#[inline]` to avoid call overhead in hot path
- Keep the macro calls `sum_remainder_unrolled_8!` inside the helper
- Do NOT refactor the main 4-acc loop — only the remainder cascade

**Verify:**
```powershell
cargo clippy -p velesdb-core -- -W clippy::cognitive_complexity 2>&1 | Select-String "cognitive"
```

Expected: No cognitive complexity warnings.

```powershell
cargo test -p velesdb-core simd_native
```

Expected: All 90 SIMD tests pass (no regression).

**Done when:**
- `cargo clippy -- -W clippy::cognitive_complexity` reports 0 violations
- All SIMD tests pass unchanged
- Function behavior is identical (same numerical results)

---

### Task 2: Audit and improve naming clarity in public APIs

**Files:** Multiple files in `crates/velesdb-core/src/`

**Action:**
Audit public function names and parameters for clarity. The roadmap calls out: "abbreviated variable names expanded, unclear function names clarified."

Based on codebase scan, the naming is generally good. Focus areas:

1. **Check public API exports in `lib.rs`** — verify all exported names are clear and self-documenting
2. **Audit `column_store/mod.rs` public methods** — ensure method names describe intent
3. **Audit `storage/mmap.rs` public methods** — verify parameter names are descriptive
4. **Audit `gpu.rs` / `gpu_backend.rs`** — verify GPU API naming

Specific patterns to fix if found:
- `calc_*` → `calculate_*`
- `proc_*` → `process_*`
- Single-letter params in public functions (except `a`, `b` for vectors which is idiomatic)
- Unclear return semantics in function names

**Important constraints:**
- Do NOT rename private/internal SIMD variables (`va0`, `vb0`, `acc0`) — these follow SIMD naming conventions
- Do NOT rename `ctx` in `CompactionContext` usage — `ctx` for context is standard Rust idiom
- Only rename if the new name is meaningfully clearer, not just longer
- Any public API rename is a BREAKING CHANGE — document if found, but prefer adding doc aliases over renaming

**Verify:**
```powershell
cargo doc -p velesdb-core --no-deps 2>&1 | Select-String "warning"
```

**Done when:**
- Public API names audited and documented
- Any unclear names clarified (via rename or doc alias)
- No breaking API changes introduced

---

### Task 3: Verify zero clippy cognitive complexity violations

**Files:** All `crates/velesdb-core/src/*.rs`

**Action:**
Run the final clippy cognitive complexity check to confirm compliance:

```powershell
cargo clippy -p velesdb-core -- -W clippy::cognitive_complexity
```

If any additional violations are found beyond `dot_product_avx2_4acc` (which should have been fixed in Task 1), apply the same extraction pattern: move complex branches into helper functions.

Also verify that the `.clippy.toml` threshold of 25 is respected:
```toml
cognitive-complexity-threshold = 25
```

**Verify:**
```powershell
cargo clippy --workspace -- -D warnings -W clippy::cognitive_complexity
```

**Done when:**
- Zero cognitive complexity warnings across workspace
- All quality gates pass

---

## Verification

After all tasks complete:

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings -W clippy::cognitive_complexity
cargo test --workspace
```

## Success Criteria

- [ ] `dot_product_avx2_4acc` complexity reduced below 25
- [ ] Zero cognitive complexity violations in workspace
- [ ] Public API naming audited — no unclear abbreviations in public signatures
- [ ] All SIMD tests pass (no numerical regression)
- [ ] All workspace tests pass
- [ ] No breaking API changes

## Output

**Files modified:**
- `simd_native/x86_avx2.rs` — remainder handler extracted to reduce complexity
- Potentially other files if naming improvements needed

**Files unchanged:**
- `.clippy.toml` — threshold remains at 25
