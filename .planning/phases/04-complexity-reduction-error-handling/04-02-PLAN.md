---
phase: 4
plan: 2
name: "Module Split — Root Modules (metrics, quantization)"
wave: 2
depends_on: []
autonomous: true
---

# Phase 4 Plan 02: Module Split — Root Modules

## Objective

Split the two largest standalone root-level files into directory modules with focused submodules. These files have no cross-dependencies with the other splitting targets, making them safe to tackle first.

## Targets

| File | Lines | Split Strategy |
|------|------:|---------------|
| `metrics.rs` | 1529 | Directory module: collection metrics, graph metrics, query metrics, SIMD/perf metrics |
| `quantization.rs` | 559 | Directory module: product quantization, scalar quantization, encoding/decoding |

## Tasks

### Task 1: Split `metrics.rs` (1529 → 4-5 submodules)

**Files:** `crates/velesdb-core/src/metrics.rs` → `crates/velesdb-core/src/metrics/`

**Action:**
1. Read the file and identify logical boundaries (struct groups, impl blocks, metric categories)
2. Create directory module `metrics/mod.rs` as facade
3. Extract submodules by metric domain:
   - `metrics/collection.rs` — collection-level metrics (point count, dimension, storage size)
   - `metrics/graph.rs` — graph metrics (node count, edge count, degree distribution)
   - `metrics/query.rs` — query metrics (latency, throughput, cache hit rates)
   - `metrics/system.rs` — system/perf metrics (SIMD level, memory usage, GPU status)
4. `mod.rs` re-exports all public types and functions
5. Update `lib.rs` module declaration if needed

**Constraints:**
- Zero public API changes — all existing `use crate::metrics::*` must still work
- Each submodule <500 lines
- Follow Phase 3 SIMD split pattern: facade `mod.rs` + `pub(crate) use` re-exports

**Verify:**
```powershell
cargo check --workspace
cargo test -p velesdb-core metrics
```

### Task 2: Split `quantization.rs` (559 → 2-3 submodules)

**Files:** `crates/velesdb-core/src/quantization.rs` → `crates/velesdb-core/src/quantization/`

**Action:**
1. Identify logical sections (PQ encoding, SQ encoding, shared utilities)
2. Create directory module with facade
3. Extract submodules:
   - `quantization/product.rs` — product quantization (codebooks, encoding, distance)
   - `quantization/scalar.rs` — scalar quantization (min/max, encoding, distance)
   - `quantization/mod.rs` — shared types, trait definitions, re-exports

**Verify:**
```powershell
cargo check --workspace
cargo test -p velesdb-core quantization
```

## Verification

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
# Verify no file >500 lines
python -c "import os; [print(f'  {sum(1 for _ in open(os.path.join(r,f)))}: {os.path.join(r,f)}') for r,_,fs in os.walk('crates/velesdb-core/src/metrics') for f in fs if f.endswith('.rs') and sum(1 for _ in open(os.path.join(r,f))) > 500]"
```

## Success Criteria

- [ ] `metrics.rs` replaced by `metrics/` directory module (4-5 files, all <500 lines)
- [ ] `quantization.rs` replaced by `quantization/` directory module (2-3 files, all <500 lines)
- [ ] Zero public API changes
- [ ] All workspace tests pass
