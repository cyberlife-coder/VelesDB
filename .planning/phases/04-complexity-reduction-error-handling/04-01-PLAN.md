---
phase: 4
plan: 1
name: Panic Elimination & Error Type Enrichment
wave: 1
depends_on: none
autonomous: true
---

# Phase 4 Plan 01: Panic Elimination & Error Type Enrichment

## Objective

Convert all inappropriate panics in production code to proper `Result` types, add missing error variants for column store and GPU operations, and establish error context patterns using `thiserror`. This eliminates silent crashes and enables callers to handle errors gracefully.

## Context

**Requirements addressed:** DOCS-01, DOCS-02
**Phase goal contribution:** Directly satisfies the "panic elimination" and "rich error context" success criteria.

## Tasks

### Task 1: Add new Error variants to `error.rs`

**Files:** `crates/velesdb-core/src/error.rs`

**Action:**
Add three new error variants to the `Error` enum:

1. `ColumnStoreError` (VELES-024) — for column store schema/PK validation errors
2. `GpuError` (VELES-025) — for GPU parameter validation and operation failures
3. `EpochMismatch` (VELES-026) — for stale mmap guard detection

Each variant must:
- Follow existing `#[error("[VELES-XXX] ...")]` pattern
- Be added to the `code()` match arms
- Be added to `is_recoverable()` — ColumnStoreError and GpuError are recoverable, EpochMismatch is not

**Verify:**
```powershell
cargo check -p velesdb-core
```

**Done when:**
- Three new variants compile
- `code()` and `is_recoverable()` updated
- No breaking changes to existing API

---

### Task 2: Convert `column_store/mod.rs` panic to Result

**Files:** `crates/velesdb-core/src/column_store/mod.rs`

**Action:**
Convert `with_primary_key` from panicking to returning `Result<Self, Error>`:

**Current** (line 94):
```rust
pub fn with_primary_key(fields: &[(&str, ColumnType)], pk_column: &str) -> Self {
    // panic! if pk_column not found
    // assert! if pk_column not Int type
}
```

**Target:**
```rust
pub fn with_primary_key(fields: &[(&str, ColumnType)], pk_column: &str) -> crate::error::Result<Self> {
    let pk_field = fields
        .iter()
        .find(|(name, _)| *name == pk_column)
        .ok_or_else(|| crate::error::Error::ColumnStoreError(
            format!("Primary key column '{}' not found in fields: {:?}",
                pk_column, fields.iter().map(|(n, _)| *n).collect::<Vec<_>>())
        ))?;
    if !matches!(pk_field.1, ColumnType::Int) {
        return Err(crate::error::Error::ColumnStoreError(
            format!("Primary key column '{}' must be Int type, got {:?}", pk_column, pk_field.1)
        ));
    }
    // ... rest unchanged
}
```

- Remove `#[must_use]` (Result already enforces this via `#[must_use]` on Result)
- Update all callers to handle the Result (search for `with_primary_key(` across codebase)
- Callers in tests can use `.unwrap()` or `.expect()` since test panics are acceptable

**Verify:**
```powershell
cargo check --workspace
cargo test -p velesdb-core column_store
```

**Done when:**
- `with_primary_key` returns `Result<Self, Error>`
- All callers compile and tests pass
- No more `panic!` or `assert!` in this function

---

### Task 3: Convert `storage/guard.rs` assert to Result

**Files:** `crates/velesdb-core/src/storage/guard.rs`

**Action:**
Convert `as_slice()` from asserting to returning `Result`:

**Current** (line 82):
```rust
pub fn as_slice(&self) -> &[f32] {
    assert!(current == self.epoch_at_creation, "Mmap was remapped; VectorSliceGuard is invalid");
    unsafe { std::slice::from_raw_parts(self.ptr, self.len) }
}
```

**Target:**
```rust
pub fn as_slice(&self) -> crate::error::Result<&[f32]> {
    let current = self.epoch_ptr.load(std::sync::atomic::Ordering::Acquire);
    if current != self.epoch_at_creation {
        return Err(crate::error::Error::EpochMismatch(
            format!("Mmap was remapped (epoch {} → {}); VectorSliceGuard is invalid",
                self.epoch_at_creation, current)
        ));
    }
    Ok(unsafe { std::slice::from_raw_parts(self.ptr, self.len) })
}
```

- Also update `AsRef<[f32]>` impl — either remove it or use `as_slice().expect("epoch mismatch")` since AsRef can't return Result
- Update all callers of `as_slice()` and `as_ref()` to handle the Result
- This may ripple into `storage/mmap.rs` and HNSW search paths — trace all usages carefully

**Verify:**
```powershell
cargo check --workspace
cargo test -p velesdb-core storage
```

**Done when:**
- `as_slice()` returns `Result`
- All callers propagate the error or handle it
- No panic on epoch mismatch

---

### Task 4: Convert GPU parameter asserts to Result

**Files:** `crates/velesdb-core/src/gpu/gpu_backend.rs`

**Action:**
Convert `batch_cosine_similarity` parameter validation from asserts (lines 176-184) to return `Result<Vec<f32>, Error>`:

**Current:**
```rust
assert!(u32::try_from(dimension).is_ok(), ...);
assert!(u32::try_from(num_vectors).is_ok(), ...);
```

**Target:**
```rust
if u32::try_from(dimension).is_err() {
    return Err(crate::error::Error::GpuError(
        format!("dimension {} exceeds u32::MAX GPU shader limit", dimension)
    ));
}
if u32::try_from(num_vectors).is_err() {
    return Err(crate::error::Error::GpuError(
        format!("num_vectors {} exceeds u32::MAX GPU shader limit", num_vectors)
    ));
}
```

- Change return type from `Vec<f32>` to `crate::error::Result<Vec<f32>>`
- Also convert the GPU map-async failure path (line 290-291) from returning zeros to returning an error
- Update callers and tests

**Verify:**
```powershell
cargo check --workspace
cargo test -p velesdb-core gpu
```

**Done when:**
- GPU functions return Result
- Parameter errors are recoverable
- Map-async failures are proper errors, not silent zero vectors

---

## Verification

After all tasks complete:

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] Three new Error variants added (VELES-024, VELES-025, VELES-026)
- [ ] `column_store::with_primary_key` returns Result (no panic)
- [ ] `storage::guard::as_slice` returns Result (no assert)
- [ ] GPU `batch_cosine_similarity` returns Result (no assert)
- [ ] All callers updated and compiling
- [ ] All workspace tests pass
- [ ] No regressions in existing functionality

## Output

**Files modified:**
- `error.rs` — 3 new variants + code()/is_recoverable() updates
- `column_store/mod.rs` — with_primary_key returns Result
- `storage/guard.rs` — as_slice returns Result
- `gpu/gpu_backend.rs` — batch functions return Result
- Various callers — propagate new Result types
