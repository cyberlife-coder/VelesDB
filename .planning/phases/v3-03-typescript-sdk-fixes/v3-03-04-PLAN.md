---
phase: v3-03
plan: 04
name: rest.ts Module Extraction
wave: 2
depends_on: ["v3-03-02", "v3-03-03"]
autonomous: true
parallel_safe: true
estimated_time: 45min
---

# Phase v3-03 Plan 04: rest.ts Module Extraction

## Objective

Split the 856-line `rest.ts` monolith into a `rest/` module directory with 7 focused files, all under 300 lines. Uses a composition pattern: `HttpClient` base + standalone domain functions + `RestBackend` facade.

## Context

**Requirements addressed:** Code quality — <300 lines per file rule
**Phase goal contribution:** Makes the SDK maintainable, testable per domain, and ready for future features.

Current `rest.ts` layout (856 lines):
- Lines 1-73: Imports + internal server types
- Lines 75-254: Class skeleton + HTTP plumbing (init, request, helpers)
- Lines 256-328: Collections (create, delete, get, list)
- Lines 330-377: Points (insert, insertBatch)
- Lines 380-439: Search (search, searchBatch)
- Lines 442-476: Points continued (delete, get)
- Lines 478-637: textSearch, hybridSearch, query
- Lines 638-727: multiQuerySearch, matchQuery
- Lines 729-767: isEmpty, flush, close
- Lines 771-848: Indexes (create, list, has, drop)
- Lines 851-963: Graph (addEdge, getEdges, traverse, degree)

**Target structure:**

```
sdks/typescript/src/backends/rest/
├── index.ts           # RestBackend facade class (~80 lines)
├── http-client.ts     # HttpClient base: request(), init, helpers (~130 lines)
├── collections.ts     # Collection CRUD + isEmpty + flush (~100 lines)
├── points.ts          # insert, insertBatch, get, delete (~80 lines)
├── search.ts          # search, searchBatch, textSearch, hybridSearch, multiQuery (~130 lines)
├── query.ts           # query, matchQuery, explain (~130 lines)
├── graph.ts           # addEdge, getEdges, traverseGraph, getNodeDegree (~100 lines)
└── server-types.ts    # Internal snake_case server response interfaces (~60 lines)
```

## Tasks

### Task 1: Create server-types.ts — Internal server interfaces

**Files:** `sdks/typescript/src/backends/rest/server-types.ts` (NEW)
**Action:**
- Move from `rest.ts`:
  - `ApiResponse<T>` interface
  - `BatchSearchResponse` interface
  - `ServerMatchQueryResponse` interface
  - `ServerSelectQueryResponse` interface
  - `ServerAggregationResponse` interface
  - `ServerExplainResponse` interface (added by Plan 03)
- All prefixed `Server*` are internal — no `export` from package root
**Verify:** File exists, no syntax errors
**Done when:** All internal server interfaces in one file, <60 lines

---

### Task 2: Create http-client.ts — HTTP plumbing

**Files:** `sdks/typescript/src/backends/rest/http-client.ts` (NEW)
**Action:**
- Create `HttpClient` class with:
  - Constructor: `(baseUrl: string, apiKey?: string, timeout?: number)`
  - `request<T>(method, path, body?): Promise<ApiResponse<T>>` — the core HTTP method
  - `init(): Promise<void>` — health check + init lock (_initPromise pattern)
  - `isInitialized(): boolean`
  - `ensureInitialized(): void` — throws ConnectionError if not init'd
  - `parseNodeId(value: unknown): bigint | number`
  - Private: `mapStatusToErrorCode()`, `extractErrorPayload()`, `_performInit()`
- Export `HttpClient` class
- Import `ApiResponse` from `./server-types`
- Import error types from `../../types`
**Verify:** `npx tsc --noEmit`
**Done when:** HttpClient is self-contained, <130 lines

---

### Task 3: Create domain modules — collections, points, search, query, graph

**Files:** (all NEW)
- `sdks/typescript/src/backends/rest/collections.ts`
- `sdks/typescript/src/backends/rest/points.ts`
- `sdks/typescript/src/backends/rest/search.ts`
- `sdks/typescript/src/backends/rest/query.ts`
- `sdks/typescript/src/backends/rest/graph.ts`

**Action:**
Each module exports standalone async functions that take `HttpClient` as first param:

**collections.ts** (~100 lines):
```typescript
import { HttpClient } from './http-client';
import type { CollectionConfig, Collection } from '../../types';

export async function createCollection(client: HttpClient, name: string, config: CollectionConfig): Promise<void> { ... }
export async function deleteCollection(client: HttpClient, name: string): Promise<void> { ... }
export async function getCollection(client: HttpClient, name: string): Promise<Collection | null> { ... }
export async function listCollections(client: HttpClient): Promise<Collection[]> { ... }
export async function isEmpty(client: HttpClient, collection: string): Promise<boolean> { ... }
export async function flush(client: HttpClient, collection: string): Promise<void> { ... }
```

**points.ts** (~80 lines):
```typescript
export async function insert(client: HttpClient, collection: string, doc: VectorDocument): Promise<void> { ... }
export async function insertBatch(client: HttpClient, collection: string, docs: VectorDocument[]): Promise<void> { ... }
export async function getPoint(client: HttpClient, collection: string, id: string | number): Promise<VectorDocument | null> { ... }
export async function deletePoint(client: HttpClient, collection: string, id: string | number): Promise<boolean> { ... }
```

**search.ts** (~130 lines):
```typescript
export async function search(client: HttpClient, collection: string, query: number[] | Float32Array, options?: SearchOptions): Promise<SearchResult[]> { ... }
export async function searchBatch(client: HttpClient, collection: string, searches: Array<...>): Promise<SearchResult[][]> { ... }
export async function textSearch(client: HttpClient, ...): Promise<SearchResult[]> { ... }
export async function hybridSearch(client: HttpClient, ...): Promise<SearchResult[]> { ... }
export async function multiQuerySearch(client: HttpClient, ...): Promise<SearchResult[]> { ... }
```

**query.ts** (~130 lines):
```typescript
export async function query(client: HttpClient, collection: string, queryString: string, ...): Promise<QueryResponse> { ... }
export async function matchQuery(client: HttpClient, collection: string, ...): Promise<MatchQueryResponse> { ... }
export async function explain(client: HttpClient, queryString: string, ...): Promise<ExplainResponse> { ... }
```

**graph.ts** (~100 lines):
```typescript
export async function addEdge(client: HttpClient, collection: string, edge: AddEdgeRequest): Promise<void> { ... }
export async function getEdges(client: HttpClient, collection: string, options?: GetEdgesOptions): Promise<GraphEdge[]> { ... }
export async function traverseGraph(client: HttpClient, collection: string, request: TraverseRequest): Promise<TraverseResponse> { ... }
export async function getNodeDegree(client: HttpClient, collection: string, nodeId: number): Promise<DegreeResponse> { ... }
```

Logic is moved verbatim from `rest.ts` — no behavior changes. Only structural.

**Verify:** `npx tsc --noEmit`
**Done when:** All 5 domain modules exist, each <130 lines, each self-contained

---

### Task 4: Create RestBackend facade + update imports

**Files:**
- `sdks/typescript/src/backends/rest/index.ts` (NEW — facade)
- `sdks/typescript/src/backends/rest.ts` (DELETE — replaced by directory)

**Action:**
- Create `rest/index.ts` as thin facade:
```typescript
import { HttpClient } from './http-client';
import * as collections from './collections';
import * as points from './points';
import * as search from './search';
import * as queryModule from './query';
import * as graph from './graph';
// ... delegate each IVelesDBBackend method to the matching module function
export class RestBackend implements IVelesDBBackend {
  private readonly client: HttpClient;
  constructor(url: string, apiKey?: string, timeout?: number) {
    this.client = new HttpClient(url, apiKey, timeout);
  }
  async init() { return this.client.init(); }
  async createCollection(name, config) { return collections.createCollection(this.client, name, config); }
  // ... one-liner delegation for every method
}
```
- Delete the old `rest.ts` file (replaced by `rest/` directory)
- Update `sdks/typescript/src/index.ts` import: `export { RestBackend } from './backends/rest'`
  (TypeScript resolves `rest/index.ts` automatically — no change needed if path stays `./backends/rest`)

**Verify:** `npx tsc --noEmit && npx vitest run`
**Done when:**
- Old `rest.ts` deleted
- `rest/index.ts` facade delegates all 25 methods
- All tests still pass with zero changes to test imports

---

### Task 5: Line count verification + full test suite

**Action:**
- Verify every file in `rest/` is under 300 lines:
  ```powershell
  Get-ChildItem sdks/typescript/src/backends/rest/*.ts | ForEach-Object { "$($_.Name): $((Get-Content $_).Count) lines" }
  ```
- Run full test suite
**Verify:**
```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
```
**Done when:** All files <300 lines, zero test failures, zero type errors

## Verification

```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
# Line count check:
Get-ChildItem src/backends/rest/*.ts | ForEach-Object { "$($_.Name): $((Get-Content $_).Count) lines" }
```

## Success Criteria

- [ ] Old `rest.ts` (856 lines) deleted
- [ ] 7 new files in `rest/` directory
- [ ] Every file under 300 lines
- [ ] `RestBackend` facade delegates all `IVelesDBBackend` methods
- [ ] `HttpClient` encapsulates all HTTP plumbing
- [ ] Zero behavior changes — pure structural refactor
- [ ] All existing tests pass without import changes
- [ ] `npx tsc --noEmit` — zero errors

## Parallel Safety

**Exclusive write files:**
- `sdks/typescript/src/backends/rest.ts` (DELETE)
- `sdks/typescript/src/backends/rest/` (entire directory — NEW)
**Shared read files:** `sdks/typescript/src/types.ts`
**Conflicts with:** none (Wave 2 — runs alone after Wave 1)

## Output

**Files created:**
- `sdks/typescript/src/backends/rest/index.ts` — RestBackend facade
- `sdks/typescript/src/backends/rest/http-client.ts` — HTTP plumbing
- `sdks/typescript/src/backends/rest/server-types.ts` — Internal interfaces
- `sdks/typescript/src/backends/rest/collections.ts` — Collection operations
- `sdks/typescript/src/backends/rest/points.ts` — Point operations
- `sdks/typescript/src/backends/rest/search.ts` — Search operations
- `sdks/typescript/src/backends/rest/query.ts` — Query + MATCH + EXPLAIN
- `sdks/typescript/src/backends/rest/graph.ts` — Graph operations

**Files deleted:**
- `sdks/typescript/src/backends/rest.ts` — Replaced by directory
