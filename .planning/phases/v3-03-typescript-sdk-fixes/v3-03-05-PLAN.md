---
phase: v3-03
plan: 05
name: SELECT Query Builder
wave: 3
depends_on: ["v3-03-04"]
autonomous: true
parallel_safe: true
estimated_time: 30min
---

# Phase v3-03 Plan 05: SELECT Query Builder

## Objective

Create a fluent `SelectBuilder` for building VelesQL SELECT queries with type safety: SELECT columns, FROM, WHERE, ORDER BY, LIMIT, OFFSET, GROUP BY, aggregation functions, JOINs, and NEAR vector search. Companion to the existing `VelesQLBuilder` (MATCH-only).

## Context

**Requirements addressed:** Full SDK DX — developers should never write raw VelesQL strings
**Phase goal contribution:** Completes the query builder story: MATCH builder + SELECT builder = full VelesQL coverage.

The existing `VelesQLBuilder` only supports MATCH pattern syntax. Users must write raw strings for:
- `SELECT * FROM collection WHERE ...`
- Aggregations: `SELECT COUNT(*), AVG(price) FROM products GROUP BY category`
- JOINs: `SELECT ... FROM docs JOIN products ON ...`
- Vector search: `SELECT * FROM docs WHERE similarity(embedding, $v) > 0.8`

## Tasks

### Task 1: Write TDD tests for SelectBuilder

**Files:** `sdks/typescript/tests/select-builder.test.ts` (NEW)
**Action:**
Write tests FIRST covering:

```typescript
describe('SelectBuilder', () => {
  // Basic SELECT
  test('SELECT * FROM collection');
  test('SELECT specific columns');
  test('SELECT with column aliases');
  
  // WHERE
  test('WHERE with simple condition');
  test('WHERE with params');
  test('AND WHERE chaining');
  test('OR WHERE chaining');
  
  // Vector search
  test('WHERE NEAR vector clause');
  test('WHERE similarity() clause');
  
  // Aggregation
  test('SELECT COUNT(*)');
  test('SELECT with multiple aggregations');
  test('GROUP BY single column');
  test('GROUP BY multiple columns');
  
  // ORDER BY, LIMIT, OFFSET
  test('ORDER BY single column ASC');
  test('ORDER BY DESC');
  test('LIMIT');
  test('OFFSET');
  test('LIMIT + OFFSET');
  
  // JOIN
  test('INNER JOIN');
  test('LEFT JOIN with ON clause');
  
  // Complex queries
  test('Full query with WHERE + ORDER BY + LIMIT');
  test('Aggregation with GROUP BY + WHERE');
  test('Vector search with filter + LIMIT');
  
  // Params
  test('getParams() returns all bound params');
  test('build() returns { query, params }');
  
  // Errors
  test('build() without FROM throws');
});
```

**Verify:** Tests exist and fail (RED phase)
**Done when:** 25+ test cases written, all failing

---

### Task 2: Implement SelectBuilder

**Files:** `sdks/typescript/src/select-builder.ts` (NEW)
**Action:**
Create `SelectBuilder` class (<250 lines):

```typescript
export class SelectBuilder {
  // Immutable builder pattern (same as VelesQLBuilder)
  
  from(collection: string): SelectBuilder
  select(...columns: string[]): SelectBuilder
  selectAll(): SelectBuilder
  selectAs(field: string, alias: string): SelectBuilder
  selectAgg(fn: 'COUNT' | 'SUM' | 'AVG' | 'MIN' | 'MAX', field: string, alias?: string): SelectBuilder
  
  where(condition: string, params?: Record<string, unknown>): SelectBuilder
  andWhere(condition: string, params?: Record<string, unknown>): SelectBuilder
  orWhere(condition: string, params?: Record<string, unknown>): SelectBuilder
  
  nearVector(paramName: string, vector: number[] | Float32Array, options?: { topK?: number }): SelectBuilder
  similarity(field: string, paramName: string, vector: number[] | Float32Array, options?: { threshold?: number }): SelectBuilder
  
  join(table: string, on: string, type?: 'INNER' | 'LEFT' | 'RIGHT'): SelectBuilder
  
  groupBy(...columns: string[]): SelectBuilder
  
  orderBy(field: string, direction?: 'ASC' | 'DESC'): SelectBuilder
  limit(value: number): SelectBuilder
  offset(value: number): SelectBuilder
  
  getParams(): Record<string, unknown>
  build(): { query: string; params: Record<string, unknown> }
}

export function selectql(): SelectBuilder
```

Key design decisions:
- Immutable builder (clone on every method call) — same pattern as VelesQLBuilder
- `build()` returns `{ query, params }` object — not just string — for direct use with `db.query()`
- `from()` is REQUIRED — `build()` throws without it
- Aggregation functions are uppercase in output: `COUNT(*)`, `AVG(price)`
- WHERE conditions use `$param` syntax for parameterized queries

**Verify:** `npx vitest run tests/select-builder.test.ts`
**Done when:** All 25+ tests pass (GREEN phase)

---

### Task 3: Export from index.ts + full verification

**Files:** `sdks/typescript/src/index.ts`
**Action:**
- Add export: `export { SelectBuilder, selectql } from './select-builder'`
- Run full test suite
**Verify:**
```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
```
**Done when:** `selectql` importable from package root, all tests pass

## Verification

```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
```

## Success Criteria

- [ ] `SelectBuilder` class in `select-builder.ts` (<250 lines)
- [ ] `selectql()` factory function exported
- [ ] Supports: SELECT, FROM, WHERE, AND/OR, NEAR, similarity, JOIN, GROUP BY, ORDER BY, LIMIT, OFFSET, aggregations
- [ ] `build()` returns `{ query: string, params: Record<string, unknown> }`
- [ ] Immutable builder pattern (clone on every call)
- [ ] 25+ test cases in `select-builder.test.ts`
- [ ] All tests pass
- [ ] Exported from package root via `index.ts`

## Parallel Safety

**Exclusive write files:**
- `sdks/typescript/src/select-builder.ts` (NEW)
- `sdks/typescript/tests/select-builder.test.ts` (NEW)
- `sdks/typescript/src/index.ts` (add export line)
**Shared read files:** none
**Conflicts with:** Plan 06 (index.ts — single line addition each, low risk) → parallel_safe

## Output

**Files created:**
- `sdks/typescript/src/select-builder.ts` — SelectBuilder class
- `sdks/typescript/tests/select-builder.test.ts` — 25+ TDD tests

**Files modified:**
- `sdks/typescript/src/index.ts` — Add SelectBuilder export
