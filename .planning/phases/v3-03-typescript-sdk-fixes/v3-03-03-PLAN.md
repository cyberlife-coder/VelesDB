---
phase: v3-03
plan: 03
name: EXPLAIN Endpoint & Search Options
wave: 1
depends_on: ["v3-03-02"]
autonomous: true
parallel_safe: sequential_only
estimated_time: 30min
---

# Phase v3-03 Plan 03: EXPLAIN Endpoint & Search Options

## Objective

Add full `explain()` support (types, interface, REST backend, client, WASM stub) for the `POST /query/explain` endpoint, and extend `SearchOptions` with `efSearch` and `mode` params to expose HNSW recall tuning.

## Context

**Requirements addressed:** Full API parity — EXPLAIN is the only missing server endpoint (1/25).
**Phase goal contribution:** Closes the last endpoint gap. SDK covers 25/25 server routes.

The server's `POST /query/explain` returns an `ExplainResponse` with query plan steps, estimated cost, feature detection, and query type. The SDK has zero support for this. Additionally, the server's search handler accepts `ef_search` (integer) and `mode` (string preset) but the SDK's `SearchOptions` doesn't expose them.

## Tasks

### Task 1: Add EXPLAIN types to types.ts (TDD — types first)

**Files:** `sdks/typescript/src/types.ts`
**Action:**
- Add `ExplainStep` interface: `{ step: number; operation: string; description: string; estimatedRows?: number }`
- Add `ExplainCost` interface: `{ usesIndex: boolean; indexName?: string; selectivity: number; complexity: string }`
- Add `ExplainFeatures` interface: `{ hasVectorSearch: boolean; hasFilter: boolean; hasOrderBy: boolean; hasGroupBy: boolean; hasAggregation: boolean; hasJoin: boolean; hasFusion: boolean; limit?: number; offset?: number }`
- Add `ExplainResponse` interface: `{ query: string; queryType: string; collection: string; plan: ExplainStep[]; estimatedCost: ExplainCost; features: ExplainFeatures }`
- Add `explain()` to `IVelesDBBackend` interface: `explain(queryString: string, params?: Record<string, unknown>): Promise<ExplainResponse>`
- Extend `SearchOptions` with `efSearch?: number` and `mode?: 'fast' | 'balanced' | 'accurate'`
**Verify:** `npx tsc --noEmit`
**Done:** All EXPLAIN types exported, `IVelesDBBackend` has `explain()`, `SearchOptions` has `efSearch`/`mode`

### Task 2: Implement explain() in RestBackend + extend search()

**Files:** `sdks/typescript/src/backends/rest.ts`
**Action:**
- Add `explain()` method:
  - `POST /query/explain` with `{ query: queryString, params }`
  - Map snake_case server response to camelCase SDK types
  - `estimated_cost.uses_index` → `estimatedCost.usesIndex`
  - `estimated_cost.index_name` → `estimatedCost.indexName`
  - `features.has_vector_search` → `features.hasVectorSearch` (etc.)
  - Return typed `ExplainResponse`
- Extend `search()` to send `ef_search` and `mode`:
  - If `options.efSearch` is set, include `ef_search` in request body
  - If `options.mode` is set, include `mode` in request body
- Add proper server response interface `ServerExplainResponse` (internal)
**Verify:** `npx tsc --noEmit`
**Done:** `explain()` calls server and maps response; `search()` sends ef_search/mode

### Task 3: Add explain() to VelesDB client + WasmBackend stub + tests

**Files:** `sdks/typescript/src/client.ts`, `sdks/typescript/src/backends/wasm.ts`, `sdks/typescript/tests/rest-backend.test.ts`
**Action:**
- `client.ts`: Add `explain()` method with JSDoc, validation (queryString must be non-empty string)
- `wasm.ts`: Add `explain()` stub that throws `VelesDBError('EXPLAIN is not supported in WASM backend', 'NOT_SUPPORTED')`
- `tests/rest-backend.test.ts`: TDD tests:
  - `explain()` sends correct request and maps snake_case response
  - `explain()` with parse error returns proper error
  - `search()` with efSearch sends ef_search in body
  - `search()` with mode sends mode in body
  - `search()` without efSearch/mode doesn't include them (backward compatible)
**Verify:**
```powershell
cd sdks/typescript
npx vitest run tests/rest-backend.test.ts
```
**Done:** All 5+ new tests pass, explain() works end-to-end

### Task 4: Update index.ts exports + full verification

**Files:** `sdks/typescript/src/index.ts`
**Action:**
- Verify EXPLAIN types auto-exported via `export * from './types'`
- Run full test suite
**Verify:**
```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
```
**Done:** EXPLAIN types importable from package root, all tests pass

## Verification

```powershell
cd sdks/typescript
npx tsc --noEmit && npx vitest run
```

## Success Criteria

- [ ] `ExplainResponse`, `ExplainStep`, `ExplainCost`, `ExplainFeatures` exported from `types.ts`
- [ ] `explain()` in `IVelesDBBackend` interface
- [ ] `explain()` in `RestBackend` — calls `POST /query/explain`, maps snake→camel
- [ ] `explain()` in `VelesDB` client with validation
- [ ] `explain()` in `WasmBackend` — throws NOT_SUPPORTED
- [ ] `SearchOptions.efSearch` and `SearchOptions.mode` supported
- [ ] `search()` sends `ef_search`/`mode` when provided
- [ ] 5+ new tests pass
- [ ] All existing tests still pass

## Parallel Safety

**Exclusive write files:**
- `sdks/typescript/src/types.ts` (add EXPLAIN types, extend SearchOptions)
- `sdks/typescript/src/backends/rest.ts` (add explain(), extend search())
- `sdks/typescript/src/client.ts` (add explain())
- `sdks/typescript/src/backends/wasm.ts` (add explain() stub)
- `sdks/typescript/tests/rest-backend.test.ts` (new tests)
**Shared read files:** none
**Conflicts with:** Plan 02 (types.ts, rest.ts) → sequential after Plan 02

## Output

**Files modified:**
- `sdks/typescript/src/types.ts` — EXPLAIN types + SearchOptions extension
- `sdks/typescript/src/backends/rest.ts` — explain() + search() ef_search/mode
- `sdks/typescript/src/client.ts` — explain() client method
- `sdks/typescript/src/backends/wasm.ts` — explain() stub
- `sdks/typescript/tests/rest-backend.test.ts` — 5+ new tests
