---
phase: 5
plan: 1
name: Dependency Hygiene & Dead Code Cleanup
wave: 1
depends_on: none
autonomous: true
---

# Phase 5 Plan 1: Dependency Hygiene & Dead Code Cleanup

## Objective

Remove unused dependencies across all workspace crates, audit `#[allow(dead_code)]` annotations for legitimacy, and clean up feature flags for clarity. This plan addresses CLEAN-01, CLEAN-02, and CLEAN-03.

## Context

**Requirements addressed:** CLEAN-01, CLEAN-02, CLEAN-03
**Phase goal contribution:** Eliminates technical debt from unused dependencies and ensures feature flags are necessary and documented.

**Current state (from deep scan):**
- `cargo clippy -- -W dead_code`: **0 warnings** (CLEAN-01 largely satisfied)
- `cargo machete` found unused deps in 6 crates:
  - `velesdb-cli`: thiserror, crossbeam-channel
  - `velesdb-core`: sqlx
  - `velesdb-migrate`: tokio
  - `velesdb-mobile`: thiserror
  - `velesdb-server`: half
  - `tauri-rag-app`: thiserror
- Feature flags in velesdb-core: default, gpu, persistence, update-check, loom, portable-simd

## Tasks

### Task 1: Audit and remove unused dependencies

**Files:** `Cargo.toml` files across workspace crates

**Action:**
For each unused dependency found by `cargo machete`:
1. Verify the dependency is truly unused (grep for its use in source)
2. If unused: remove from `Cargo.toml`
3. If false positive: add to `[package.metadata.cargo-machete] ignored` list with reason comment
4. Run `cargo check --workspace` after each removal to confirm no breakage

Specific removals to investigate:
- `velesdb-cli/Cargo.toml`: thiserror (might use derive), crossbeam-channel
- `velesdb-core/Cargo.toml`: sqlx (likely leftover from migration)
- `velesdb-migrate/Cargo.toml`: tokio (might be used conditionally)
- `velesdb-mobile/Cargo.toml`: thiserror
- `velesdb-server/Cargo.toml`: half (might be used for f16 support)
- `demos/tauri-rag-app/src-tauri/Cargo.toml`: thiserror

**Verify:**
```powershell
cargo machete --with-metadata 2>&1
cargo check --workspace
```

**Done when:**
- `cargo machete` reports 0 unused deps (or all remaining are documented false positives)
- `cargo check --workspace` succeeds

---

### Task 2: Audit #[allow(dead_code)] annotations

**Files:** All `.rs` files in `crates/velesdb-core/src/`

**Action:**
1. Search for all `#[allow(dead_code)]` annotations
2. For each one, determine if the code is:
   - **Legitimately unused but intentional** (e.g., public API for future use, platform-specific) → keep with `// Reason:` comment
   - **Truly dead** → remove the annotation AND the dead code
   - **Used but annotation is stale** → remove annotation only
3. Run `cargo clippy -- -W dead_code` after cleanup to confirm

**Verify:**
```powershell
cargo clippy -p velesdb-core -- -W dead_code 2>&1
```

**Done when:**
- All `#[allow(dead_code)]` have justification comments
- No newly exposed dead code warnings

---

### Task 3: Feature flag audit and documentation

**Files:** `crates/velesdb-core/Cargo.toml`, `crates/velesdb-core/src/lib.rs`

**Action:**
1. Audit each feature flag for necessity:
   - `persistence` — Required for WASM separation ✅
   - `gpu` — Required for GPU acceleration ✅
   - `update-check` — Required for version checking ✅
   - `loom` — Required for concurrency testing ✅
   - `portable-simd` — EPIC-054 evaluation, nightly-only. Check if still relevant or should be removed
2. Ensure each feature has clear documentation comment in Cargo.toml
3. Check for any `#[cfg(feature = "...")]` that references non-existent features
4. Verify WASM builds work with `default-features = false`

**Verify:**
```powershell
cargo check --package velesdb-core --no-default-features
cargo check --package velesdb-core
cargo check --package velesdb-wasm
```

**Done when:**
- All features documented with purpose and usage instructions
- No orphaned feature references
- WASM build succeeds with persistence disabled

---

## Verification

After all tasks complete:

```powershell
cargo machete --with-metadata
cargo clippy --workspace -- -D warnings
cargo test -p velesdb-core --lib
cargo check --workspace
```

## Success Criteria

- [ ] `cargo machete` reports 0 unused dependencies (or documented false positives)
- [ ] `cargo clippy -- -W dead_code` reports 0 warnings
- [ ] All `#[allow(dead_code)]` have justification comments
- [ ] All feature flags documented in Cargo.toml
- [ ] WASM build (`--no-default-features`) succeeds
- [ ] All quality gates pass

## Output

**Files modified:**
- Multiple `Cargo.toml` files — removed unused dependencies
- `crates/velesdb-core/Cargo.toml` — feature flag documentation improved
- Various `.rs` files — dead code annotations audited
