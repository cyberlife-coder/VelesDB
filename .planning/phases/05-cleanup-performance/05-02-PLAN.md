---
phase: 5
plan: 2
name: WAL Recovery Edge Case Tests
wave: 1
depends_on: none
autonomous: true
---

# Phase 5 Plan 2: WAL Recovery Edge Case Tests

## Objective

Add comprehensive WAL (Write-Ahead Log) recovery tests covering partial writes, data corruption detection, and crash recovery scenarios. This ensures the storage layer is resilient to real-world failure modes.

## Context

**Requirements addressed:** TEST-04
**Phase goal contribution:** Strengthens storage reliability guarantees with edge case coverage.

**Current WAL test coverage (from scan):**
- `test_storage_wal_recovery` — Basic recovery after normal write
- `test_load_from_snapshot_plus_delta_wal` — Snapshot + delta integration
- `test_wal_position_stored_in_snapshot` — WAL position tracking
- 110 total storage tests across 7 test files
- **Missing:** Partial writes, corruption detection, crash simulation, concurrent recovery

**Key files:**
- `storage/mmap.rs` — Main mmap storage with WAL integration
- `storage/mmap/vector_io.rs` — Vector I/O operations
- `storage/log_payload.rs` — WAL payload format (57 WAL references)
- `storage/compaction.rs` — Compaction with WAL coordination

## Tasks

### Task 1: Analyze WAL format and recovery path

**Files:** `storage/log_payload.rs`, `storage/mmap.rs`, `storage/mmap/vector_io.rs`

**Action:**
1. Read and document the WAL binary format (header, payload, checksum structure)
2. Identify the recovery code path (entry point, iteration, validation)
3. Map which error conditions are handled vs. silently ignored
4. Identify edge cases not currently tested

**Verify:**
Review notes captured in test file comments.

**Done when:**
- WAL format documented in test file header
- Recovery path mapped with identified gaps

---

### Task 2: Add partial write recovery tests

**Files:** `crates/velesdb-core/src/storage/wal_recovery_tests.rs` (new)

**Action:**
Create a new test file with partial write scenarios:
1. **Truncated header** — WAL entry with incomplete header bytes
2. **Truncated payload** — Header intact but payload cut short
3. **Zero-length payload** — Valid header pointing to 0 bytes
4. **Write interrupted mid-vector** — Partial vector data written
5. **Multiple entries, last truncated** — N valid entries + 1 partial at end

For each test:
- Write valid WAL entries to a temp file
- Manually truncate/corrupt the file at specific offsets
- Attempt recovery and verify:
  - All valid entries before corruption are recovered
  - Corrupt/partial entry is skipped or reported
  - No panic occurs

**Verify:**
```powershell
cargo test -p velesdb-core --lib wal_recovery_tests
```

**Done when:**
- 5+ partial write tests passing
- Recovery handles all truncation points gracefully

---

### Task 3: Add corruption detection tests

**Files:** `crates/velesdb-core/src/storage/wal_recovery_tests.rs`

**Action:**
Add corruption-specific tests:
1. **Flipped bits in header** — Corrupt magic bytes or version field
2. **Flipped bits in payload** — Corrupt vector data mid-entry
3. **Checksum mismatch** — Valid structure but wrong checksum
4. **Invalid operation type** — Unknown operation code in header
5. **Oversized payload length** — Header claims payload larger than file

For each test:
- Write valid WAL data
- Apply specific byte-level corruption
- Attempt recovery and verify graceful handling

**Verify:**
```powershell
cargo test -p velesdb-core --lib wal_recovery_tests -- corruption
```

**Done when:**
- 5+ corruption tests passing
- No panics on any corruption pattern
- Valid data before corruption is recoverable

---

### Task 3: Add crash recovery simulation tests

**Files:** `crates/velesdb-core/src/storage/wal_recovery_tests.rs`

**Action:**
Add crash simulation tests:
1. **Recovery after clean shutdown** — Baseline: all data intact
2. **Recovery after unclean shutdown** — WAL not flushed, simulate by not calling close()
3. **Recovery with stale snapshot** — Snapshot older than WAL, verify WAL replay applies delta
4. **Double recovery** — Recover, then recover again (idempotency)
5. **Recovery with empty WAL** — Snapshot exists but WAL is empty/missing

**Verify:**
```powershell
cargo test -p velesdb-core --lib wal_recovery_tests -- crash
```

**Done when:**
- 5+ crash recovery tests passing
- Recovery is idempotent (double recovery produces same state)

---

## Verification

After all tasks complete:

```powershell
cargo test -p velesdb-core --lib wal_recovery_tests
cargo test -p velesdb-core --lib -- storage
cargo clippy -p velesdb-core -- -D warnings
```

## Success Criteria

- [ ] 15+ new WAL recovery edge case tests
- [ ] Partial write scenarios tested (truncated header, payload, mid-vector)
- [ ] Corruption detection tested (bit flips, checksum mismatch, invalid ops)
- [ ] Crash recovery simulation tested (clean/unclean shutdown, idempotency)
- [ ] Zero panics on any corruption/truncation pattern
- [ ] All existing storage tests still pass
- [ ] All quality gates pass

## Output

**Files created:**
- `crates/velesdb-core/src/storage/wal_recovery_tests.rs` — WAL edge case test suite

**Files modified:**
- `crates/velesdb-core/src/storage/mod.rs` — Wire new test module (if needed)
