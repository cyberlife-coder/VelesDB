---
phase: 5
plan: 1
name: VelesQL Spec & Feature Matrix Truth
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase 5 Plan 01: VelesQL Spec & Feature Matrix Truth

## Objective

Update `docs/VELESQL_SPEC.md` to accurately reflect the current state of VelesQL implementation. The spec currently omits subquery support, has incomplete EBNF grammar (missing MATCH, temporal, NEAR_FUSED), and the feature status table needs updating to reflect v4-verify-promise fixes.

## Context

**Requirements addressed:** VP-008 (README accuracy audit)
**Phase goal contribution:** Ensures the VelesQL reference document matches reality â€” developers consulting the spec get accurate information about what works, what's partial, and what's planned.

**Current issues in `docs/VELESQL_SPEC.md`:**
1. Feature table says "MATCH graph traversal âœ… Stable v2.1" â€” but multi-hop and subqueries were just fixed in v4 Phases 2-3
2. EBNF grammar section omits MATCH clause entirely
3. EBNF grammar omits temporal expressions (NOW(), INTERVAL)
4. EBNF grammar omits NEAR_FUSED syntax
5. No subquery documentation at all
6. REST API shows `POST /collections/{name}/match` â€” verify this endpoint actually exists
7. Missing: ILIKE in EBNF grammar

## Tasks

### Task 1: Update Feature Support Status Table

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Update the Feature Support Status table (lines 13-27) to accurately reflect current state:
- Add `Subqueries (scalar)` as `âœ… Stable | 2.1` (implemented in v4 Phase 2)
- Add `NEAR_FUSED multi-vector` as `âœ… Stable | 2.0`
- Add `Multi-hop MATCH patterns` as `âœ… Stable | 2.1` (implemented in v4 Phase 3)
- Add `RETURN aggregation in MATCH` as `âœ… Stable | 2.1` (implemented in v4 Phase 3)
- Add `ORDER BY property in MATCH` as `âœ… Stable | 2.1` (implemented in v4 Phase 1)
- Add `ILIKE (case-insensitive)` as `âœ… Stable | 1.0`
- Verify "Table aliases" status â€” confirm it's still ðŸ”œ Planned
- Update `Last Updated` date to current date

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "Subquer|NEAR_FUSED|Multi-hop|RETURN agg"
```

**Done when:**
- Feature table has all currently-working features listed with correct status
- No working feature is listed as Planned or missing
- Date is updated

---

### Task 2: Add Subquery and NEAR_FUSED Documentation Sections

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Add new documentation sections for features currently undocumented in the spec:

1. **Subquery section** (after the IN/BETWEEN/LIKE sections):
   - Syntax: `(SELECT column FROM collection WHERE condition)`
   - Correlated subqueries: outer row reference resolution
   - Scalar subquery requirement (must return single value)
   - Example: `WHERE (SELECT price FROM inventory WHERE sku = product.sku) < 500`
   - Limitations: only scalar subqueries, no EXISTS/IN subqueries yet

2. **NEAR_FUSED section** (after the NEAR section):
   - Syntax: `WHERE vector NEAR_FUSED [$v1, $v2] USING FUSION 'strategy'`
   - Multi-vector fusion search
   - Available strategies: rrf, average, maximum, weighted
   - Examples from README Scenario 0b

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "Subquer|NEAR_FUSED"
```

**Done when:**
- Subquery syntax, examples, and limitations are documented
- NEAR_FUSED syntax and strategies are documented
- Both sections include practical examples

---

### Task 3: Update EBNF Grammar to Include MATCH, Temporal, Subqueries

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Extend the EBNF grammar (lines 694-786) to include the missing productions:

1. **MATCH clause**:
   ```ebnf
   match_stmt = "MATCH" pattern_list [where_clause] "RETURN" return_list
                [order_by_clause] [limit_clause] ;
   pattern_list = pattern { "," pattern } ;
   pattern = node_pattern { relationship_pattern node_pattern } ;
   node_pattern = "(" [identifier] [":" identifier] [property_map] ")" ;
   relationship_pattern = "-[" [identifier] [":" identifier] [var_length] "]->"
                        | "<-[" [identifier] [":" identifier] [var_length] "]-"
                        | "-[" [identifier] [":" identifier] [var_length] "]-" ;
   var_length = "*" integer ".." integer ;
   property_map = "{" identifier ":" value { "," identifier ":" value } "}" ;
   return_list = return_item { "," return_item } ;
   return_item = (column | aggregate_func) ["AS" identifier] ;
   ```

2. **Temporal expressions**:
   ```ebnf
   temporal_expr = "NOW" "(" ")" [("-" | "+") interval_expr] ;
   interval_expr = "INTERVAL" string ;
   ```
   Add `temporal_expr` as a valid value/comparison operand.

3. **Subquery**:
   ```ebnf
   subquery = "(" select_stmt ")" ;
   ```
   Add `subquery` as a valid value type in comparisons.

4. **NEAR_FUSED**:
   ```ebnf
   fused_search = identifier "NEAR_FUSED" "[" vector_expr { "," vector_expr } "]" ;
   ```

5. **ILIKE**:
   Add `"ILIKE"` alongside `"LIKE"` in `like_cond`.

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "match_stmt|temporal_expr|subquery|fused_search|ILIKE"
```

**Done when:**
- EBNF grammar includes MATCH clause productions
- Temporal expressions (NOW/INTERVAL) in grammar
- Subquery as valid value type in grammar
- NEAR_FUSED in grammar
- ILIKE alongside LIKE
- Grammar compiles conceptually (no contradictions)

---

## Verification

After all tasks complete:

```powershell
# Verify no broken markdown
# Check that feature table has all items
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "âœ… Stable" | Measure-Object
# Should show increased count

# Check new sections exist
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "## Subquer|## NEAR_FUSED|match_stmt|temporal_expr"
```

## Success Criteria

- [ ] Feature support table updated with all working features (subquery, NEAR_FUSED, multi-hop MATCH, RETURN aggregation, ORDER BY in MATCH)
- [ ] Subquery documentation section added with syntax, examples, limitations
- [ ] NEAR_FUSED documentation section added with strategies
- [ ] EBNF grammar includes MATCH, temporal, subquery, NEAR_FUSED, ILIKE
- [ ] Spec date updated
- [ ] No markdown formatting errors

## Parallel Safety

**Exclusive write files:** `docs/VELESQL_SPEC.md`
**Shared read files:** none
**Conflicts with:** none
