---
phase: 5
plan: 1
name: VelesQL Spec & Feature Matrix Truth
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase 5 Plan 01: VelesQL Spec & Feature Matrix Truth

## Objective

Update `docs/VELESQL_SPEC.md` to accurately reflect the current state of VelesQL implementation. The spec still omits subquery docs, has incomplete EBNF grammar (missing MATCH, temporal, NEAR_FUSED, JOIN, compound queries), and needs `Database::execute_query()` documentation. Also update `FEATURE_TRUTH.md` for full consistency.

## Context

**Requirements addressed:** VP-008 (README accuracy audit)
**Phase goal contribution:** Ensures the VelesQL reference document matches reality ‚Äî developers consulting the spec get accurate information about what works, what's partial, and what's planned.

**‚ö†Ô∏è Post-Phase 8 revision (2026-02-09):**
- Phase 8 already updated VELESQL_SPEC.md feature table: JOIN (INNER, LEFT) ‚Üí ‚úÖ Stable, UNION/INTERSECT/EXCEPT ‚Üí ‚úÖ Stable, `/query/explain` ‚Üí routed
- FEATURE_TRUTH.md already updated post-Phase 8 for JOIN/compound/explain status
- `Database::execute_query()` is a new cross-collection executor that needs documentation in the spec

**Remaining issues in `docs/VELESQL_SPEC.md`:**
1. ~~Feature table says JOIN/UNION parse-only~~ ‚Üí ‚úÖ Already fixed by Phase 8
2. EBNF grammar section omits MATCH clause entirely
3. EBNF grammar omits temporal expressions (NOW(), INTERVAL)
4. EBNF grammar omits NEAR_FUSED syntax
5. No subquery documentation at all
6. EBNF grammar omits JOIN and compound query syntax (now that they execute)
7. Missing: ILIKE in EBNF grammar
8. No documentation for `Database::execute_query()` cross-collection execution model
9. RIGHT/FULL JOIN status needs documenting (parsed but returns UnsupportedFeature error)

## Tasks

### Task 1: Verify & Complete Feature Support Status Table

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Phase 8 already updated JOIN/UNION/INTERSECT/EXCEPT to ‚úÖ Stable. Verify those entries are correct, then add remaining missing features:
- Verify: `JOIN (INNER, LEFT)` shows `‚úÖ Stable` (Phase 8)
- Verify: `UNION / UNION ALL / INTERSECT / EXCEPT` shows `‚úÖ Stable` (Phase 8)
- Add `RIGHT/FULL JOIN` as `‚ö†Ô∏è Parsed, returns UnsupportedFeature error` if not already documented
- Add `Subqueries (scalar)` as `‚úÖ Stable | 2.1` (implemented in v4 Phase 2)
- Add `NEAR_FUSED multi-vector` as `‚úÖ Stable | 2.0`
- Add `Multi-hop MATCH patterns` as `‚úÖ Stable | 2.1` (implemented in v4 Phase 3)
- Add `RETURN aggregation in MATCH` as `‚úÖ Stable | 2.1` (implemented in v4 Phase 3)
- Add `ORDER BY property in MATCH` as `‚úÖ Stable | 2.1` (implemented in v4 Phase 1)
- Add `ILIKE (case-insensitive)` as `‚úÖ Stable | 1.0`
- Add `Database::execute_query()` cross-collection execution as `‚úÖ Stable | 2.1` (Phase 8)
- Verify "Table aliases" status ‚Äî confirm it's still üîú Planned
- Verify `JOIN ... USING (col)` documented as parse-only
- Update `Last Updated` date to current date

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "Subquer|NEAR_FUSED|Multi-hop|RETURN agg|JOIN|UNION"
```

**Done when:**
- Feature table has all currently-working features listed with correct status
- Phase 8 entries verified as present and accurate
- No working feature is listed as Planned or missing
- RIGHT/FULL JOIN limitation documented
- Date is updated

---

### Task 2: Add Subquery and NEAR_FUSED Documentation Sections

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Add new documentation sections for features currently undocumented in the spec:

1. **Subquery section** (after the IN/BETWEEN/LIKE sections):
   - Syntax: `(SELECT column FROM collection WHERE condition)`
   - Correlated subqueries: outer row reference resolution
   - Scalar subquery requirement (must return single value)
   - Example: `WHERE (SELECT price FROM inventory WHERE sku = product.sku) < 500`
   - Limitations: only scalar subqueries, no EXISTS/IN subqueries yet

2. **NEAR_FUSED section** (after the NEAR section):
   - Syntax: `WHERE vector NEAR_FUSED [$v1, $v2] USING FUSION 'strategy'`
   - Multi-vector fusion search
   - Available strategies: rrf, average, maximum, weighted
   - Examples from README Scenario 0b

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "Subquer|NEAR_FUSED"
```

**Done when:**
- Subquery syntax, examples, and limitations are documented
- NEAR_FUSED syntax and strategies are documented
- Both sections include practical examples

---

### Task 3: Update EBNF Grammar to Include MATCH, Temporal, Subqueries, JOIN, Compound

**Files:** `docs/VELESQL_SPEC.md`

**Action:**
Extend the EBNF grammar (lines 694-786) to include the missing productions:

1. **MATCH clause**:
   ```ebnf
   match_stmt = "MATCH" pattern_list [where_clause] "RETURN" return_list
                [order_by_clause] [limit_clause] ;
   pattern_list = pattern { "," pattern } ;
   pattern = node_pattern { relationship_pattern node_pattern } ;
   node_pattern = "(" [identifier] [":" identifier] [property_map] ")" ;
   relationship_pattern = "-[" [identifier] [":" identifier] [var_length] "]->"
                        | "<-[" [identifier] [":" identifier] [var_length] "]-"
                        | "-[" [identifier] [":" identifier] [var_length] "]-" ;
   var_length = "*" integer ".." integer ;
   property_map = "{" identifier ":" value { "," identifier ":" value } "}" ;
   return_list = return_item { "," return_item } ;
   return_item = (column | aggregate_func) ["AS" identifier] ;
   ```

2. **Temporal expressions**:
   ```ebnf
   temporal_expr = "NOW" "(" ")" [("-" | "+") interval_expr] ;
   interval_expr = "INTERVAL" string ;
   ```
   Add `temporal_expr` as a valid value/comparison operand.

3. **Subquery**:
   ```ebnf
   subquery = "(" select_stmt ")" ;
   ```
   Add `subquery` as a valid value type in comparisons.

4. **NEAR_FUSED**:
   ```ebnf
   fused_search = identifier "NEAR_FUSED" "[" vector_expr { "," vector_expr } "]" ;
   ```

5. **ILIKE**:
   Add `"ILIKE"` alongside `"LIKE"` in `like_cond`.

6. **JOIN clause** (new ‚Äî Phase 8 execution):
   ```ebnf
   join_clause = join_type "JOIN" identifier ["AS" identifier] "ON" join_condition ;
   join_type = ["INNER" | "LEFT" | "RIGHT" | "FULL"] ;
   join_condition = column "=" column ;
   ```

7. **Compound queries** (new ‚Äî Phase 8 execution):
   ```ebnf
   compound_query = select_stmt set_operator select_stmt { set_operator select_stmt } ;
   set_operator = "UNION" ["ALL"] | "INTERSECT" | "EXCEPT" ;
   ```

**Verify:**
```powershell
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "match_stmt|temporal_expr|subquery|fused_search|ILIKE|join_clause|compound_query"
```

**Done when:**
- EBNF grammar includes MATCH clause productions
- Temporal expressions (NOW/INTERVAL) in grammar
- Subquery as valid value type in grammar
- NEAR_FUSED in grammar
- ILIKE alongside LIKE
- JOIN clause in grammar (INNER, LEFT supported; RIGHT/FULL parsed)
- Compound query syntax in grammar (UNION, UNION ALL, INTERSECT, EXCEPT)
- Grammar compiles conceptually (no contradictions)

---

---

### Task 4: Cross-Reference FEATURE_TRUTH.md Consistency

**Files:** `FEATURE_TRUTH.md` (in phase dir)

**Action:**
Verify FEATURE_TRUTH.md (already updated post-Phase 8) is fully consistent with VELESQL_SPEC.md after Task 1-3 changes:
- All status columns match between both documents
- `Database::execute_query()` documented in both
- RIGHT/FULL JOIN caveat consistent
- JOIN USING parse-only consistent
- No contradictions between FEATURE_TRUTH.md and VELESQL_SPEC.md

**Verify:**
```powershell
Select-String -Path ".planning/phases/v4-05-readme-documentation-truth/FEATURE_TRUTH.md" -Pattern "Parse-only|Caveat|Works"
```

**Done when:**
- FEATURE_TRUTH.md and VELESQL_SPEC.md are fully aligned
- No contradictions exist between the two reference documents

---

## Verification

After all tasks complete:

```powershell
# Verify no broken markdown
# Check that feature table has all items
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "‚úÖ Stable" | Measure-Object
# Should show increased count

# Check new sections exist
Select-String -Path "docs/VELESQL_SPEC.md" -Pattern "## Subquer|## NEAR_FUSED|match_stmt|temporal_expr|join_clause|compound_query"
```

## Success Criteria

- [ ] Feature support table verified (Phase 8 entries present) + new features added (subquery, NEAR_FUSED, multi-hop MATCH, RETURN aggregation, ORDER BY in MATCH)
- [ ] RIGHT/FULL JOIN ‚Üí UnsupportedFeature documented
- [ ] `Database::execute_query()` cross-collection execution model documented
- [ ] Subquery documentation section added with syntax, examples, limitations
- [ ] NEAR_FUSED documentation section added with strategies
- [ ] EBNF grammar includes MATCH, temporal, subquery, NEAR_FUSED, ILIKE, JOIN, compound queries
- [ ] FEATURE_TRUTH.md consistent with VELESQL_SPEC.md
- [ ] Spec date updated
- [ ] No markdown formatting errors

## Parallel Safety

**Exclusive write files:** `docs/VELESQL_SPEC.md`, `.planning/phases/v4-05-readme-documentation-truth/FEATURE_TRUTH.md`
**Shared read files:** none
**Conflicts with:** none
