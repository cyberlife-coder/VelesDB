---
phase: 7
plan: 1
name: Widen SIMD Property Test Tolerances
wave: 1
depends_on: none
autonomous: true
---

# Phase 7 Plan 1: Widen SIMD Property Test Tolerances

## Objective

Eliminate the two flaky property-based SIMD tests (`test_dot_product_native_matches_scalar` and `test_jaccard_similarity_native_matches_scalar`) by widening their tolerance envelopes to account for FMA/multi-accumulator floating-point non-associativity. Each widening must be justified with a `// Reason:` comment.

## Context

**Requirements addressed:** TEST-08
**Phase goal contribution:** Eliminates CI flakiness that erodes confidence in the test suite

### Root Cause Analysis

**Dot product failure** (len=511, random values in [-100, 100]):
- SIMD uses 4-accumulator FMA (avx2_4acc for len >= 256) which sums partial products in a different order than scalar's sequential `.sum()`
- With large random vectors, intermediate partial sums can reach ~50,000+ magnitude
- FMA reordering produces different rounding at each step
- Observed delta: ~0.016 vs allowed: 0.005
- Current tolerance: `abs=5.0e-3, rel=7.0e-4`

**Jaccard failure** (len=1509, random values in [-100, 100]):
- SIMD AVX2 reduces min/max in parallel lanes then horizontal-sums
- Scalar folds sequentially, producing slightly different rounding
- Observed delta: ~2.03e-6 vs allowed: ~2.0e-6 (barely exceeds)
- Current tolerance: `abs=2.0e-6, rel=2.0e-6`

### Tolerance Design Principles

The formula used is: `allowed = max(abs_tolerance, rel_tolerance * |expected|.max(1.0))`

For dot product with 4-acc FMA on random [-100, 100] vectors:
- Error grows as O(sqrt(N)) * machine_epsilon * max_partial_sum_magnitude
- For N=1536, max_magnitude ~100: worst-case ~sqrt(1536) * 1.2e-7 * 10000 ≈ 0.047
- Conservative envelope: `abs=5.0e-2, rel=5.0e-3`

For jaccard with AVX2 parallel min/max:
- Error is bounded by the number of horizontal reduction steps
- For N=1536 with 8-wide lanes: ~192 reductions, each with ~1 ULP error
- Conservative envelope: `abs=1.0e-5, rel=1.0e-5`

## Tasks

### Task 1: Widen DOT_TOLERANCE with justification

**Files:** `crates/velesdb-core/tests/simd_property_tests.rs`

**Action:**
Change `DOT_TOLERANCE` from `{abs: 5.0e-3, rel: 7.0e-4}` to `{abs: 5.0e-2, rel: 5.0e-3}`.

Add a `// Reason:` comment above explaining:
- FMA multi-accumulator (4-acc for len >= 256) reorders partial sums
- With random values in [-100, 100] and N up to 1536, intermediate sums diverge
- Error scales as O(sqrt(N) * epsilon * max_magnitude²)
- The 10× widening covers the worst case observed (delta=0.016) with margin

**Verify:**
```powershell
cargo test --package velesdb-core --test simd_property_tests test_dot_product_native_matches_scalar -- --nocapture 2>&1
```

**Done when:**
- `DOT_TOLERANCE` updated with `// Reason:` comment
- Test passes consistently

---

### Task 2: Widen JACCARD_TOLERANCE with justification

**Files:** `crates/velesdb-core/tests/simd_property_tests.rs`

**Action:**
Change `JACCARD_TOLERANCE` from `{abs: 2.0e-6, rel: 2.0e-6}` to `{abs: 1.0e-5, rel: 1.0e-5}`.

Add a `// Reason:` comment above explaining:
- AVX2 jaccard uses parallel min/max across 8 lanes then horizontal-reduces
- Scalar folds sequentially, producing different rounding at each step
- For N up to 1536 with 8-wide lanes, ~192 horizontal reductions each with ~1 ULP error
- The 5× widening covers the worst case observed (delta=2.03e-6) with margin

**Verify:**
```powershell
cargo test --package velesdb-core --test simd_property_tests test_jaccard_similarity_native_matches_scalar -- --nocapture 2>&1
```

**Done when:**
- `JACCARD_TOLERANCE` updated with `// Reason:` comment
- Test passes consistently

---

### Task 3: Stability verification — 10 consecutive runs

**Files:** None (verification only)

**Action:**
Run the full proptest suite 10 times in a loop to confirm zero flaky failures.

**Verify:**
```powershell
for ($i = 1; $i -le 10; $i++) { Write-Host "Run $i"; cargo test --package velesdb-core --test simd_property_tests 2>&1 | Select-String "test result" }
```

**Done when:**
- 10/10 runs show `test result: ok` with 0 failures
- No regressions in other proptest cases (L2, euclidean, cosine, hamming)

---

## Verification

After all tasks complete:

```powershell
# Full test suite
cargo test --package velesdb-core --test simd_property_tests

# Clippy clean
cargo clippy --package velesdb-core -- -D warnings

# Existing SIMD unit tests still pass
cargo test --package velesdb-core simd_native -- --nocapture 2>&1 | Select-String "test result"
```

## Success Criteria

- [ ] `DOT_TOLERANCE` widened to `{abs: 5.0e-2, rel: 5.0e-3}` with `// Reason:` comment
- [ ] `JACCARD_TOLERANCE` widened to `{abs: 1.0e-5, rel: 1.0e-5}` with `// Reason:` comment
- [ ] Both flaky tests pass 10/10 consecutive runs
- [ ] No regressions in other proptest cases
- [ ] `cargo clippy -- -D warnings` clean

## Output

**Files modified:**
- `crates/velesdb-core/tests/simd_property_tests.rs` — Tolerance constants widened with justification comments
