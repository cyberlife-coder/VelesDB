---
phase: 7
plan: 2
name: Wire DistanceEngine into HNSW Hot Loop
wave: 1
depends_on: ["07-01"]
autonomous: true
---

# Phase 7 Plan 2: Wire DistanceEngine into HNSW Hot Loop

## Objective

Replace the per-call `match self.metric` + `match simd_level()` dispatch chain in HNSW distance calculations with a `CachedSimdDistance` struct that resolves the optimal SIMD kernel once at construction time. This eliminates ~6 branch comparisons per distance call in `search_layer`, `search_layer_single`, `select_neighbors`, and `insert`.

## Context

**Requirements addressed:** PERF-04
**Phase goal contribution:** ~5-15% search latency improvement on the HNSW hot path

### Current Architecture (2 levels of dispatch per call)

```
SimdDistance::distance(a, b)
  └─ match self.metric          ← Branch #1: Cosine/Euclidean/DotProduct/Hamming/Jaccard
       └─ cosine_similarity_native(a, b)
            └─ match simd_level()    ← Branch #2: AVX512/AVX2/NEON/Scalar (OnceLock)
                 └─ match a.len()    ← Branch #3: 4acc/2acc/1acc/scalar by dimension
```

### Target Architecture (single indirect call)

```
CachedSimdDistance::distance(a, b)
  └─ match self.metric          ← Branch #1 only (metric still needed for sign transform)
       └─ self.engine.cosine_similarity(a, b)
            └─ (self.cosine_fn)(a, b)  ← Direct fn pointer, zero branches
```

### Why not eliminate Branch #1?

The metric transforms (`1.0 - cosine`, `-dot_product`, passthrough for euclidean/hamming/jaccard`) prevent a single fn pointer from covering all metrics without closures. Closures cannot be coerced to `fn` pointers when they capture state. The metric match is a single predictable branch (typically always Cosine), so branch prediction handles it well.

### Key Files from Research

| File | Role | Distance calls |
|------|------|----------------|
| `distance.rs:79-110` | `SimdDistance` impl — current per-call dispatch | `distance()`, `batch_distance()` |
| `graph/search.rs:90-118` | `search_layer_single` — greedy descent | `self.distance.distance()` in tight loop |
| `graph/search.rs:120-201` | `search_layer` — ef-bounded BFS | `self.distance.distance()` per candidate |
| `graph/insert.rs:10-67` | `insert` — calls search_layer + select_neighbors | Indirect via search |
| `graph/neighbors.rs:8-57` | `select_neighbors` — VAMANA diversification | `self.distance.distance()` per candidate pair |
| `dispatch.rs:413-606` | `simd_native::DistanceEngine` — cached fn pointers | dot_product, squared_l2, cosine |

## Tasks

### Task 1: Create `CachedSimdDistance` struct

**Files:** `crates/velesdb-core/src/index/hnsw/native/distance.rs`

**Action:**
Add a new `CachedSimdDistance` struct below the existing `AdaptiveSimdDistance`:

```rust
/// SIMD distance with dimension-cached kernel resolution.
///
/// Uses `simd_native::DistanceEngine` to resolve the optimal SIMD kernel
/// (4-acc/2-acc/1-acc/scalar) once at construction for the given dimension,
/// eliminating per-call dimension-threshold branching in the HNSW hot loop.
///
/// For Cosine, Euclidean, and DotProduct metrics, this saves ~2-4 branch
/// comparisons per distance call vs `SimdDistance`.
/// Hamming and Jaccard fall back to `simd_native::*_native()` dispatch.
pub struct CachedSimdDistance {
    metric: DistanceMetric,
    engine: crate::simd_native::DistanceEngine,
}
```

Implement `CachedSimdDistance::new(metric, dimension)` and the `DistanceEngine` trait:
- **Cosine**: `1.0 - self.engine.cosine_similarity(a, b)`
- **Euclidean**: `self.engine.euclidean(a, b)`
- **DotProduct**: `-self.engine.dot_product(a, b)`
- **Hamming**: `crate::simd_native::hamming_distance_native(a, b)` (fallback — rare metric for HNSW)
- **Jaccard**: `1.0 - crate::simd_native::jaccard_similarity_native(a, b)` (fallback — rare metric)

For `batch_distance`, use prefetch optimization similar to `SimdDistance::batch_distance` but call through `self.engine.*` for the 3 main metrics.

**Verify:**
```powershell
cargo check --package velesdb-core
```

**Done when:**
- `CachedSimdDistance` compiles and implements `DistanceEngine` trait
- Re-exported in `mod.rs` as `pub use distance::CachedSimdDistance`

---

### Task 2: Add unit tests for `CachedSimdDistance`

**Files:** `crates/velesdb-core/src/index/hnsw/native/distance_tests.rs`

**Action:**
Add tests verifying `CachedSimdDistance` produces identical results to `SimdDistance` for all 5 metrics:

1. `test_cached_vs_simd_cosine` — compare distance values for 768d vectors
2. `test_cached_vs_simd_euclidean` — compare for 128d vectors
3. `test_cached_vs_simd_dot_product` — compare for 1536d vectors
4. `test_cached_vs_simd_hamming` — compare for 64d binary vectors
5. `test_cached_vs_simd_jaccard` — compare for 256d set vectors
6. `test_cached_batch_distance` — verify batch_distance matches per-item distance

Each test should:
- Create both `SimdDistance::new(metric)` and `CachedSimdDistance::new(metric, dim)`
- Compute distance on same vectors
- Assert exact equality (same code path, same result)

**Verify:**
```powershell
cargo test --package velesdb-core cached_vs_simd -- --nocapture
```

**Done when:**
- All 6 tests pass
- Results are identical (not just close — same fn pointers for same dimension)

---

### Task 3: Wire `CachedSimdDistance` into `NativeHnswIndex`

**Files:** `crates/velesdb-core/src/index/hnsw/native/backend_adapter.rs`

**Action:**
Find where `NativeHnsw<SimdDistance>` is constructed in the backend adapter. The `NativeHnswBackend` creates the HNSW index — update it to use `CachedSimdDistance` instead of `SimdDistance` when the dimension is known.

Key consideration: `NativeHnsw<D>` is generic over `D: DistanceEngine`. The type parameter changes from `SimdDistance` to `CachedSimdDistance`. Check all call sites in `backend_adapter.rs` and update the type.

If dimension is not known at construction time (lazy initialization), keep `SimdDistance` as the default and document the limitation. The `CachedSimdDistance` requires dimension at construction.

**Verify:**
```powershell
cargo check --package velesdb-core
cargo test --package velesdb-core hnsw -- --nocapture 2>&1 | Select-String "test result"
```

**Done when:**
- `NativeHnswBackend` uses `CachedSimdDistance` where dimension is available
- All existing HNSW tests pass unchanged
- No compile errors

---

### Task 4: Benchmark before/after

**Files:** None (verification only)

**Action:**
Run HNSW benchmarks to measure the improvement:

```powershell
# Baseline (before changes — already captured in Phase 5)
# After changes:
cargo bench --package velesdb-core --bench hnsw_benchmark 2>&1 | Select-String "time:"
```

If no dedicated HNSW benchmark exists, create a quick ad-hoc test in `distance_tests.rs`:
- Insert 10,000 random 768d vectors
- Search 100 queries with ef=128, k=10
- Measure total search time
- Compare `SimdDistance` vs `CachedSimdDistance`

**Verify:**
```powershell
cargo test --package velesdb-core cached_benchmark -- --nocapture --ignored
```

**Done when:**
- Performance measured and documented
- No regression (expect ~5-15% improvement on search)
- Results noted in commit message

---

## Verification

After all tasks complete:

```powershell
# Full test suite
cargo test --package velesdb-core -- --nocapture 2>&1 | Select-String "test result"

# Clippy clean
cargo clippy --package velesdb-core -- -D warnings

# Existing HNSW tests pass
cargo test --package velesdb-core hnsw -- --nocapture 2>&1 | Select-String "test result"

# Property tests pass (from Plan 07-01)
cargo test --package velesdb-core --test simd_property_tests
```

## Success Criteria

- [ ] `CachedSimdDistance` struct created with `DistanceEngine` trait impl
- [ ] 6 unit tests verify parity with `SimdDistance`
- [ ] `NativeHnswBackend` wired to use `CachedSimdDistance`
- [ ] All existing HNSW tests pass (no regressions)
- [ ] Benchmark shows no regression (improvement expected)
- [ ] `cargo clippy -- -D warnings` clean

## Output

**Files created:**
- None (tests added to existing test file)

**Files modified:**
- `crates/velesdb-core/src/index/hnsw/native/distance.rs` — `CachedSimdDistance` struct added
- `crates/velesdb-core/src/index/hnsw/native/mod.rs` — Re-export `CachedSimdDistance`
- `crates/velesdb-core/src/index/hnsw/native/distance_tests.rs` — 6 new tests
- `crates/velesdb-core/src/index/hnsw/native/backend_adapter.rs` — Use `CachedSimdDistance`
