---
phase: 01-foundation-fixes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/storage/mmap.rs
  - crates/velesdb-core/src/index/hnsw/native/graph.rs
  - crates/velesdb-core/src/agent/procedural_memory.rs
  - crates/velesdb-core/src/agent/snapshot.rs
  - crates/velesdb-core/src/collection/query_cost/cost_model.rs
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/collection/**/*.rs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "All numeric conversions use try_from() instead of as casts on user-provided data"
    - "cargo clippy --workspace -- -D warnings exits with code 0"
  artifacts:
    - path: "crates/velesdb-core/src/storage/mmap.rs"
      provides: "Safe numeric conversions with try_from()"
      pattern: "u32::try_from(.*)\\?|#[allow.*SAFETY"
    - path: "crates/velesdb-core/src/index/hnsw/native/graph.rs"
      provides: "Bounds-checked arithmetic"
      pattern: "usize::try_from|#[allow.*SAFETY"
    - path: "crates/velesdb-core/src/agent/procedural_memory.rs"
      provides: "Safe agent memory cast operations"
    - path: "crates/velesdb-core/src/agent/snapshot.rs"
      provides: "Safe snapshot serialization"
  key_links:
    - from: "storage/mmap.rs"
      to: "u32::try_from"
      via: "conversion with error handling"
      pattern: "try_from.*map_err"
    - from: "hnsw/graph.rs"
      to: "usize::try_from"
      via: "index calculation bounds check"
      pattern: "try_from.*context"
    - from: "agent/procedural_memory.rs"
      to: "Error::Overflow"
      via: "cast error handling"
      pattern: "map_err.*Overflow"
---

## Gap Closure Plan: Fix Clippy Cast Errors

### Gap Addressed

- **Gap 1: 55 clippy cast errors (Critical)** — Replace `as` casts with `try_from()` or add `#[allow]` with SAFETY justification
- **Gap 2: CI gates fail (Critical)** — `cargo clippy --workspace -- -D warnings` must pass

### Objective

Eliminate all 55 clippy cast-related errors to enable zero-warning builds and pass CI quality gates.

**Purpose:** Enable CI pipeline with strict clippy enforcement (-D warnings) and eliminate numeric conversion overflow risks.

**Output:** Codebase with zero clippy cast warnings and proper error handling for numeric conversions.

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-foundation-fixes/01-foundation-fixes-VERIFICATION.md

Prior plans:
- @.planning/phases/01-foundation-fixes/01-01-SUMMARY.md — Numeric Cast Audit
- @.planning/phases/01-foundation-fixes/01-02-SUMMARY.md — Clippy Configuration Cleanup

Key files with cast issues:
- @crates/velesdb-core/src/storage/mmap.rs (lines 437, 521, 531)
- @crates/velesdb-core/src/index/hnsw/native/graph.rs (lines 63, 104, 335, 397, 401)
- @crates/velesdb-core/src/agent/procedural_memory.rs (3 errors)
- @crates/velesdb-core/src/agent/snapshot.rs (5 errors)

Error types to fix:
- `cast_possible_truncation` (~20 errors)
- `cast_precision_loss` (~15 errors)
- `cast_sign_loss` (~7 errors)
- `cast_possible_wrap` (~5 errors)
- `non_send_fields_in_send_ty` (1 error)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix high-priority files (mmap.rs, graph.rs)</name>
  <files>
    crates/velesdb-core/src/storage/mmap.rs
    crates/velesdb-core/src/index/hnsw/native/graph.rs
  </files>
  <action>
Fix all `as` casts in storage/mmap.rs and index/hnsw/native/graph.rs by either:
1. Replacing with try_from() + proper error handling:
   - Change `vector_bytes.len() as u32` to `u32::try_from(vector_bytes.len()).map_err(|_| Error::Overflow)?`
   - Change `vectors.len() as u32` to `u32::try_from(vectors.len()).map_err(|_| Error::Overflow)?`
   - Change `.floor() as usize` to `usize::try_from(x.floor() as u64).map_err(...)?`

2. Or add #[allow] with SAFETY justification for intentional casts:
   - Use pattern: `#[allow(clippy::cast_possible_truncation)] // SAFETY: value clamped to [min, max] before cast`
   - Add comment explaining why cast is safe

For mmap.rs:437, 521, 531:
- These are length conversions for vector storage
- Use try_from() with Error::Overflow

For graph.rs:63, 104, 335, 397, 401:
- These are index calculations and neighbor lookups
- Use try_from() or clamp-then-cast with SAFETY justification

Run `cargo clippy --workspace 2>&1 | head -100` to see specific errors after changes.
  </action>
  <verify>
    cargo clippy --workspace -- -D warnings 2>&1 | grep -E "mmap\.rs|graph\.rs" | wc -l
    # Should return 0 errors from these files
  </verify>
  <done>
    - mmap.rs compiles with zero clippy cast warnings
    - graph.rs compiles with zero clippy cast warnings
    - All try_from() calls have proper error handling with Error::Overflow
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix agent modules (procedural_memory.rs, snapshot.rs)</name>
  <files>
    crates/velesdb-core/src/agent/procedural_memory.rs
    crates/velesdb-core/src/agent/snapshot.rs
  </files>
  <action>
Fix 3 errors in procedural_memory.rs and 5 errors in snapshot.rs:

procedural_memory.rs:204:
- Current: `as_f64()? as f32` - truncating cast
- Fix: Use `as_f64()?.clamp(f32::MIN as f64, f32::MAX as f64) as f32` with SAFETY comment
- Or use try_from if converting to specific precision

snapshot.rs:225:
- Current: `read_u64(...) as usize` - truncation risk
- Fix: `usize::try_from(read_u64(...)).map_err(|_| Error::Overflow)?`

Other agent module errors:
- Audit each cast error with `cargo clippy 2>&1 | grep -E "procedural_memory|snapshot"`
- Apply try_from() pattern for user-provided data
- Apply #[allow] with SAFETY justification for internal calculations where bounds are proven

Follow the Error::Overflow pattern established in RUST-01 implementation.
  </action>
  <verify>
    cargo clippy --workspace -- -D warnings 2>&1 | grep -E "procedural_memory|snapshot" | wc -l
    # Should return 0 errors from these files
  </verify>
  <done>
    - procedural_memory.rs compiles with zero clippy cast warnings
    - snapshot.rs compiles with zero clippy cast warnings
    - All f32/f64 conversions use clamp-then-cast with SAFETY justification
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix collection modules and remaining errors</name>
  <files>
    crates/velesdb-core/src/collection/query_cost/cost_model.rs
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/collection/**/*.rs
  </files>
  <action>
Fix remaining 20+ errors in collection modules and other files:

collection/query_cost/cost_model.rs:154:
- Current: `(value as f64) as u64` - sign loss
- Fix: Use `u64::try_from(value).map_err(...)` or `value.max(0.0) as u64` with SAFETY comment

simd_native.rs:45:
- Current: `hamming_distance(...) as u32` - truncation
- Fix: If distance is guaranteed to fit in u32 (e.g., dimension <= u32::MAX), use:
  `#[allow(clippy::cast_possible_truncation)] // SAFETY: distance <= dimension <= u32::MAX`

Remaining collection module errors:
- Run `cargo clippy --workspace 2>&1 | grep -E "collection.*\.rs"`
- Apply try_from() for user-provided data (dimensions, offsets, sizes)
- Apply #[allow] + SAFETY for internal calculations with proven bounds

For non_send_fields_in_send_ty error:
- This is usually related to raw pointers in Send impls
- Add SAFETY comment explaining why Send is safe: `// SAFETY: Raw pointer only accessed with external synchronization`

Address all 55 errors systematically until:
  cargo clippy --workspace -- -D warnings
returns exit code 0.
  </action>
  <verify>
    cargo clippy --workspace -- -D warnings
    # Must return exit code 0 (no errors)
    echo $?
  </verify>
  <done>
    - cargo clippy --workspace -- -D warnings exits with code 0
    - All 55 cast-related errors fixed
    - No new warnings introduced
  </done>
</task>

</tasks>

<verification>

### Pre-execution verification
1. Run `cargo clippy --workspace -- -D warnings 2>&1 | tail -20` to capture current error count
2. Document the 55 errors by category (truncation, precision loss, sign loss, wrap)

### Per-task verification
- After Task 1: `cargo clippy 2>&1 | grep -c "mmap\.rs\|graph\.rs"` should be 0
- After Task 2: `cargo clippy 2>&1 | grep -c "procedural_memory\|snapshot"` should be 0
- After Task 3: `cargo clippy --workspace -- -D warnings` exits 0

### Post-execution verification
1. Full clippy check: `cargo clippy --workspace -- -D warnings`
2. Build check: `cargo build --workspace`
3. Test check: `cargo test --workspace` (ensure no regressions)

</verification>

<success_criteria>

1. **Zero cast warnings:** `cargo clippy --workspace -- -D warnings` exits with code 0
2. **All files fixed:** mmap.rs, graph.rs, procedural_memory.rs, snapshot.rs, collection modules have no cast warnings
3. **Proper error handling:** All user-provided data conversions use try_from() with Error::Overflow
4. **SAFETY comments:** Any remaining #[allow] attributes have SAFETY-style justification
5. **No regressions:** All existing tests continue to pass

</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-04-SUMMARY.md`

Summary must document:
- Number of cast errors fixed (55 target)
- Files modified and specific changes
- Pattern used (try_from() vs #[allow] + SAFETY)
- Verification that clippy -D warnings passes
</output>
