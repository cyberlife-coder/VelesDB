---
phase: 01-foundation-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/lib.rs
  - crates/velesdb-core/src/**/*.rs
  - crates/velesdb-core/src/**/**/*.rs
autonomous: true
must_haves:
  truths:
    - All numeric conversions use try_from() instead of as casts on user-provided data
    - Safe casts have explicit #[allow] with justification comments
    - No silent truncation occurs during numeric conversions
    - All bounds-checked arithmetic has explanatory comments
  artifacts:
    - path: crates/velesdb-core/src/lib.rs
      provides: Numeric conversions updated with try_from()
    - path: crates/velesdb-core/src/storage/mmap.rs
      provides: Safe numeric conversions in storage layer
    - path: crates/velesdb-core/src/index/hnsw/native/graph.rs
      provides: Bounds-checked arithmetic in performance-critical code
  key_links:
    - from: User input vectors
      to: Vector storage
      via: try_from() conversions
      pattern: "u32::try_from\(index\)"
    - from: Index calculations
      to: Memory offsets
      via: Bounds-checked arithmetic
      pattern: "\.map_err\(|Error::Overflow\)?"
---

<objective>
Audit and replace all unsafe `as` numeric casts with `try_from()` conversions or explicit bounds checks with justification comments.

Purpose: Eliminate silent truncation and overflow risks that could cause data corruption or undefined behavior in the vector database engine.
Output: Zero unsafe numeric conversions; all casts use `try_from()` or have explicit bounds checking with explanatory comments.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

# Target file for audit
@crates/velesdb-core/src/lib.rs

# High-risk files mentioned in STATE.md
@crates/velesdb-core/src/storage/mmap.rs
@crates/velesdb-core/src/index/hnsw/native/graph.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit All Numeric Cast Sites</name>
  <files>crates/velesdb-core/src/lib.rs, crates/velesdb-core/src/**/*.rs</files>
  <action>
Find all `as` cast operations in the codebase using grep:
```bash
grep -rn " as " crates/velesdb-core/src/ --include="*.rs" | grep -v "//" | grep -v "expect"
```

Categorize each cast:
1. **User-provided data** (vectors, indices, sizes): MUST use `try_from()`
2. **Internal calculations** (array indices, offsets): Use `try_from()` or explicit bounds check
3. **Safe constants** (literal values like `0u32 as usize`): Can keep with `#[allow]` justification

Document each location with:
- File path and line number
- Current cast expression
- Required fix type (try_from / bounds_check / allow_justified)
- Risk level (High/Medium/Low)

Create an audit report in: `.planning/phases/01-foundation-fixes/01-01-audit-report.md`
  </action>
  <verify>
Audit report exists with complete list of all `as` casts found
Report categorizes each cast by fix type and risk level
  </verify>
  <done>Complete audit report created with all 50+ cast sites identified and categorized</done>
</task>

<task type="auto">
  <name>Task 2: Replace User-Data Casts with try_from()</name>
  <files>crates/velesdb-core/src/lib.rs, crates/velesdb-core/src/storage/mmap.rs, crates/velesdb-core/src/index/hnsw/native/graph.rs</files>
  <action>
For all casts identified as "user-provided data" in the audit:

1. Replace `index as u32` with `u32::try_from(index)?` or `.map_err(|_| Error::Overflow)?`
2. Replace `size as usize` with `usize::try_from(size)?` for user-provided sizes
3. Replace vector dimension casts: `dim as u32` -> `u32::try_from(dim)?`

Pattern for replacement:
```rust
// ❌ BEFORE - Silent truncation risk
let id = index as u32;

// ✅ AFTER - Explicit error handling
let id = u32::try_from(index).map_err(|_| Error::Overflow)?;
```

For internal calculations that can't fail due to prior bounds:
```rust
// ✅ WITH JUSTIFICATION
#[allow(clippy::cast_possible_truncation)]
// Reason: value clamped to [0.0, 1.0] before cast via clamp()
let percent = (value.clamp(0.0, 1.0) * 100.0) as u32;
```

Start with high-risk files: lib.rs, mmap.rs, graph.rs
Then proceed to remaining files based on audit report priority.
  </action>
  <verify>
```bash
cargo build --workspace 2>&1 | grep -i "error" | wc -l
# Should be 0
cargo clippy --workspace 2>&1 | grep "as casts" | wc -l
# Should show reduced count
```
  </verify>
  <done>All user-data casts replaced with try_from(); build passes with zero errors</done>
</task>

<task type="auto">
  <name>Task 3: Add Unit Tests for Bounds Checking</name>
  <files>crates/velesdb-core/tests/numeric_casts.rs</files>
  <action>
Create comprehensive unit tests for numeric conversion boundaries:

```rust
// tests/numeric_casts.rs
#[test]
fn test_u32_try_from_usize_overflow() {
    let large: usize = u32::MAX as usize + 1;
    assert!(u32::try_from(large).is_err());
}

#[test]
fn test_u32_try_from_usize_valid() {
    let valid: usize = 1000;
    assert_eq!(u32::try_from(valid).unwrap(), 1000);
}

#[test]
fn test_vector_dimension_bounds() {
    // Test that oversized dimensions are rejected
    let oversized_dim: usize = u32::MAX as usize + 1;
    // Should return Overflow error
}
```

Add tests for each conversion type found in Task 1:
- usize -> u32 conversions
- u64 -> usize conversions  
- f64 -> u32 conversions (with clamping)
- Vector dimension validation
- Index boundary checks

Tests should verify:
1. Valid values convert correctly
2. Boundary values (MAX, MAX-1) work
3. Overflow values return proper errors
4. Negative values (if applicable) are rejected
  </action>
  <verify>
```bash
cargo test --workspace numeric_casts
# All tests pass
```
  </verify>
  <done>Unit tests created and passing; covers all boundary conditions for numeric conversions</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run full build: `cargo build --workspace`
2. Run clippy: `cargo clippy -- -D warnings`
3. Run all tests: `cargo test --workspace`
4. Verify audit report shows zero remaining user-data `as` casts
5. Check that all `#[allow(clippy::cast_*)]` have justification comments

Success indicators:
- Zero compiler errors
- Zero clippy warnings about casts
- All new unit tests passing
- Documentation updated if public API changed (shouldn't for this phase)
</verification>

<success_criteria>
- All `as` casts on user-provided data replaced with `try_from()`
- Remaining safe casts have explicit `#[allow]` with justification
- Unit tests verify boundary conditions
- CI gates pass: `cargo build`, `cargo clippy`, `cargo test`
- Audit report confirms compliance with RUST-01 and BUG-01
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-01-SUMMARY.md` with:
- List of all files modified
- Number of casts replaced
- Number of casts justified with comments
- Test coverage metrics
- Any edge cases or decisions made
</output>
