---
phase: 01-foundation-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/lib.rs
  - .clippy.toml
  - crates/velesdb-core/src/**/*.rs
autonomous: true
must_haves:
  truths:
    - Global #[allow] attributes removed from lib.rs
    - All clippy warnings addressed with targeted fixes
    - Remaining allows are function-level with SAFETY-style justification
    - Clippy configuration follows project standards
  artifacts:
    - path: crates/velesdb-core/src/lib.rs
      provides: Clean lib.rs without global clippy allows (lines 61-65 removed)
    - path: .clippy.toml
      provides: Updated clippy configuration if needed
  key_links:
    - from: Clippy configuration
      to: Source code compliance
      via: Targeted #[allow] with justification
      pattern: "#\[allow\([^)]+\)\]\s*//"
---

<objective>
Remove global `#[allow]` clippy attributes from lib.rs and replace with targeted, justified allows at the function level.

Purpose: Eliminate blanket suppression of lint warnings that may mask real bugs; enforce explicit justification for any allowed warnings.
Output: lib.rs with zero global allows; all clippy warnings either fixed or explicitly allowed with SAFETY-style justification comments.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

# Target file
@crates/velesdb-core/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify and Document Global Allows</name>
  <files>crates/velesdb-core/src/lib.rs</files>
  <action>
Locate and document all global `#[allow]` attributes in lib.rs, specifically around lines 61-65 as identified in REQUIREMENTS.md.

```bash
grep -n "#\[allow" crates/velesdb-core/src/lib.rs | head -20
```

For each global allow found, document:
1. The exact attribute text
2. Line number
3. What warning it's suppressing
4. Why it was added (if discernible from code/context)

Common global allows to look for:
- `#![allow(clippy::cast_possible_truncation)]`
- `#![allow(clippy::cast_sign_loss)]`
- `#![allow(clippy::cast_precision_loss)]`
- `#![allow(clippy::module_name_repetitions)]`
- `#![allow(dead_code)]`

Create documentation: `.planning/phases/01-foundation-fixes/01-02-allows-inventory.md`
  </action>
  <verify>
Inventory document exists with complete list of global allows
Each allow has line number and suppression reason documented
  </verify>
  <done>Complete inventory of all global #[allow] attributes documented</done>
</task>

<task type="auto">
  <name>Task 2: Remove Global Allows and Trigger Warnings</name>
  <files>crates/velesdb-core/src/lib.rs</files>
  <action>
1. Remove all global `#![allow(...)]` attributes from lib.rs
2. Run clippy to see what warnings actually trigger:
   ```bash
   cargo clippy --workspace 2>&1 | tee .planning/phases/01-foundation-fixes/01-02-clippy-warnings.log
   ```
3. Categorize warnings by type and severity
4. For each warning type, determine:
   - Can it be fixed by code changes? (Preferred)
   - Does it need targeted `#[allow]` with justification? (Acceptable)
   - Should it be added to .clippy.toml? (Project-wide policy)

Priority order:
1. Fix the code (e.g., add `_` prefix to unused variables)
2. Add targeted function-level allow with justification
3. Only as last resort: add to .clippy.toml for project-wide suppression

Example targeted allow with justification:
```rust
// SAFETY: This function intentionally uses truncation for hash calculation
// - Input is pre-validated to be within u32 range
// - Truncation is part of the hashing algorithm design
#[allow(clippy::cast_possible_truncation)]
fn hash_to_u32(value: u64) -> u32 {
    value as u32
}
```
  </action>
  <verify>
```bash
cargo clippy --workspace 2>&1 | grep "warning:" | wc -l
# Count warnings (should be manageable number)
cat .planning/phases/01-foundation-fixes/01-02-clippy-warnings.log
# Log exists with all warnings categorized
```
  </verify>
  <done>Global allows removed; clippy warnings log created and categorized by fix strategy</done>
</task>

<task type="auto">
  <name>Task 3: Apply Targeted Fixes and Justified Allows</name>
  <files>crates/velesdb-core/src/lib.rs, crates/velesdb-core/src/**/*.rs</files>
  <action>
Process each warning from the clippy log:

**Fixable warnings (apply code changes):**
- `dead_code`: Remove or use the code
- `unused_variables`: Prefix with `_` or remove
- `module_name_repetitions`: Rename types/functions
- `too_many_arguments`: Consider builder pattern (if low risk)

**Warnings requiring justification (add targeted allows):**

For each function that needs allow, add above the function:
```rust
// SAFETY: [Invariant maintained]
// - [Condition]: [Explanation of why safe]
// Reason: [Why this allow is necessary]
#[allow(clippy::WARNING_NAME)]
fn function_name() { ... }
```

Example for cast-related warnings:
```rust
// SAFETY: Value is clamped to valid range before cast
// - Input validated by calling code to be <= u32::MAX
// - Negative values rejected at API boundary
// Reason: Performance-critical path, bounds checked upstream
#[allow(clippy::cast_possible_truncation)]
#[allow(clippy::cast_sign_loss)]
fn fast_convert_index(idx: i64) -> u32 {
    idx as u32
}
```

Update .clippy.toml if needed for legitimate project-wide suppressions (rare).

Verify after each batch:
```bash
cargo clippy --workspace -- -D warnings
```
  </action>
  <verify>
```bash
cargo clippy --workspace -- -D warnings
# Exit code 0, no warnings
grep -c "^#!\[allow" crates/velesdb-core/src/lib.rs
# Should return 0 (no global allows)
grep -c "#\[allow" crates/velesdb-core/src/lib.rs
# Should show function-level allows with justification
```
  </verify>
  <done>All warnings addressed; zero global allows; function-level allows have SAFETY-style justification; clippy passes with -D warnings</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run clippy with strict mode: `cargo clippy --workspace -- -D warnings`
2. Verify no global allows remain: `grep "^#![allow" crates/velesdb-core/src/lib.rs`
3. Verify function-level allows have comments: Check that each `#[allow]` is preceded by `// SAFETY:` or `// Reason:` comment
4. Run full test suite: `cargo test --workspace`
5. Verify .clippy.toml is valid and minimal

Success indicators:
- `cargo clippy -- -D warnings` exits 0
- No `#![allow(...)]` at module level in lib.rs
- All `#[allow(...)]` at function level have justification comments
- No new warnings introduced
</verification>

<success_criteria>
- Global `#[allow]` attributes removed from lib.rs (lines 61-65)
- Clippy passes with `-D warnings` (zero warnings)
- All remaining allows are function-level with SAFETY-style justification
- .clippy.toml updated if legitimate project-wide suppressions needed
- CI gates pass: `cargo clippy -- -D warnings`, `cargo test`
- Documentation created showing before/after allow counts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-02-SUMMARY.md` with:
- List of global allows removed
- Count of warnings fixed vs. allowed with justification
- Examples of SAFETY-style justification comments used
- Any .clippy.toml changes made
- Remaining warning types and rationale for allowing them
</output>
