---
phase: 4
plan: 3
name: Distance Metrics & Fusion Scenarios
wave: 2
depends_on: [04-01]
autonomous: true
parallel_safe: true
---

# Phase 4 Plan 03: Distance Metrics & Fusion Scenarios

## Objective

Implement E2E tests for Scenario 0c (all 5 distance metrics) and Scenario 0b (NEAR_FUSED multi-vector fusion) from the README. These tests validate VelesDB's core vector capabilities work correctly across all supported metrics and fusion strategies.

## Context

**Requirements addressed:** VP-007
**Phase goal contribution:** Validates that the 5 distance metrics and 4 fusion strategies documented in the README produce correct results. These are foundational capabilities that underpin all other scenarios.

## Tasks

### Task 1: Implement Scenario 0c — All 5 Distance Metrics

**Files:** `tests/readme_scenarios/metrics_and_fusion.rs`

**Action:**
Test each metric with realistic data matching README examples:

1. **Cosine** (NLP/Semantic Search):
   - Create `documents` collection (dim=128, metric=cosine)
   - Insert 10+ points with text-like embeddings
   - Query: `SELECT * FROM documents WHERE vector NEAR $query ORDER BY similarity() DESC LIMIT 10`
   - Assert: results ordered by decreasing cosine similarity

2. **Euclidean** (Spatial/Clustering):
   - Create `locations` collection (dim=3, metric=euclidean)
   - Insert points representing 3D coordinates
   - Query: `SELECT * FROM locations WHERE vector NEAR $gps AND category = 'restaurant' ORDER BY similarity() ASC LIMIT 5`
   - Assert: results ordered by increasing distance (ASC = closer)

3. **DotProduct** (RAG/Recommendations):
   - Create `products` collection (dim=128, metric=dot)
   - Insert normalized product embeddings
   - Query: `SELECT * FROM products WHERE vector NEAR $user_pref AND in_stock = true ORDER BY similarity() DESC LIMIT 8`
   - Assert: results ordered by decreasing dot product

4. **Hamming** (Binary Vectors):
   - Create `image_hashes` collection (dim=64, metric=hamming)
   - Insert binary-like vectors (0.0/1.0 values)
   - Query: `SELECT * FROM image_hashes WHERE vector NEAR $hash AND source = 'user_uploads' ORDER BY similarity() ASC LIMIT 10`
   - Assert: results ordered by increasing hamming distance

5. **Jaccard** (Set Similarity):
   - Create `user_tags` collection (dim=32, metric=jaccard)
   - Insert sparse-like vectors (many zeros, some ones)
   - Query: `SELECT * FROM user_tags WHERE vector NEAR $tags ORDER BY similarity() DESC LIMIT 20`
   - Assert: results ordered by decreasing Jaccard similarity

For each metric, verify:
- Collection creation with the metric succeeds
- Search returns correct number of results
- Results are properly ordered according to metric semantics (higher_is_better vs lower_is_better)

**Verify:**
```powershell
cargo test --test readme_scenarios metrics_and_fusion::test_scenario0c -- --nocapture
```

**Done when:**
- All 5 metrics create collections, insert, and search successfully
- Order direction matches metric semantics (DESC for similarity, ASC for distance)
- Filtered results only include matching payloads

---

### Task 2: Implement Scenario 0b — NEAR_FUSED Multi-Vector Fusion

**Files:** `tests/readme_scenarios/metrics_and_fusion.rs`

**Action:**
Test NEAR_FUSED fusion from README:
```sql
SELECT * FROM products 
WHERE vector NEAR_FUSED [$text_embedding, $image_embedding] 
  USING FUSION 'rrf' (k=60)
  AND category = 'electronics'
ORDER BY similarity() DESC
LIMIT 10
```

Implementation:
1. Create `products` collection (dim=32, metric=cosine)
2. Insert 20+ product points with `category` payload
3. Test each fusion strategy available:
   - **RRF**: `USING FUSION 'rrf' (k=60)` — Rank Reciprocal Fusion
   - **Average**: `USING FUSION 'average'`
   - **Maximum**: Use `FusionStrategy::Maximum` via API
   - **Weighted**: Use `FusionStrategy::Weighted` via API

For VelesQL-based tests, parse and execute the query. For API-based tests, use `collection.multi_query_search()` directly.

4. Assert for each strategy:
   - Results are non-empty
   - Results respect LIMIT
   - Scores are properly fused (non-zero)
   - When category filter applied, only matching products returned

**Verify:**
```powershell
cargo test --test readme_scenarios metrics_and_fusion::test_scenario0b -- --nocapture
```

**Done when:**
- All 4 fusion strategies produce valid results
- RRF fusion via VelesQL parse+execute works
- Category filter applied correctly with fusion
- Results respect LIMIT

---

## Verification

After all tasks complete:

```powershell
cargo test --test readme_scenarios metrics_and_fusion -- --nocapture
cargo clippy --test readme_scenarios -- -D warnings
```

## Success Criteria

- [ ] All 5 distance metrics tested with correct ordering semantics
- [ ] Euclidean/Hamming use ASC ordering (lower = more similar)
- [ ] Cosine/DotProduct/Jaccard use DESC ordering (higher = more similar)
- [ ] Column filters work alongside vector search for each metric
- [ ] All 4 fusion strategies (RRF, Average, Maximum, Weighted) tested
- [ ] NEAR_FUSED via VelesQL parsing works
- [ ] Each test uses realistic data matching README descriptions

## Parallel Safety

**Exclusive write files:** `tests/readme_scenarios/metrics_and_fusion.rs`
**Shared read files:** `tests/readme_scenarios/helpers.rs` (read), `crates/velesdb-core/src/**` (read)
**Conflicts with:** none (unique write file)

## Output

**Files modified:**
- `tests/readme_scenarios/metrics_and_fusion.rs` — Replaces stub with metrics + fusion E2E tests
