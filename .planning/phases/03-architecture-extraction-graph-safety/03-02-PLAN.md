---
phase: 03-architecture-extraction-graph-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/velesql/parser/select.rs
  - crates/velesdb-core/src/velesql/parser/select/mod.rs
  - crates/velesdb-core/src/velesql/parser/select/clause_compound.rs
  - crates/velesdb-core/src/velesql/parser/select/clause_projection.rs
  - crates/velesdb-core/src/velesql/parser/select/clause_from_join.rs
  - crates/velesdb-core/src/velesql/parser/select/clause_group_order.rs
  - crates/velesdb-core/src/velesql/parser/select/clause_limit_with.rs
  - crates/velesdb-core/src/velesql/parser/select/validation.rs
  - crates/velesdb-core/src/velesql/parser/mod.rs
autonomous: true
must_haves:
  truths:
    - "SELECT queries that previously parsed successfully still parse successfully"
    - "Invalid SELECT forms still fail with expected parser errors"
    - "Aggregate and HAVING edge-case regressions remain green after extraction"
  artifacts:
    - path: "crates/velesdb-core/src/velesql/parser/select/mod.rs"
      provides: "Facade entry points for select parsing"
    - path: "crates/velesdb-core/src/velesql/parser/select/validation.rs"
      provides: "Shared cross-cutting validation rules"
    - path: "crates/velesdb-core/src/velesql/parser/select/clause_group_order.rs"
      provides: "GROUP BY/HAVING/ORDER parsing logic"
  key_links:
    - from: "crates/velesdb-core/src/velesql/parser/select/mod.rs"
      to: "crates/velesdb-core/src/velesql/parser/select/validation.rs"
      via: "shared validation helpers"
      pattern: "use .*validation"
    - from: "crates/velesdb-core/src/velesql/parser/mod.rs"
      to: "crates/velesdb-core/src/velesql/parser/select/mod.rs"
      via: "module wiring"
      pattern: "mod select"
---

<objective>
Split monolithic SELECT parsing into clause-oriented modules with shared validation while preserving parser behavior and testability.

Purpose: Deliver QUAL-01 parser modularity using the locked hybrid decomposition strategy.
Output: `parser/select/` submodule tree with stable facade and parser regressions preserved.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-architecture-extraction-graph-safety/03-CONTEXT.md
@.planning/phases/03-architecture-extraction-graph-safety/03-RESEARCH.md
@crates/velesdb-core/src/velesql/parser/select.rs
@crates/velesdb-core/src/velesql/parser/mod.rs
@crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hybrid SELECT parser module boundaries</name>
  <files>crates/velesdb-core/src/velesql/parser/select.rs, crates/velesdb-core/src/velesql/parser/select/mod.rs, crates/velesdb-core/src/velesql/parser/select/clause_projection.rs, crates/velesdb-core/src/velesql/parser/select/clause_from_join.rs, crates/velesdb-core/src/velesql/parser/select/clause_group_order.rs, crates/velesdb-core/src/velesql/parser/select/clause_limit_with.rs, crates/velesdb-core/src/velesql/parser/select/clause_compound.rs</files>
  <action>Convert `select.rs` into a facade module and move clause-specific parsing into dedicated files. Keep exported entry points and parser contracts stable. Preserve existing parsing semantics and error shapes; extraction is structural, not behavioral. Maintain naming clarity and long-term readability per user decision.</action>
  <verify>cargo test -p velesdb-core parser::</verify>
  <done>SELECT parsing responsibilities are split by clause with a stable facade and no functional regressions in parser tests.</done>
</task>

<task type="auto">
  <name>Task 2: Centralize cross-cutting validation logic</name>
  <files>crates/velesdb-core/src/velesql/parser/select/validation.rs, crates/velesdb-core/src/velesql/parser/select/mod.rs, crates/velesdb-core/src/velesql/parser/select/clause_group_order.rs, crates/velesdb-core/src/velesql/parser/select/clause_projection.rs</files>
  <action>Implement shared validation helpers for recurring rules (aggregate wildcard constraints, comparison/operator validation, identifier checks) in `validation.rs`. Update clause modules to call shared helpers rather than duplicating inline checks. This enforces the locked hybrid parser decision and reduces drift risk.</action>
  <verify>cargo test -p velesdb-core test_validate_multiple_similarity_with_or_detected</verify>
  <done>Cross-cutting validation exists in one shared module and clause parsers consume it without duplicating equivalent logic.</done>
</task>

<task type="auto">
  <name>Task 3: Rewire parser module and run regression-focused validation</name>
  <files>crates/velesdb-core/src/velesql/parser/mod.rs</files>
  <action>Update parser module wiring for the new `select/` structure and validate against existing parser regressions (aggregate wildcard, HAVING operators, correlated subquery extraction) from Phase 2. Enforce strict 500-line rule on newly extracted parser files; if any temporary exception is required, document explicit justification in code comments and summary.</action>
  <verify>cargo test -p velesdb-core pr_review_bugfix_tests && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Parser wiring compiles with the new layout, focused parser regressions pass, and extracted parser files meet the <=500-line policy (or include explicitly justified temporary exceptions).</done>
</task>

</tasks>

<verification>
`cargo test -p velesdb-core parser::`
`cargo test -p velesdb-core pr_review_bugfix_tests`
`cargo clippy -p velesdb-core -- -D warnings`
</verification>

<success_criteria>
- `select.rs` is decomposed into clause modules plus shared validation module.
- Parser behavior remains stable for previously fragile SELECT paths.
- Extraction aligns with locked hybrid parser strategy from phase context.
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-extraction-graph-safety/03-02-SUMMARY.md`
</output>
