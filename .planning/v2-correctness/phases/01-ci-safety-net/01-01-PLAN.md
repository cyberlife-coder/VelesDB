---
phase: 1
plan: 1
name: CI Pipeline Hardening
wave: 1
depends_on: none
autonomous: true
---

# Phase 1 Plan 1: CI Pipeline Hardening

## Objective

Harden the GitHub Actions CI pipeline to catch regressions automatically. Re-enable PR triggers, make security audit blocking, add `cargo deny check`, and remove single-threaded test constraint that masks concurrency bugs.

## Context

**Requirements addressed:** CI-01, CI-02, CI-03, CI-04
**Phase goal contribution:** This plan IS the entire phase — every subsequent phase depends on CI catching regressions.

## Tasks

### Task 1: Re-enable PR CI triggers [CI-01]

**Files:** `.github/workflows/ci.yml`

**Action:**
Uncomment the `pull_request` trigger block (lines 22-29). Keep path filtering for cost control:
- `crates/**`
- `Cargo.toml`
- `Cargo.lock`

The existing `concurrency: cancel-in-progress: true` already prevents duplicate runs.

**Verify:**
```powershell
# Check the file has the PR trigger uncommented
Select-String -Path ".github/workflows/ci.yml" -Pattern "pull_request:" | Select-Object -First 1
```

**Done when:**
- `pull_request:` trigger is active (not commented)
- Path filtering matches push trigger paths
- `concurrency` block still present

---

### Task 2: Fix security audit swallowing failures [CI-02]

**Files:** `.github/workflows/ci.yml`

**Action:**
Line 135: Replace `cargo audit --ignore RUSTSEC-2024-0320 || true` with:
```yaml
      - name: Run security audit
        # Reason: RUSTSEC-2024-0320 = bincode unmaintained advisory.
        # Tracked in QUAL-05 for migration. Safe to ignore until v3.
        run: cargo audit --ignore RUSTSEC-2024-0320
```

Remove `|| true` — audit failures must block the pipeline.

**Verify:**
```powershell
# Must NOT contain "|| true" on the audit line
Select-String -Path ".github/workflows/ci.yml" -Pattern "cargo audit" | Select-Object -First 1
```

**Done when:**
- `|| true` removed from audit command
- RUSTSEC-2024-0320 ignore documented with reason
- Audit failure blocks CI

---

### Task 3: Add cargo deny check to CI [CI-03]

**Files:** `.github/workflows/ci.yml`

**Action:**
In the `security` job (after the audit step), add a new step:
```yaml
      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run dependency policy check
        run: cargo deny check
```

This enforces the same `deny.toml` policy that `local-ci.ps1` already mandates.

**Verify:**
```powershell
# Check deny step exists
Select-String -Path ".github/workflows/ci.yml" -Pattern "cargo deny check"
```

**Done when:**
- `cargo deny check` runs in CI security job
- Uses project's `deny.toml` configuration
- Failure blocks CI

---

### Task 4: Enable multi-threaded tests [CI-04]

**Files:** `.github/workflows/ci.yml`

**Action:**
In the `test` job:
1. Line 114: Remove `-- --test-threads=1` from the cargo test command
2. Lines 115-116: Remove the `env: RUST_TEST_THREADS: 1` block

The test command becomes:
```yaml
      - name: Run tests
        run: |
          cargo test --workspace --features persistence,gpu,update-check \
            --exclude velesdb-python
```

If flaky tests appear, fix them individually with `#[serial]` — never mask concurrency bugs globally.

**Verify:**
```powershell
# Must NOT contain test-threads or RUST_TEST_THREADS
Select-String -Path ".github/workflows/ci.yml" -Pattern "test-threads|RUST_TEST_THREADS"
```

**Done when:**
- No `--test-threads=1` in test command
- No `RUST_TEST_THREADS` env variable
- Tests run with default Rust parallelism

---

## Verification

After all tasks complete:

```powershell
# Verify CI file is valid YAML
python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"

# Verify local tests still pass multi-threaded
cargo test --workspace --features persistence,gpu,update-check --exclude velesdb-python

# Quality gates
cargo fmt --all --check
cargo clippy -- -D warnings
cargo deny check
```

## Success Criteria

- [ ] PRs to main/develop trigger CI (pull_request trigger uncommented)
- [ ] `cargo audit` failure blocks merge (no `|| true`)
- [ ] `cargo deny check` runs in CI security job
- [ ] Tests run with default parallelism (no `--test-threads=1`)
- [ ] All quality gates pass locally

## Output

**Files modified:**
- `.github/workflows/ci.yml` — PR trigger, audit fix, deny check, multi-thread tests
