---
phase: 3
plan: 1
name: Input Validation & VelesQL Fixes
wave: 1
depends_on: none
autonomous: true
---

# Phase 3 Plan 1: Input Validation & VelesQL Fixes

## Objective

Block NaN/Infinity vectors from entering the system and make ORDER BY property paths return a clear error instead of silently doing nothing. These are the two VelesQL-facing bugs that affect every user query.

## Context

**Requirements addressed:** B-01, B-02
**Phase goal contribution:** Users get correct errors instead of corrupt data or silent failures.

**Current state:**
- `extraction.rs` has 3 `else` branches that cast NaN/Infinity f64 → f32 (should return `None`)
- ORDER BY property paths silently fall through a catch-all `_` branch

## Tasks

### Task 1: Block NaN/Infinity in vector extraction [B-01]

**Files:** `crates/velesdb-core/src/collection/search/query/extraction.rs`

**Action:**
Find the 3 occurrences of this pattern (around lines 46-55, 108-120, 225-237):
```rust
} else if f.is_finite() {
    None
} else {
    #[allow(clippy::cast_possible_truncation)]
    Some(f as f32)
}
```

Replace the `else` branch with `None` — non-finite values must be rejected:
```rust
} else {
    // Reason: NaN/Infinity vectors corrupt similarity calculations
    None
}
```

The combined logic becomes: if finite AND in f32 range → `Some(f as f32)`, otherwise → `None`.

**Verify:**
```powershell
# RED test first
cargo test --package velesdb-core -- extraction_tests::test_nan_vector_rejected

# After fix
cargo test --package velesdb-core -- extraction
```

**Done when:**
- NaN f64 → `None` (not `Some(NaN_f32)`)
- Infinity f64 → `None` (not `Some(Infinity_f32)`)
- 3 occurrences fixed
- All extraction tests pass

---

### Task 2: ORDER BY property paths → UnsupportedFeature error [B-02]

**Files:** `crates/velesdb-core/src/velesql/ordering.rs` (or wherever ORDER BY dispatch lives)

**Action:**
1. Find the catch-all `_` branch that silently ignores unsupported ORDER BY expressions
2. Replace with explicit error:
```rust
_ => {
    return Err(VelesError::UnsupportedFeature(
        "ORDER BY property paths not yet supported".to_string(),
    ));
}
```
3. If `VelesError::UnsupportedFeature` doesn't exist, add it to the error enum in `crates/velesdb-core/src/error.rs`

**Verify:**
```powershell
# RED test first
cargo test --package velesdb-core -- ordering_tests::test_order_by_property_returns_error

# After fix
cargo test --package velesdb-core -- ordering
```

**Done when:**
- ORDER BY property path → clear error message
- No silent no-op
- Error variant exists in `VelesError`
- All ordering tests pass

---

### Task 3: Regression tests for input validation

**Files:**
- `crates/velesdb-core/src/collection/search/query/extraction_tests.rs` (or create if needed)

**Action:**
Add tests:
1. `test_nan_vector_components_filtered`: vector `[1.0, NaN, 3.0]` → NaN component becomes `None`
2. `test_infinity_vector_components_filtered`: vector `[1.0, f64::INFINITY, 3.0]` → Infinity component becomes `None`
3. `test_neg_infinity_filtered`: same for `f64::NEG_INFINITY`
4. `test_valid_vector_passes`: normal vector `[1.0, 2.0, 3.0]` → all `Some`

**Verify:**
```powershell
cargo test --package velesdb-core -- extraction_tests
```

**Done when:**
- 4 new tests covering NaN, ±Infinity, and valid vectors
- All pass

---

## Verification

After all tasks complete:

```powershell
cargo test --workspace --features persistence,gpu,update-check --exclude velesdb-python
cargo fmt --all --check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings
```

## Success Criteria

- [ ] NaN/Infinity → `None` in all 3 extraction paths
- [ ] ORDER BY property path → `UnsupportedFeature` error
- [ ] No silent failures in VelesQL query pipeline
- [ ] Regression tests for NaN, Infinity, and ORDER BY error
- [ ] All quality gates pass

## Output

**Files modified:**
- `crates/velesdb-core/src/collection/search/query/extraction.rs` — block NaN/Infinity
- `crates/velesdb-core/src/velesql/ordering.rs` — error instead of no-op
- `crates/velesdb-core/src/error.rs` — add `UnsupportedFeature` if missing

**Files created/modified:**
- `crates/velesdb-core/src/collection/search/query/extraction_tests.rs` — regression tests
