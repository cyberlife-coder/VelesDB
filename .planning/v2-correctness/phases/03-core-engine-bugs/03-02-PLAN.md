---
phase: 3
plan: 2
name: Graph Traversal Fixes
wave: 1
depends_on: none
autonomous: true
---

# Phase 3 Plan 2: Graph Traversal Fixes

## Objective

Fix BFS visited set overflow (which causes duplicate nodes in cyclic graphs) and DFS termination inconsistency (continue vs break when limit reached). Both bugs affect graph traversal correctness.

## Context

**Requirements addressed:** B-05, M-03
**Phase goal contribution:** Graph traversal produces correct, deduplicated results with consistent termination semantics.

**Current state:**
- `streaming.rs:210` — `self.visited.clear()` on overflow → loses all cycle detection, duplicates appear
- DFS uses `continue` when limit reached instead of `break` → inconsistent with BFS behavior

## Tasks

### Task 1: BFS visited_overflow — stop inserting, don't clear [B-05]

**Files:** `crates/velesdb-core/src/collection/graph/streaming.rs`

**Action:**
Replace the overflow handling block (around line 207-213):
```rust
// BEFORE (broken)
if self.visited.len() >= self.config.max_visited_size {
    self.visited_overflow = true;
    self.visited.clear(); // Free memory ← BUG: loses all visited tracking
} else {
    self.visited.insert(target);
}
```

With:
```rust
// AFTER (fixed)
if self.visited.len() >= self.config.max_visited_size {
    self.visited_overflow = true;
    // Reason: Don't clear — already-visited nodes must remain detectable.
    // We stop growing the set but keep existing entries.
    // max_depth still bounds traversal even without new insertions.
} else {
    self.visited.insert(target);
}
```

The key change: remove `self.visited.clear()`. The visited set stays intact — we just stop adding to it.

**Verify:**
```powershell
# RED test first — cyclic graph with small max_visited should NOT produce duplicates
cargo test --package velesdb-core -- streaming_tests::test_bfs_no_duplicates_on_overflow

# After fix
cargo test --package velesdb-core -- streaming_tests
```

**Done when:**
- `self.visited.clear()` removed
- Overflow flag set but visited set preserved
- No duplicate `target_id` in results for cyclic graphs
- All streaming tests pass

---

### Task 2: DFS break vs continue [M-03]

**Files:** `crates/velesdb-core/src/collection/graph/traversal.rs`

**Action:**
Find the DFS traversal function (`dfs_single` or equivalent). Locate the limit check that uses `continue`:
```rust
// BEFORE
if results.len() >= limit {
    continue; // ← BUG: keeps processing queue instead of stopping
}
```

Replace with `break`:
```rust
// AFTER
if results.len() >= limit {
    break; // Reason: Consistent with BFS — stop immediately when limit reached
}
```

**Verify:**
```powershell
cargo test --package velesdb-core -- traversal_tests
```

**Done when:**
- DFS stops immediately when limit reached (like BFS)
- `break` replaces `continue` at limit check
- All traversal tests pass

---

### Task 3: Regression tests for graph traversal

**Files:** `crates/velesdb-core/src/collection/graph/streaming_tests.rs`

**Action:**
Add tests:
1. `test_bfs_no_duplicates_on_overflow`: Create cyclic graph (A→B→C→A), set `max_visited_size=2`, verify zero duplicate `target_id` in results
2. `test_bfs_overflow_preserves_visited`: After overflow, nodes already in visited set are still skipped
3. `test_dfs_stops_at_limit`: Create deep graph, set limit=3, verify exactly 3 results (not more)

**Verify:**
```powershell
cargo test --package velesdb-core -- streaming_tests
cargo test --package velesdb-core -- traversal_tests
```

**Done when:**
- Cyclic graph test produces zero duplicates
- DFS limit test produces exactly N results
- All graph tests pass

---

## Verification

After all tasks complete:

```powershell
cargo test --package velesdb-core -- graph
cargo fmt --all --check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings
```

## Success Criteria

- [ ] BFS: `visited.clear()` removed — overflow preserves existing visited set
- [ ] BFS: zero duplicate `target_id` on cyclic graphs with overflow
- [ ] DFS: `break` when limit reached (not `continue`)
- [ ] 3 regression tests for graph traversal correctness
- [ ] All quality gates pass

## Output

**Files modified:**
- `crates/velesdb-core/src/collection/graph/streaming.rs` — remove `visited.clear()`
- `crates/velesdb-core/src/collection/graph/traversal.rs` — break vs continue

**Files modified:**
- `crates/velesdb-core/src/collection/graph/streaming_tests.rs` — regression tests
