---
phase: 4
plan: 1
name: HNSW & Search Performance
wave: 1
depends_on: none
autonomous: true
---

# Phase 4 Plan 1: HNSW & Search Performance

## Objective

Reduce HNSW search lock contention by acquiring `layers.read()` once per search (not per candidate), and make the over-fetch factor configurable instead of hardcoded `10 * count`. Save benchmarks baseline BEFORE changes.

## Context

**Requirements addressed:** D-02, D-04
**Phase goal contribution:** Direct latency improvement on HNSW search — the most performance-critical hot path.

**Current state:**
- `search_layer` acquires `layers.read()` per candidate → high lock contention under concurrency
- Over-fetch hardcoded at `10 * count` → suboptimal for different dataset sizes

## Tasks

### Task 1: Save benchmark baseline

**Files:** `benchmarks/` output directory

**Action:**
Run HNSW benchmarks and save results BEFORE any changes:
```powershell
cargo bench -p velesdb-core --bench hnsw_benchmark -- --save-baseline before-phase4
```

Store the baseline to compare against after changes.

**Verify:**
```powershell
# Baseline file exists
Test-Path "target/criterion/before-phase4"
```

**Done when:**
- HNSW benchmark baseline saved as `before-phase4`
- Results documented for comparison

---

### Task 2: HNSW single read lock per search [D-02]

**Files:** `crates/velesdb-core/src/index/hnsw/native/graph.rs` (or wherever `search_layer` lives)

**Action:**
Find the `search_layer` function. Currently acquires the read lock per candidate:
```rust
// BEFORE: lock acquired inside loop
for candidate in candidates {
    let layers = self.layers.read(); // ← Lock per candidate
    // ... process ...
}
```

Refactor to acquire once:
```rust
// AFTER: single lock acquisition
let layers = self.layers.read(); // ← One lock for entire search
for candidate in candidates {
    // ... process using &layers ...
}
```

The `RwLock::read()` guard must live for the duration of the search. This is safe because search is read-only.

**Verify:**
```powershell
# Run benchmarks against baseline
cargo bench -p velesdb-core --bench hnsw_benchmark -- --baseline before-phase4

# Concurrent test
cargo test --package velesdb-core -- hnsw::concurrent
```

**Done when:**
- Single `layers.read()` per search call
- No performance regression vs baseline (should improve under concurrency)
- All HNSW tests pass including concurrent tests

---

### Task 3: Adaptive over-fetch factor [D-04]

**Files:**
- `crates/velesdb-core/src/velesql/parser/` — WITH clause parsing
- `crates/velesdb-core/src/collection/search/` — where `10 * count` is used

**Action:**
1. Find the hardcoded `10 * count` (or similar multiplier) in the search path
2. Add `overfetch` parameter to `WithClause` (or equivalent config struct):
```rust
pub fn get_overfetch(&self) -> usize {
    self.params.get("overfetch")
        .and_then(|v| v.parse::<usize>().ok())
        .unwrap_or(10)
        .clamp(1, 100)
}
```
3. Replace hardcoded `10 * count` with `config.get_overfetch() * count`
4. VelesQL: `SELECT ... WITH (overfetch = 20)` syntax

**Verify:**
```powershell
cargo test --package velesdb-core -- overfetch
cargo test --package velesdb-core -- velesql::parser
```

**Done when:**
- Over-fetch factor configurable via `WITH (overfetch = N)`
- Default: 10 (backward compatible)
- Range: 1-100 (clamped)
- All tests pass

---

## Verification

After all tasks complete:

```powershell
# Compare benchmarks
cargo bench -p velesdb-core --bench hnsw_benchmark -- --baseline before-phase4

# Full test suite
cargo test --workspace --features persistence,gpu,update-check --exclude velesdb-python
cargo fmt --all --check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings
```

## Success Criteria

- [ ] Benchmark baseline saved before changes
- [ ] HNSW: one `layers.read()` per search call (not per candidate)
- [ ] Over-fetch factor configurable via `WITH (overfetch = N)`, default 10
- [ ] No performance regression vs baseline
- [ ] All quality gates pass

## Output

**Files modified:**
- `crates/velesdb-core/src/index/hnsw/native/graph.rs` — single read lock
- `crates/velesdb-core/src/collection/search/` — configurable over-fetch
- `crates/velesdb-core/src/velesql/parser/` — WITH clause overfetch param
