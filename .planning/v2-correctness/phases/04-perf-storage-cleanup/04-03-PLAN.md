---
phase: 4
plan: 3
name: ColumnStore Unification & Dead Code Cleanup
wave: 1
depends_on: none
autonomous: true
---

# Phase 4 Plan 3: ColumnStore Unification & Dead Code Cleanup

## Objective

Unify ColumnStore deletion tracking to a single `RoaringBitmap` (remove redundant `FxHashSet`), delete Node4 dead code from CART index, and remove unused validation functions. Clean code = fewer bugs, smaller binary, easier maintenance.

## Context

**Requirements addressed:** D-01, D-03, M-01, M-02
**Phase goal contribution:** Eliminates dead code, reduces memory overhead (no duplicate deletion tracking), and removes unreachable panic paths.

**Current state:**
- `ColumnStore` maintains both `deleted_rows: FxHashSet<usize>` AND `deletion_bitmap: RoaringBitmap` — redundant, risk of divergence
- CART index has `Node4` variant with `#[allow(dead_code)]` — never constructed
- `validation.rs` has `contains_similarity()` and `has_not_similarity()` — never called
- `OrderedFloat` has `unreachable!()` that should return `Ordering::Equal`

## Tasks

### Task 1: ColumnStore — unify deletion to RoaringBitmap [D-01]

**Files:**
- `crates/velesdb-core/src/column_store/mod.rs` (or equivalent)

**Action:**
1. Delete the `deleted_rows: FxHashSet<usize>` field
2. Keep only `deletion_bitmap: RoaringBitmap`
3. Update all methods that use `deleted_rows`:
   - `delete(row_id)` → `deletion_bitmap.insert(row_id as u32)`
   - `is_deleted(row_id)` → `deletion_bitmap.contains(row_id as u32)`
   - `count_deleted()` → `deletion_bitmap.len()`
4. Remove `FxHashSet` import if no longer used in the file
5. If `column_store/mod.rs` > 300 lines post-change, split into `deletion.rs` + `filter.rs`

**Verify:**
```powershell
cargo test --package velesdb-core -- column_store
```

**Done when:**
- Zero references to `deleted_rows: FxHashSet` in column store
- Single `RoaringBitmap` for all deletion tracking
- All column store tests pass
- File ≤ 300 lines (split if needed)

---

### Task 2: CART — delete Node4 dead code [D-03]

**Files:** `crates/velesdb-core/src/index/property/` (CART/trie index files)

**Action:**
1. Find `Node4` variant (has `#[allow(dead_code)]`)
2. Delete the variant and its associated `impl` blocks/match arms
3. Remove `#[allow(dead_code)]` annotation
4. Add comment at the CART node enum:
```rust
// Note: Leaf splitting is a known limitation. Leaves grow unbounded
// for high-cardinality prefixes. Node4 was removed as unused dead code.
// If adaptive splitting is needed, re-implement with proper tests.
```

**Verify:**
```powershell
cargo test --package velesdb-core -- property
# Verify no dead_code warnings
cargo clippy --package velesdb-core -- -W dead_code 2>&1 | Select-String "Node4"
```

**Done when:**
- `Node4` variant deleted
- `#[allow(dead_code)]` removed
- Comment explains the design decision
- All property index tests pass

---

### Task 3: Dead validation functions & OrderedFloat fix [M-01, M-02]

**Files:**
- `crates/velesdb-core/src/velesql/validation.rs`

**Action:**
1. Delete `contains_similarity()` function — never called
2. Delete `has_not_similarity()` function — never called
3. Find the `OrderedFloat` comparison that has `unreachable!()`:
```rust
// BEFORE
_ => unreachable!("NaN should not appear in OrderedFloat")
```
Replace with safe fallback:
```rust
// AFTER
// Reason: NaN comparison edge case — Equal is safe and correct
// since OrderedFloat should never contain NaN by construction.
_ => Ordering::Equal
```
4. Update tests if they reference the deleted functions

**Verify:**
```powershell
cargo test --package velesdb-core -- validation
# Verify no unused function warnings
cargo clippy --package velesdb-core -- -W dead_code 2>&1 | Select-String "contains_similarity|has_not_similarity"
```

**Done when:**
- `contains_similarity` and `has_not_similarity` deleted
- `unreachable!()` replaced with `Ordering::Equal`
- No dead code warnings
- All validation tests pass

---

## Verification

After all tasks complete:

```powershell
# Full test suite
cargo test --workspace --features persistence,gpu,update-check --exclude velesdb-python

# Dead code check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings -W dead_code

# Quality gates
cargo fmt --all --check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings
cargo deny check
```

## Success Criteria

- [ ] Single `RoaringBitmap` for ColumnStore deletion (no `FxHashSet` duplicate)
- [ ] `Node4` dead code removed from CART index
- [ ] `contains_similarity` and `has_not_similarity` deleted
- [ ] `unreachable!()` in OrderedFloat replaced with `Ordering::Equal`
- [ ] Zero dead code warnings from clippy
- [ ] All quality gates pass

## Output

**Files modified:**
- `crates/velesdb-core/src/column_store/mod.rs` — unify deletion bitmap
- `crates/velesdb-core/src/index/property/*.rs` — delete Node4
- `crates/velesdb-core/src/velesql/validation.rs` — delete unused functions, fix OrderedFloat
