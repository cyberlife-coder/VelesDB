---
phase: 01-foundation-fixes
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/**/*.rs
  - crates/velesdb-core/tests/numeric_casts.rs
  - crates/velesdb-core/tests/integration_casts.rs
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "All #[allow] attributes have SAFETY-style justification comments"
    - "Unit tests verify boundary conditions and exercise production code"
    - "Integration tests call actual Collection, HnswIndex, and storage methods"
  artifacts:
    - path: "crates/velesdb-core/src/simd_native.rs"
      provides: "All #[allow] have SAFETY or Reason comments"
      pattern: "#\\[allow\\(.*\\)\\]\\s*(?://\\s*SAFETY|//\\s*Reason)"
    - path: "crates/velesdb-core/tests/numeric_casts.rs"
      provides: "Helper function tests"
    - path: "crates/velesdb-core/tests/integration_casts.rs"
      provides: "Production code integration tests"
      min_lines: 100
  key_links:
    - from: "tests/integration_casts.rs"
      to: "Collection::create"
      via: "test_oversized_dimension_rejected"
      pattern: "Collection::create.*dimension"
    - from: "tests/integration_casts.rs"
      to: "MmapStorage::write_vectors"
      via: "test_oversized_batch_rejected"
      pattern: "write_vectors.*batch"
    - from: "src/**/*.rs #[allow]"
      to: "SAFETY comment"
      via: "justification comment"
      pattern: "//\\s*(SAFETY|Reason):"
---

## Gap Closure Plan: Add SAFETY Comments & Integration Tests

### Gap Addressed

- **Gap 3: Tests don't exercise production code (Medium)** — Add integration tests calling actual Collection, HnswIndex, storage methods
- **Gap 4: Missing SAFETY comments (Medium)** — Add SAFETY or Reason comments to 27 #[allow] attributes

### Objective

Complete Phase 1 documentation requirements by adding SAFETY justifications to all remaining #[allow] attributes and ensure tests exercise actual production code paths.

**Purpose:** Close documentation gaps and improve test coverage of real code paths vs helper functions.

**Output:** All #[allow] attributes documented with SAFETY-style justifications and integration tests that call production methods.

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/01-foundation-fixes/01-foundation-fixes-VERIFICATION.md

Prior plans:
- @.planning/phases/01-foundation-fixes/01-01-SUMMARY.md — Numeric Cast Audit (tests exist but limited)

Key facts:
- 140 #[allow] attributes exist in codebase
- 113 already have SAFETY/Reason comments
- 27 missing SAFETY-style justification
- simd_native.rs has some #[allow] with only // comments, not SAFETY:

SAFETY comment template (from AGENTS.md):
```rust
// SAFETY: [Invariant principal maintenu]
// - [Condition 1]: [Explication]
// - [Condition 2]: [Explication]
// Reason: [Pourquoi unsafe est nécessaire]
#[allow(clippy::...)]
```

Current test file:
- @crates/velesdb-core/tests/numeric_casts.rs — Tests helper functions validate_dimension/validate_offset
- Missing: Tests of Collection::create, HnswIndex methods, storage::mmap methods
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SAFETY/Reason comments to 27 #[allow] attributes</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
    crates/velesdb-core/src/**/*.rs
  </files>
  <action>
Add SAFETY-style justification comments to all 27 #[allow] attributes missing them.

Step 1: Find all #[allow] without SAFETY/Reason:
```bash
grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" | grep -v "SAFETY\|Reason" | head -40
```

Step 2: For each #[allow], add justification using one of these patterns:

For unsafe code permits:
```rust
// SAFETY: [Invariant maintained]
// - [Condition]: [Explanation of why it's safe]
// Reason: [Why the lint is suppressed]
#[allow(unsafe_code)]
```

For numeric cast permits (already proven safe):
```rust
// SAFETY: Value bounded before cast
// - clamped to [0.0, 1.0] range via .clamp(0.0, 1.0)
// - Result guaranteed to fit in target type
#[allow(clippy::cast_possible_truncation)]
let percent = (value.clamp(0.0, 1.0) * 100.0) as u32;
```

For complexity/size permits:
```rust
// Reason: Large module from SIMD implementation consolidation
// Module will be split in Phase 3 architecture extraction
#[allow(clippy::too_many_lines)]
```

For performance-justified permits:
```rust
// Reason: Intentional cast for performance - bounds checked at call site
// SAFETY: index < len verified in calling code before cast
#[allow(clippy::cast_possible_truncation)]
```

Key files to check:
- simd_native.rs (has ~100 #[allow], some missing SAFETY)
- simd_neon.rs
- storage/guard.rs
- index/hnsw/**/*.rs

Verify count:
```bash
grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" | wc -l
# Should be 140
grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" | grep -c "SAFETY\|Reason"
# Should be 140 (all have justification)
```
  </action>
  <verify>
    # Count #[allow] attributes
    total=$(grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" | wc -l)
    # Count those with SAFETY or Reason
    justified=$(grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" -A1 | grep -c "SAFETY\|Reason")
    echo "Total: $total, Justified: $justified"
    # Both should be equal (140)
    [ "$total" -eq "$justified" ] && echo "PASS" || echo "FAIL"
  </verify>
  <done>
    - All 140 #[allow] attributes have SAFETY or Reason justification
    - simd_native.rs specifically updated with proper SAFETY comments
    - No #[allow] attribute lacks documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for production code paths</name>
  <files>
    crates/velesdb-core/tests/integration_casts.rs
  </files>
  <action>
Create integration tests that exercise actual production methods, not just helper functions.

Create new file: crates/velesdb-core/tests/integration_casts.rs

Add tests that call:

1. **Collection::create_with_oversized_dimension**:
```rust
#[test]
fn test_collection_rejects_oversized_dimension() {
    let temp_dir = TempDir::new().unwrap();
    let path = temp_dir.path().join("test_collection");
    
    // Try to create collection with dimension > u32::MAX
    let oversized_dim = (u32::MAX as usize) + 1;
    let result = Collection::create(&path, oversized_dim, DistanceMetric::Euclidean);
    
    assert!(matches!(result, Err(Error::Overflow)));
}

#[test]
fn test_collection_accepts_valid_dimension() {
    let temp_dir = TempDir::new().unwrap();
    let path = temp_dir.path().join("test_collection");
    
    let result = Collection::create(&path, 128, DistanceMetric::Euclidean);
    assert!(result.is_ok());
}
```

2. **HnswIndex boundary tests**:
```rust
#[test]
fn test_hnsw_index_rejects_oversized_vectors() {
    let mut index = HnswIndex::new(128, 16, 200, DistanceMetric::Euclidean);
    
    // Create vector with mismatched dimension
    let wrong_dim_vector = vec![1.0; 64]; // 64 vs 128 expected
    let result = index.insert(wrong_dim_vector, 1);
    
    assert!(result.is_err());
}
```

3. **Storage mmap boundary tests**:
```rust
#[test]
fn test_mmap_rejects_oversized_batch() {
    let temp_dir = TempDir::new().unwrap();
    let path = temp_dir.path().join("test_mmap");
    
    let storage = MmapStorage::create(&path, 128).unwrap();
    
    // Try to write batch with > u32::MAX vectors
    let oversized_batch = vec![vec![1.0; 128]; 100]; // Small batch, but simulate overflow
    let result = storage.write_vectors(oversized_batch);
    
    // Should handle gracefully
}
```

4. **Numeric boundary tests**:
```rust
#[test]
fn test_dimension_boundary_u32_max() {
    // Test exactly at u32::MAX boundary
    let max_u32 = u32::MAX as usize;
    let result = validate_dimension(max_u32);
    assert!(result.is_err()); // Should reject as too large
}

#[test]
fn test_offset_boundary_usize_max() {
    // Test usize::MAX as offset
    let result = validate_offset(usize::MAX, 1000);
    assert!(result.is_err());
}
```

Ensure tests:
- Use real types from velesdb_core (Collection, HnswIndex, MmapStorage)
- Test boundary conditions (u32::MAX, usize::MAX, 0)
- Verify error types (Error::Overflow, Error::InvalidInput)
- Use temp directories for file operations
- Clean up resources (temp directories auto-deleted)

Add necessary imports:
```rust
use velesdb_core::{Collection, HnswIndex, DistanceMetric, Error};
use velesdb_core::storage::MmapStorage;
use tempdir::TempDir;
```
  </action>
  <verify>
    cargo test --test integration_casts
    # Should run and pass all new integration tests
  </verify>
  <done>
    - integration_casts.rs file created with 5-8 integration tests
    - Tests call actual Collection, HnswIndex, MmapStorage methods
    - Tests verify boundary conditions (u32::MAX, usize::MAX)
    - All tests pass: cargo test --test integration_casts
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all requirements met</name>
  <files>
    crates/velesdb-core/tests/numeric_casts.rs
    crates/velesdb-core/tests/integration_casts.rs
  </files>
  <action>
Final verification that all gaps are closed:

1. **SAFETY comments verification**:
```bash
# Count total #[allow]
total=$(grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" | wc -l)
# Count with SAFETY/Reason (check line after each #[allow])
justified=$(grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" -A1 | grep -c "SAFETY\|Reason")
echo "Allow attributes: $total, Justified: $justified"
```
Should show 140 total and 140 justified.

2. **Test coverage verification**:
```bash
# Count total tests
cargo test --workspace 2>&1 | grep -E "test result" | tail -1
```

3. **Clippy clean verification**:
```bash
cargo clippy --workspace -- -D warnings -W clippy::pedantic 2>&1 | grep -E "^error" | wc -l
# Should be 0
```

4. **All tests pass**:
```bash
cargo test --workspace
# Should show all passing
```

Update ROADMAP.md to mark RUST-04 and TEST-01 as satisfied.
  </action>
  <verify>
    # Final comprehensive check
    cargo clippy --workspace -- -D warnings
    cargo test --workspace
    cargo fmt --all --check
  </verify>
  <done>
    - All 140 #[allow] attributes have SAFETY/Reason justification
    - Integration tests exercise production code paths
    - All quality gates pass (clippy, test, fmt)
  </done>
</task>

</tasks>

<verification>

### Pre-execution verification
1. Count current #[allow] without SAFETY: 
   `grep -rn "#\[allow" crates/velesdb-core/src --include="*.rs" -A1 | grep -v "SAFETY\|Reason" | grep -c "//"`
2. Verify current tests only test helpers:
   `grep -n "fn test_" crates/velesdb-core/tests/numeric_casts.rs`

### Per-task verification
- After Task 1: All #[allow] have SAFETY/Reason
- After Task 2: integration_casts.rs exists and tests pass
- After Task 3: All quality gates pass

### Post-execution verification
1. `cargo clippy --workspace -- -D warnings` exits 0
2. `cargo test --workspace` all pass
3. `cargo fmt --all --check` passes
4. All 140 #[allow] documented

</verification>

<success_criteria>

1. **SAFETY comments complete:** All 140 #[allow] attributes have SAFETY or Reason justification
2. **Integration tests added:** New tests call Collection, HnswIndex, storage methods
3. **Boundary conditions tested:** Tests verify u32::MAX, usize::MAX, 0 boundaries
4. **Quality gates pass:** cargo clippy, cargo test, cargo fmt all succeed
5. **No regressions:** All existing tests continue to pass

</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-fixes/01-05-SUMMARY.md`

Summary must document:
- Number of SAFETY comments added (target: 27)
- List of files with new SAFETY comments
- Integration tests created (list test functions)
- Production code paths now tested
- Verification results
</output>
