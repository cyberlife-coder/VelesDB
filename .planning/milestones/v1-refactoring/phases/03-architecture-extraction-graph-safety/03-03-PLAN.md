---
phase: 03-architecture-extraction-graph-safety
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/index/hnsw/native/graph/mod.rs
  - crates/velesdb-core/src/index/hnsw/native/graph/insert.rs
  - crates/velesdb-core/src/index/hnsw/native/graph/search.rs
  - crates/velesdb-core/src/index/hnsw/native/graph/neighbors.rs
  - crates/velesdb-core/src/index/hnsw/native/graph/locking.rs
  - crates/velesdb-core/src/index/hnsw/native/graph/safety_counters.rs
  - crates/velesdb-core/src/index/hnsw/native_index.rs
  - crates/velesdb-core/src/index/hnsw/index/constructors.rs
  - crates/velesdb-core/src/index/hnsw/persistence.rs
autonomous: true
must_haves:
  truths:
    - "Concurrent HNSW operations complete without lock-order deadlocks in targeted tests"
    - "Lock-order and corruption signals are emitted through counters in release and debug builds"
    - "Saving/loading HNSW index state preserves existing persistence behavior"
  artifacts:
    - path: "crates/velesdb-core/src/index/hnsw/native/graph/locking.rs"
      provides: "Lock rank rules and acquisition checks"
    - path: "crates/velesdb-core/src/index/hnsw/native/graph/safety_counters.rs"
      provides: "Counters for contention/retry/invariant/corruption signals"
    - path: "crates/velesdb-core/src/index/hnsw/persistence.rs"
      provides: "Shared HNSW serde helper for index save/load paths"
  key_links:
    - from: "crates/velesdb-core/src/index/hnsw/native/graph/insert.rs"
      to: "crates/velesdb-core/src/index/hnsw/native/graph/locking.rs"
      via: "lock acquisition wrappers"
      pattern: "acquire_.*lock|lock_rank"
    - from: "crates/velesdb-core/src/index/hnsw/native_index.rs"
      to: "crates/velesdb-core/src/index/hnsw/persistence.rs"
      via: "shared serialize/deserialize helper"
      pattern: "hnsw::persistence"
---

<objective>
Refactor HNSW graph internals into coherent modules and harden concurrency safety with explicit lock-order enforcement and observability.

Purpose: Deliver QUAL-01 + BUG-04 + QUAL-02 (serialization-first dedup) with stable public behavior.
Output: Modular `native/graph/` implementation, runtime lock-order checker, always-on safety counters, and shared HNSW persistence helper.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-architecture-extraction-graph-safety/03-CONTEXT.md
@.planning/phases/03-architecture-extraction-graph-safety/03-RESEARCH.md
@crates/velesdb-core/src/index/hnsw/native/graph.rs
@crates/velesdb-core/src/index/hnsw/native/mod.rs
@crates/velesdb-core/src/index/hnsw/native_index.rs
@crates/velesdb-core/src/index/hnsw/index/constructors.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deduplicate HNSW serialization/deserialization paths first</name>
  <files>crates/velesdb-core/src/index/hnsw/native_index.rs, crates/velesdb-core/src/index/hnsw/index/constructors.rs, crates/velesdb-core/src/index/hnsw/persistence.rs</files>
  <action>Start with serialization/deserialization dedup (locked priority): extract repeated bincode metadata/id-mapping serialization logic into a shared internal helper module, then update both save/load call sites while preserving on-disk format compatibility and call-site readability.</action>
  <verify>cargo test -p velesdb-core index::hnsw::test_native_hnsw_save_load</verify>
  <done>Serde duplication across HNSW constructors/native index paths is consolidated first with persistence behavior parity.</done>
</task>

<task type="auto">
  <name>Task 2: Extract graph internals into concern-focused modules</name>
  <files>crates/velesdb-core/src/index/hnsw/native/graph/mod.rs, crates/velesdb-core/src/index/hnsw/native/graph/insert.rs, crates/velesdb-core/src/index/hnsw/native/graph/search.rs, crates/velesdb-core/src/index/hnsw/native/graph/neighbors.rs</files>
  <action>Convert monolithic graph internals into facade+submodules for insert/search/neighbor-management responsibilities. Keep external behavior and APIs stable while reducing file size and cognitive load. Enforce strict <=500-line target on extracted graph files with explicit temporary exception justification only if unavoidable.</action>
  <verify>cargo test -p velesdb-core index::hnsw::native::tests::</verify>
  <done>Graph logic is split into coherent files, extracted files meet the 500-line policy (or justified exception), and native HNSW tests remain green.</done>
</task>

<task type="auto">
  <name>Task 3: Implement lock-order runtime checker and observability counters</name>
  <files>crates/velesdb-core/src/index/hnsw/native/graph/locking.rs, crates/velesdb-core/src/index/hnsw/native/graph/safety_counters.rs, crates/velesdb-core/src/index/hnsw/native/graph/mod.rs, crates/velesdb-core/src/index/hnsw/native/graph/insert.rs, crates/velesdb-core/src/index/hnsw/native/graph/search.rs</files>
  <action>Define explicit lock-rank invariant (vectors -> layers -> neighbors) and enforce it via runtime checker hooks on multi-lock code paths. Add essential counters for contention, failed/retried operations, and detected corruption/invariant incidents. Keep checks/counters active in release where feasible; only gate expensive deep scans behind debug/test with explicit cost/benefit justification.</action>
  <verify>cargo test -p velesdb-core index::hnsw::native::tests::test_hnsw_no_deadlock_during_parallel_insert_search && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Lock ordering is executable and auditable with release-parity observability counters and passing safety regressions.</done>
</task>

</tasks>

<verification>
`cargo test -p velesdb-core index::hnsw`
`cargo clippy -p velesdb-core -- -D warnings`
</verification>

<success_criteria>
- `graph.rs` extraction introduces clear submodules and reduces monolithic structure.
- BUG-04 lock-order safety is enforced by runtime checks and observable counters.
- Serde dedup is completed first across targeted HNSW persistence paths.
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-extraction-graph-safety/03-03-SUMMARY.md`
</output>
