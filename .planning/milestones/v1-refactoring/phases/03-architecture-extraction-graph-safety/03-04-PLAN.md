---
phase: 03-architecture-extraction-graph-safety
plan: 04
type: execute
wave: 2
depends_on: [03-03]
files_modified:
  - crates/velesdb-core/src/index/hnsw/native/tests.rs
  - crates/velesdb-core/src/index/hnsw/native/graph_tests.rs
  - crates/velesdb-core/src/storage/tests.rs
  - crates/velesdb-core/src/storage/loom_tests.rs
  - crates/velesdb-core/src/storage/guard.rs
autonomous: true
must_haves:
  truths:
    - "Concurrent insert/search/delete behavior is validated under stress with invariant assertions"
    - "VectorSliceGuard behavior is verified during resize/remap and snapshot consistency checks"
    - "New safety counters and lock checks are exercised by concurrency tests"
  artifacts:
    - path: "crates/velesdb-core/src/index/hnsw/native/tests.rs"
      provides: "Parallel insert/search contention tests"
    - path: "crates/velesdb-core/src/storage/tests.rs"
      provides: "Resize plus snapshot consistency integration tests"
    - path: "crates/velesdb-core/src/storage/loom_tests.rs"
      provides: "Deterministic interleaving checks for guard/epoch invariants"
  key_links:
    - from: "crates/velesdb-core/src/index/hnsw/native/tests.rs"
      to: "crates/velesdb-core/src/index/hnsw/native/graph/locking.rs"
      via: "concurrency tests trigger lock-order paths"
      pattern: "parallel|concurrent|deadlock"
    - from: "crates/velesdb-core/src/storage/tests.rs"
      to: "crates/velesdb-core/src/storage/guard.rs"
      via: "resize/remap epoch guard assertions"
      pattern: "epoch|remap|resize"
---

<objective>
Add concurrency verification coverage that proves graph safety and storage guard correctness under the required concurrent scenarios.

Purpose: Deliver TEST-02 and honor locked context requiring both concurrency families (parallel insert/search/delete and resize + snapshot consistency).
Output: Deterministic and stress-oriented concurrency tests with explicit invariant assertions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-architecture-extraction-graph-safety/03-CONTEXT.md
@.planning/phases/03-architecture-extraction-graph-safety/03-RESEARCH.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-01-SUMMARY.md
@crates/velesdb-core/src/index/hnsw/native/tests.rs
@crates/velesdb-core/src/storage/tests.rs
@crates/velesdb-core/src/storage/loom_tests.rs
@crates/velesdb-core/src/storage/guard.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parallel insert/search/delete concurrency suite for HNSW</name>
  <files>crates/velesdb-core/src/index/hnsw/native/tests.rs, crates/velesdb-core/src/index/hnsw/native/graph_tests.rs</files>
  <action>Implement concurrency tests that cover (a) insert/search contention at native graph level and (b) delete-aware contention at index level (`HnswIndex::remove` soft-delete paths) to satisfy the locked two-family coverage requirement. Use deterministic post-conditions (result counts, graph consistency, no deadlock) rather than sleep-only checks.</action>
  <verify>cargo test -p velesdb-core index::hnsw::native::tests:: -- --test-threads=1</verify>
  <done>Concurrency family 1 exists with explicit assertions for correctness and progress under parallel insert/search/delete operations.</done>
</task>

<task type="auto">
  <name>Task 2: Add resize plus snapshot consistency tests for VectorSliceGuard</name>
  <files>crates/velesdb-core/src/storage/tests.rs, crates/velesdb-core/src/storage/loom_tests.rs, crates/velesdb-core/src/storage/guard.rs</files>
  <action>Create integration and loom-backed scenarios validating `VectorSliceGuard` behavior during mmap resize/remap and snapshot reads. Assert epoch invalidation behavior, stale-guard rejection, and snapshot consistency invariants after concurrent resize operations. Keep assertions explicit and reproducible.</action>
  <verify>cargo test -p velesdb-core storage::tests:: && cargo +nightly test -p velesdb-core --features loom storage::loom_tests::</verify>
  <done>Concurrency family 2 is covered with deterministic resize/snapshot assertions that protect against stale guard access and silent corruption.</done>
</task>

<task type="auto">
  <name>Task 3: Run focused safety regression and phase quality checks</name>
  <files>crates/velesdb-core/src/index/hnsw/native/tests.rs, crates/velesdb-core/src/storage/tests.rs</files>
  <action>Execute targeted concurrency suites plus strict linting to validate extracted graph safety and storage guard behavior end-to-end. Ensure counters/invariants introduced in Plan 03-03 are exercised and no regressions are introduced by test harness changes.</action>
  <verify>cargo clippy -p velesdb-core -- -D warnings && cargo test -p velesdb-core index::hnsw::native::tests:: storage::tests::</verify>
  <done>All newly added concurrency tests pass, strict linting remains clean, and phase safety objectives are verifiably enforced.</done>
</task>

</tasks>

<verification>
`cargo test -p velesdb-core index::hnsw::native::tests:: -- --test-threads=1`
`cargo test -p velesdb-core storage::tests::`
`cargo +nightly test -p velesdb-core --features loom storage::loom_tests::`
`cargo clippy -p velesdb-core -- -D warnings`
</verification>

<success_criteria>
- Both locked concurrency test families are implemented and passing.
- Resize/remap guard safety is asserted via deterministic invariants.
- HNSW concurrency checks remain deadlock-safe and regression-resistant.
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-extraction-graph-safety/03-04-SUMMARY.md`
</output>
