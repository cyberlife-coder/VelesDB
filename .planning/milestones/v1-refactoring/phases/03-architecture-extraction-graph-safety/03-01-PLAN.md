---
phase: 03-architecture-extraction-graph-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/simd_native/mod.rs
  - crates/velesdb-core/src/simd_native/dispatch.rs
  - crates/velesdb-core/src/simd_native/scalar.rs
  - crates/velesdb-core/src/simd_native/x86_avx2.rs
  - crates/velesdb-core/src/simd_native/x86_avx512.rs
  - crates/velesdb-core/src/simd_native/neon.rs
  - crates/velesdb-core/src/simd_native/prefetch.rs
  - crates/velesdb-core/src/simd_native/tail_unroll.rs
autonomous: true
must_haves:
  truths:
    - "Existing callers can compute distances without API changes after extraction"
    - "SIMD and scalar paths return equivalent outputs for covered regression inputs"
    - "Build/test flows complete without SIMD dispatch regressions"
  artifacts:
    - path: "crates/velesdb-core/src/simd_native/mod.rs"
      provides: "Stable facade for SIMD API"
    - path: "crates/velesdb-core/src/simd_native/dispatch.rs"
      provides: "Runtime SIMD level detection and dispatch wiring"
    - path: "crates/velesdb-core/src/simd_native/scalar.rs"
      provides: "Scalar fallback implementations"
  key_links:
    - from: "crates/velesdb-core/src/simd_native/mod.rs"
      to: "crates/velesdb-core/src/simd_native/dispatch.rs"
      via: "pub(crate) dispatch helpers"
      pattern: "mod dispatch|use crate::simd_native::dispatch"
    - from: "crates/velesdb-core/src/simd_native/dispatch.rs"
      to: "crates/velesdb-core/src/simd_native/x86_avx2.rs"
      via: "ISA-specific function dispatch"
      pattern: "is_x86_feature_detected|avx2"
---

<objective>
Extract the oversized SIMD implementation into a facade-first module tree while preserving all existing behavior and call-site compatibility.

Purpose: Deliver QUAL-01 modularity for SIMD without regressions in hot-path distance operations.
Output: `simd_native/` submodules with stable API surface and passing SIMD regressions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-architecture-extraction-graph-safety/03-CONTEXT.md
@.planning/phases/03-architecture-extraction-graph-safety/03-RESEARCH.md
@crates/velesdb-core/src/simd_native.rs
@crates/velesdb-core/src/simd_native_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SIMD facade-first module layout</name>
  <files>crates/velesdb-core/src/simd_native.rs, crates/velesdb-core/src/simd_native/mod.rs, crates/velesdb-core/src/simd_native/scalar.rs, crates/velesdb-core/src/simd_native/tail_unroll.rs, crates/velesdb-core/src/simd_native/prefetch.rs</files>
  <action>Convert `simd_native.rs` into directory module form with `mod.rs` facade preserving exported function names/signatures. Move scalar fallbacks, tail/remainder helpers, and prefetch helpers into responsibility-specific files. Keep public API behavior stable (no breaking API behavior per locked decision) and enforce naming readability (ISA visibility + responsibility clarity).</action>
  <verify>cargo test -p velesdb-core simd_native_tests</verify>
  <done>SIMD module compiles through `mod.rs` facade, moved helpers are in coherent files, and existing SIMD unit tests pass without API call-site updates outside intended module wiring.</done>
</task>

<task type="auto">
  <name>Task 2: Extract ISA kernels and dispatch wiring</name>
  <files>crates/velesdb-core/src/simd_native/mod.rs, crates/velesdb-core/src/simd_native/dispatch.rs, crates/velesdb-core/src/simd_native/x86_avx2.rs, crates/velesdb-core/src/simd_native/x86_avx512.rs, crates/velesdb-core/src/simd_native/neon.rs</files>
  <action>Move AVX2, AVX512, and NEON kernels from monolith into ISA-specific modules. Implement dispatch wiring in `dispatch.rs` with unchanged runtime feature-detection semantics. Keep safety comments and clamp behavior intact; do not alter algorithmic outputs. Favor incremental compile-safe moves over one-shot rewrites to reduce regression risk.</action>
  <verify>cargo test -p velesdb-core simd_native_tests -- --nocapture</verify>
  <done>ISA-specific files own their kernels, dispatch routes correctly to available backend, and output parity remains with existing test coverage.</done>
</task>

<task type="auto">
  <name>Task 3: Enforce module-size objective and quality gates for SIMD extraction</name>
  <files>crates/velesdb-core/src/simd_native/mod.rs, crates/velesdb-core/src/simd_native_tests.rs</files>
  <action>Finalize cleanup to keep extracted source files at or under the 500-line target where feasible, with explicit temporary justification comments only if a file must exceed the limit transiently. Update/add focused regression assertions only where extraction moved logic boundaries. Run strict lint/test checks for this surface.</action>
  <verify>cargo clippy -p velesdb-core -- -D warnings && cargo test -p velesdb-core simd_native_tests</verify>
  <done>SIMD extraction is lint-clean, behavior-preserving, and split into maintainable submodules aligned with the phase maintainability goal.</done>
</task>

</tasks>

<verification>
`cargo test -p velesdb-core simd_native_tests`
`cargo clippy -p velesdb-core -- -D warnings`
</verification>

<success_criteria>
- `simd_native.rs` no longer holds the full monolithic implementation.
- New `simd_native/` files expose stable facade and coherent internal boundaries.
- SIMD regressions remain green with no public API behavior break.
</success_criteria>

<output>
After completion, create `.planning/phases/03-architecture-extraction-graph-safety/03-01-SUMMARY.md`
</output>
