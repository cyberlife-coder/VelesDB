---
phase: 4
plan: 5
name: "Module Split — index + storage (3 files, hot-path)"
wave: 2
depends_on: []
autonomous: true
---

# Phase 4 Plan 05: Module Split — index + storage (hot-path)

## Objective

Split the 3 oversized files in `index/` and `storage/` into focused submodules. These are **hot-path** files — performance-critical code paths for distance computation, HNSW search, and mmap storage. Splitting must preserve inlining and zero-cost abstractions.

## Targets

| File | Lines | Split Strategy |
|------|------:|---------------|
| `index/hnsw/native/distance.rs` | 794 | metric implementations, batch ops, distance caching |
| `storage/mmap.rs` | 683 | file management, mmap lifecycle, read/write, compaction interface |
| `index/trigram/simd.rs` | 561 | SIMD kernels, trigram matching, scoring |

**Total: 2038 lines → target ~8 submodules, all <500 lines**

## Tasks

### Task 1: Split `index/hnsw/native/distance.rs` (794 lines)

Convert to `distance/` directory module:
- `mod.rs` — `DistanceCalculator` trait/struct + facade re-exports
- `metrics.rs` — individual metric implementations (cosine, euclidean, dot, hamming, jaccard)
- `batch.rs` — batch distance operations, SIMD dispatch
- `cache.rs` — distance cache (if present)

**Performance constraint:** All distance functions must remain `#[inline]` or `#[inline(always)]`. Verify no regression with:
```powershell
cargo bench --bench hnsw_benchmark -- --save-baseline before_split
```

### Task 2: Split `storage/mmap.rs` (683 lines)

Convert to `mmap/` directory module:
- `mod.rs` — `MmapStorage` struct definition + facade
- `lifecycle.rs` — open, close, resize, remap operations
- `io.rs` — read, write, retrieve operations
- `compaction.rs` — compaction interface (delegate to `compaction.rs`)

**Safety constraint:** All `unsafe` blocks must keep their `// SAFETY:` comments intact. Verify epoch guard logic preserved.

### Task 3: Split `index/trigram/simd.rs` (561 lines)

Convert to `simd/` directory module within trigram:
- `mod.rs` — facade + SIMD level detection
- `kernels.rs` — SIMD trigram matching kernels
- `scoring.rs` — SIMD-accelerated scoring

## Verification

```powershell
cargo check --workspace
cargo test -p velesdb-core hnsw
cargo test -p velesdb-core storage
cargo test -p velesdb-core trigram
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] 3 files converted to directory modules
- [ ] All submodules <500 lines
- [ ] Zero performance regression (benchmarks stable)
- [ ] All `// SAFETY:` comments preserved
- [ ] All workspace tests pass
