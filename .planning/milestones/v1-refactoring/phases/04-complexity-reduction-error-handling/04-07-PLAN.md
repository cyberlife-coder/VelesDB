---
phase: 4
plan: 7
name: "Clippy Pedantic Remediation (476 → 0)"
wave: 3
depends_on: ["04-02", "04-03", "04-04", "04-05", "04-06"]
autonomous: true
---

# Phase 4 Plan 07: Clippy Pedantic Remediation

## Objective

Fix all 476 clippy pedantic warnings and activate `clippy::pedantic` as a workspace-level lint. After this plan, any new pedantic warning is a CI-breaking error. Exceptions are documented case-by-case with `#[allow]` + `// Reason:`.

**Important:** This plan runs AFTER all module splitting (04-02 to 04-06) because splitting may introduce new warnings or resolve existing ones. Running pedantic cleanup on the final module structure avoids rework.

## Warning Inventory (pre-split baseline)

| Count | Category | Fix Strategy |
|------:|----------|-------------|
| 344 | Missing backticks in docs | `cargo clippy --fix` (auto-fixable) |
| 57 | Missing `# Errors` section | Manual: add `# Errors` to each `fn → Result` |
| 26 | Format! inline variables | `cargo clippy --fix` (auto-fixable) |
| 10 | `From` instead of `as` cast | Manual: `u32::from(x)` instead of `x as u32` |
| 8 | `let...else` candidates | Manual: convert `if let` to `let...else` |
| 8 | Unused `self` argument | Manual: convert to associated function or document reason |
| 6 | Missing trailing semicolon | `cargo clippy --fix` (auto-fixable) |
| 5 | `if let` instead of `match` | Manual: simplify pattern matching |
| 5 | Pointer constness casts | Manual: use `.cast_const()` / `.cast_mut()` |
| 3 | `HashSet` generalization | Manual: use `impl BuildHasher` parameter |
| 2 | Wildcard imports | Manual: expand to explicit imports |
| 2 | Field postfix naming | Manual: rename or document |

## Tasks

### Task 1: Auto-fix batch (376 warnings)

Run clippy auto-fix for the auto-fixable categories:

```powershell
cargo clippy --fix --lib -p velesdb-core --allow-dirty -- -W clippy::pedantic
```

This should auto-fix:
- 344 missing backticks
- 26 format! inline vars
- 6 trailing semicolons

**Verify:** `cargo clippy -p velesdb-core -- -W clippy::pedantic 2>&1 | Select-String "warning" | Measure-Object`

### Task 2: Add `# Errors` documentation (57 functions)

For each function returning `Result` that lacks `# Errors`:

```rust
/// Does something important.
///
/// # Errors
///
/// Returns [`Error::VariantName`] if [condition].
pub fn do_thing() -> Result<T, Error> { ... }
```

**Files (13):**
- `agent/episodic_memory.rs` (10 functions)
- `agent/procedural_memory.rs` (10 functions)
- `agent/memory.rs` (8 functions)
- `agent/semantic_memory.rs` (7 functions)
- `guardrails.rs` (7 functions)
- `column_store/mod.rs` (3 functions) — may have moved to submodule after 04-06
- `velesql/parser/match_clause.rs` (3 functions)
- `collection/graph/schema.rs` (2 functions)
- `collection/search/query/match_exec.rs` (2 functions)
- `column_store/batch.rs` (2 functions)
- `collection/auto_reindex/mod.rs` (1 function)
- `collection/core/index_management.rs` (1 function)
- `collection/search/query/aggregation.rs` (1 function)

### Task 3: Manual fixes (43 remaining warnings)

Fix each category:

**`From` instead of `as` (10):**
```rust
// Before
let x = val as u64;
// After
let x = u64::from(val);
```

**`let...else` (8):**
```rust
// Before
let val = if let Some(v) = opt { v } else { return None; };
// After
let Some(val) = opt else { return None; };
```

**Unused `self` (8):**
- Convert to associated functions (`fn foo()` instead of `fn foo(&self)`)
- OR add `#[allow(clippy::unused_self)] // Reason: future use / trait conformance`

**`if let` vs `match` (5):**
```rust
// Before
match result { Ok(v) => v, _ => return }
// After
let Ok(v) = result else { return };
```

**Pointer constness (5):**
```rust
// Before
ptr as *const f32
// After
ptr.cast_const()
```

**HashSet generalization (3):**
```rust
// Before
fn foo(set: &HashSet<u64>) -> ...
// After
fn foo(set: &HashSet<u64, impl BuildHasher>) -> ...
```
Or `#[allow]` with Reason if generalization would break API.

**Wildcard imports (2):**
```rust
// Before
use std::arch::x86_64::*;
// After — for SIMD this is standard, allow with reason
#[allow(clippy::wildcard_imports)]
// Reason: SIMD intrinsics require wildcard import (hundreds of symbols)
use std::arch::x86_64::*;
```

**Field postfix (2):**
Evaluate if rename is safe or document with `#[allow]`.

### Task 4: Enable pedantic as workspace lint

Add to `Cargo.toml` (workspace level):

```toml
[workspace.lints.clippy]
pedantic = { level = "warn", priority = -1 }
# Exceptions documented here
module_name_repetitions = "allow"  # Common Rust pattern
```

Or in `lib.rs`:
```rust
#![warn(clippy::pedantic)]
#![allow(clippy::module_name_repetitions)] // Reason: standard Rust naming convention
```

Update AGENTS.md with the exception list.

### Task 5: Final verification — zero warnings

```powershell
cargo clippy --workspace -- -D warnings -W clippy::pedantic
```

Must exit 0.

## Verification

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings -W clippy::pedantic
cargo test --workspace
```

## Success Criteria

- [ ] Zero clippy pedantic warnings
- [ ] `clippy::pedantic` enabled as workspace lint
- [ ] 57 functions have `# Errors` documentation
- [ ] All auto-fixes applied cleanly
- [ ] Exception list documented in AGENTS.md
- [ ] All workspace tests pass
