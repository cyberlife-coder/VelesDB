---
phase: 4
plan: 9
name: "GPU Error Handling Tests"
wave: 4
depends_on: ["04-01"]
autonomous: true
---

# Phase 4 Plan 09: GPU Error Handling Tests

## Objective

Add comprehensive tests verifying graceful degradation when GPU is unavailable or operations fail. Currently, all GPU tests only cover happy paths. This plan ensures no panics occur on GPU errors and that the fallback to CPU SIMD is seamless.

**Dependency:** Plan 04-01 must be completed first (GPU functions return Result instead of panicking).

## Context

**Requirements addressed:** TEST-03
**Existing tests:** `gpu_tests.rs` (28 lines), `gpu/gpu_backend_tests.rs` (180 lines) — happy path only.

## Tasks

### Task 1: Test GPU unavailability graceful fallback

**File:** `crates/velesdb-core/src/gpu_tests.rs`

Add tests:
1. **`test_compute_backend_fallback_to_simd`** — `ComputeBackend::best_available()` returns `Simd` when no GPU
2. **`test_gpu_accelerator_none_without_gpu`** — `GpuAccelerator::new()` returns `None` gracefully
3. **`test_gpu_available_consistency`** — `is_available()` returns consistent results across calls

### Task 2: Test GPU parameter validation errors

**File:** `crates/velesdb-core/src/gpu/gpu_backend_tests.rs`

Add tests for error paths from Plan 04-01:
1. **`test_batch_cosine_zero_dimension`** — dimension=0 returns empty or error
2. **`test_batch_cosine_dimension_mismatch`** — query dim ≠ declared dimension
3. **`test_batch_euclidean_empty_vectors`** — empty input returns empty results
4. **`test_batch_dot_product_single_element`** — edge case dimension=1
5. **`test_batch_cosine_large_batch`** — 1000+ vectors processes or returns error

All tests must use `#[serial(gpu)]`.

### Task 3: Test edge-case inputs (no-panic guarantee)

**File:** `crates/velesdb-core/src/gpu/gpu_backend_tests.rs`

```rust
#[test]
#[serial(gpu)]
fn test_gpu_no_panic_on_edge_inputs() {
    if let Some(gpu) = GpuAccelerator::new() {
        let cases: Vec<(Vec<f32>, Vec<f32>, usize)> = vec![
            (vec![], vec![], 0),
            (vec![1.0], vec![1.0], 1),
            (vec![f32::NAN], vec![1.0], 1),
            (vec![f32::INFINITY], vec![1.0], 1),
            (vec![0.0; 1024], vec![0.0; 1024], 1024),
        ];
        for (vectors, query, dim) in cases {
            let _ = gpu.batch_cosine_similarity(&vectors, &query, dim);
            let _ = gpu.batch_euclidean_distance(&vectors, &query, dim);
            let _ = gpu.batch_dot_product(&vectors, &query, dim);
        }
    }
}
```

## Verification

```powershell
cargo test -p velesdb-core gpu
cargo test -p velesdb-core gpu_backend
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] GPU unavailability tested — graceful fallback verified
- [ ] Parameter validation errors tested — no panics on invalid inputs
- [ ] Edge-case inputs (NaN, Inf, empty, zero-dim) tested — no panics
- [ ] All tests pass on both GPU and non-GPU environments
- [ ] All workspace tests pass
