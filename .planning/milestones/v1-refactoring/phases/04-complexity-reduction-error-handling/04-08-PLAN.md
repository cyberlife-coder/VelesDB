---
phase: 4
plan: 8
name: "Production Hardening — expects, bare-string errors, complexity"
wave: 3
depends_on: ["04-01", "04-02", "04-03", "04-04", "04-05", "04-06"]
autonomous: true
---

# Phase 4 Plan 08: Production Hardening

## Objective

Eliminate all remaining production-quality issues: convert `.expect()` calls to proper error handling, replace bare-string error constructions with structured error variants, and reduce the one cognitive complexity violation. This plan runs after module splitting to work on the final file structure.

## Targets

### A. Production `.expect()` calls (20 total)

| Count | File | Risk |
|------:|------|------|
| 6 | `velesql/aggregator.rs` | Medium — HashMap sync assumptions |
| 3 | `perf_optimizations.rs` | Medium — optimization paths + 1 panic! |
| 3 | `collection/core/statistics.rs` | Low — u64 fits |
| 2 | `index/hnsw/native_index.rs` | Medium — index ops |
| 2 | `index/hnsw/native/dual_precision.rs` | Medium — precision |
| 2 | `storage/mmap.rs` | High — storage ops |
| 2 | `velesql/parser/select/clause_from_join.rs` | Low — parser |

### B. Bare-string error constructions (64 total)

| Count | File |
|------:|------|
| 9 | `agent/procedural_memory.rs` |
| 9 | `collection/search/query/extraction.rs` |
| 8 | `agent/episodic_memory.rs` |
| 6 | `collection/graph/schema.rs` |
| 6 | `collection/search/query/match_exec.rs` |
| 5 | `agent/semantic_memory.rs` |
| 5 | `collection/search/batch.rs` |
| 4 | `agent/memory.rs` |
| 4 | `collection/async_ops.rs` |
| 4 | `storage/async_ops.rs` |
| 3 | `agent/snapshot.rs` |
| 1 | `collection/search/query/aggregation.rs` |

### C. Cognitive complexity (1 violation)

| Function | Score | File |
|----------|------:|------|
| `dot_product_avx2_4acc` | 37/25 | `simd_native/x86_avx2.rs:38` |

## Tasks

### Task 1: Convert `.expect()` to proper error handling (20 calls)

For each `.expect()`, evaluate:

**Option A — Convert to `?` with context (preferred):**
```rust
// Before
let val = map.get(key).expect("key must exist");
// After
let val = map.get(key).ok_or_else(|| Error::InternalError(
    format!("aggregator: key '{}' missing from synchronized map", key)
))?;
```

**Option B — Keep with `// Reason:` if truly invariant:**
```rust
// Reason: HashMap is initialized with all keys in new(); missing key is a logic bug
let val = map.get(key).expect("counts synced with sums");
```

Decision per file:
- `aggregator.rs` (6): Option B — these are synchronized HashMap invariants, document with `// Reason:`
- `perf_optimizations.rs` (3 + 1 panic): Option A — convert panic and expects to Result
- `statistics.rs` (3): Option B — `u64::try_from` on point_count is always safe, document
- `hnsw/native_index.rs` (2): Evaluate — may need Result propagation
- `hnsw/native/dual_precision.rs` (2): Evaluate — precision invariants
- `storage/mmap.rs` (2): Option A — storage errors must be recoverable
- `parser/clause_from_join.rs` (2): Option B — parser internal invariant

### Task 2: Replace bare-string errors with structured variants (64 calls)

Pattern to follow:

```rust
// Before
return Err(Error::QueryError(format!("column '{}' not found", name)));

// After — use existing variant with structured context
return Err(Error::QueryError(format!(
    "column '{}' not found in table '{}' (available: {:?})",
    name, table, available_columns
)));
```

Or if a new variant is warranted:
```rust
// In error.rs
#[error("[VELES-027] Column not found: {column} in {table}")]
ColumnNotFound { column: String, table: String },
```

**Strategy:**
- Group the 64 sites by error category
- For each category, decide: improve message context OR create structured variant
- Prioritize: agent module (30 sites), query module (21 sites), storage (8 sites), other (5 sites)
- Add error codes (VELES-024+) for new variants

### Task 3: Reduce cognitive complexity of `dot_product_avx2_4acc` (37 → <25)

Extract remainder handling into helper:

```rust
/// Process AVX2 dot product remainder (0-31 elements after main 4-acc loop).
///
/// # Safety
/// Requires AVX2+FMA. Pointers within `a[base..]` and `b[base..]` must be valid.
#[cfg(target_arch = "x86_64")]
#[target_feature(enable = "avx2", enable = "fma")]
#[inline]
unsafe fn dot_avx2_remainder(a: &[f32], b: &[f32], base: usize, remainder: usize) -> f32 {
    // 16-element, 8-element, and scalar tail handling moved here
}
```

**Verify:**
```powershell
cargo clippy -p velesdb-core -- -W clippy::cognitive_complexity 2>&1 | Select-String "cognitive"
```
Expected: no output (0 violations).

### Task 4: Audit remaining `as` casts in high-risk files

The 266 `as` casts in non-SIMD code were partially addressed in Phase 1. Audit the top offenders:
- `collection/graph/cart.rs` (33 casts) — verify all have `#[allow]` + Reason
- `index/hnsw/native/backend_adapter.rs` (24 casts) — verify bounds checks
- `metrics.rs` (14 casts) — verify safe widening only

For each unjustified cast, either:
- Replace with `From`/`TryFrom`
- Add `#[allow(clippy::cast_possible_truncation)] // Reason: value bounded by [...]`

## Verification

```powershell
cargo fmt --all
cargo clippy --workspace -- -D warnings -W clippy::cognitive_complexity
cargo test --workspace
```

## Success Criteria

- [ ] All `.expect()` calls either converted to Result or documented with `// Reason:`
- [ ] All 64 bare-string errors improved (better context or structured variants)
- [ ] `dot_product_avx2_4acc` complexity reduced below 25
- [ ] Top `as`-cast files audited and justified
- [ ] Zero cognitive complexity warnings
- [ ] All workspace tests pass
- [ ] `perf_optimizations.rs` panic removed
