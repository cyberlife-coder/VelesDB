---
phase: 4
plan: 4
name: "Module Split — collection/search/query (5 files)"
wave: 2
depends_on: []
autonomous: true
---

# Phase 4 Plan 04: Module Split — collection/search/query

## Objective

Split the 5 oversized files in `collection/search/query/` into focused submodules. This is the query engine — the most complex subsystem — and requires careful splitting to maintain internal coherence.

## Targets

| File | Lines | Split Strategy |
|------|------:|---------------|
| `match_exec.rs` | 844 | pattern matching, execution engine, result building |
| `mod.rs` | 832 | Already a directory mod — extract more submodules from it |
| `aggregation.rs` | 814 | grouping, windowing, final aggregation, combiners |
| `parallel_traversal.rs` | 808 | work distribution, parallel execution, result merging |
| `score_fusion.rs` | 789 | fusion strategies, normalization, ranking |

**Total: 4087 lines → target ~15 submodules, all <500 lines**

## Tasks

### Task 1: Split `match_exec.rs` (844 lines)

Convert to `match_exec/` directory module:
- `mod.rs` — `MatchExecutor` struct + facade
- `pattern.rs` — pattern matching and graph traversal logic
- `execution.rs` — execution pipeline, step evaluation
- `results.rs` — result construction and formatting

### Task 2: Extract from `mod.rs` (832 lines)

`mod.rs` is already a directory facade but contains too much logic. Extract:
- `builder.rs` — query builder pattern (if mixed in mod.rs)
- `context.rs` — query execution context and state
- Keep `mod.rs` as pure facade (<200 lines ideally)

### Task 3: Split `aggregation.rs` (814 lines)

Convert to `aggregation/` directory module:
- `mod.rs` — `Aggregator` trait + facade
- `grouping.rs` — GROUP BY logic, hash grouping
- `window.rs` — window functions (if present)
- `combiners.rs` — SUM, COUNT, AVG, MIN, MAX implementations

### Task 4: Split `parallel_traversal.rs` (808 lines)

Convert to `parallel_traversal/` directory module:
- `mod.rs` — facade + public API
- `distribution.rs` — work partitioning and scheduling
- `execution.rs` — parallel execution with rayon
- `merge.rs` — result merging and deduplication

### Task 5: Split `score_fusion.rs` (789 lines)

Convert to `score_fusion/` directory module:
- `mod.rs` — `FusionStrategy` trait + facade
- `strategies.rs` — RRF, weighted, etc.
- `normalization.rs` — score normalization methods
- `ranking.rs` — final ranking and top-k

## Verification

```powershell
cargo check --workspace
cargo test -p velesdb-core query
cargo fmt --all
cargo clippy --workspace -- -D warnings
cargo test --workspace
```

## Success Criteria

- [ ] 5 files converted to directory modules or reduced below 500 lines
- [ ] All submodules <500 lines
- [ ] Zero public API changes
- [ ] All query/search tests pass
- [ ] All workspace tests pass
