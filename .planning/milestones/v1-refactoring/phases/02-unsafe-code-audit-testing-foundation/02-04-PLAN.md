---
phase: 02-unsafe-code-audit-testing-foundation
plan: 04
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - crates/velesdb-core/src/simd_native.rs
  - crates/velesdb-core/src/index/hnsw/vector_store.rs
  - crates/velesdb-core/src/index/hnsw/index/vacuum.rs
  - scripts/verify_unsafe_safety_template.py
  - .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "In-scope unsafe usage in the failed verifier scope is auditable via per-site template-complete SAFETY comments"
    - "Legacy `SAFETY (...)` comment style is fully removed from targeted in-scope unsafe sites"
    - "Unsafe SAFETY coverage can be re-verified objectively with a repeatable command that fails on missing template fields"
  artifacts:
    - path: "crates/velesdb-core/src/simd_native.rs"
      provides: "Per-unsafe-block AGENTS-template SAFETY comments at uncovered dispatch and NEON unsafe callsites"
      contains: "// SAFETY:"
    - path: "crates/velesdb-core/src/index/hnsw/vector_store.rs"
      provides: "Normalized SAFETY template above unsafe prefetch block"
      contains: "// Reason:"
    - path: "crates/velesdb-core/src/index/hnsw/index/vacuum.rs"
      provides: "Normalized SAFETY template above unsafe ManuallyDrop::drop block"
      contains: "// Reason:"
    - path: "scripts/verify_unsafe_safety_template.py"
      provides: "Deterministic SAFETY coverage checker for in-scope unsafe blocks/impls"
      min_lines: 60
    - path: ".planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md"
      provides: "Updated closure evidence and command output for SAFETY-template re-verification"
  key_links:
    - from: "scripts/verify_unsafe_safety_template.py"
      to: "crates/velesdb-core/src/simd_native.rs"
      via: "Regex scan over `unsafe {}`/`unsafe impl` with adjacency checks for SAFETY + condition bullets + Reason"
      pattern: "unsafe\\s*(\\{|impl)"
    - from: "scripts/verify_unsafe_safety_template.py"
      to: ".planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md"
      via: "Uses inventory-listed in-scope files as verification target set"
      pattern: "file:\\s+crates/velesdb-core/src/"
    - from: "02-04 plan verification command"
      to: "RUST-04 closure"
      via: "Script exits non-zero when template fields are missing, making gaps objectively detectable"
      pattern: "python scripts/verify_unsafe_safety_template.py"
---

<objective>
Close the Phase 02 verifier gap by making SAFETY documentation coverage objectively complete and machine-checkable for the failed in-scope unsafe audit surface.

Purpose: Satisfy the failed truth for RUST-04 without reopening completed parser/property-test work from 02-02/02-03.
Output: Template-complete per-site SAFETY comments at remaining gaps, normalized legacy comment style, and a repeatable verification script.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-code-audit-testing-foundation-VERIFICATION.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-01-SUMMARY.md
@crates/velesdb-core/src/simd_native.rs
@crates/velesdb-core/src/index/hnsw/vector_store.rs
@crates/velesdb-core/src/index/hnsw/index/vacuum.rs
@AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic SAFETY-template verifier script first</name>
  <files>
    scripts/verify_unsafe_safety_template.py
  </files>
  <action>
    Create `scripts/verify_unsafe_safety_template.py` before other task verification steps so later task-level checks are runnable.

    Script requirements:
    - Scan Rust targets for `unsafe {}` and `unsafe impl`.
    - Validate adjacent template completeness: SAFETY header, condition bullet(s), and Reason line.
    - Support `--files ...` targeted mode and `--inventory ...` mode.
    - Exit non-zero and print file:line diagnostics when requirements are missing.
  </action>
  <verify>python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/simd_native.rs --strict</verify>
  <done>Script exists, runs successfully, and is available for downstream task verification.</done>
</task>

<task type="auto">
  <name>Task 2: Add missing template-complete SAFETY docs at uncovered SIMD unsafe sites</name>
  <files>
    crates/velesdb-core/src/simd_native.rs
  </files>
  <action>
    Patch every uncovered unsafe block in `simd_native.rs` that still lacks an adjacent AGENTS-template SAFETY comment (including verifier-highlighted regions around dispatch and inline NEON callsites).

    For each site, use the full template directly above the unsafe operation:
    - `// SAFETY: ...`
    - one or more condition bullets (`// - Condition ...` or equivalent invariant bullets)
    - `// Reason: ...`

    Do not change runtime behavior, algorithm choice, signatures, feature gates, or SIMD dispatch logic; this task is documentation hardening only (zero breaking changes).
  </action>
  <verify>python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/simd_native.rs --strict</verify>
  <done>All unsafe blocks in `simd_native.rs` pass strict template checks with adjacent SAFETY + conditions + Reason fields.</done>
</task>

<task type="auto">
  <name>Task 3: Normalize remaining legacy SAFETY comment style in HNSW files</name>
  <files>
    crates/velesdb-core/src/index/hnsw/vector_store.rs
    crates/velesdb-core/src/index/hnsw/index/vacuum.rs
  </files>
  <action>
    Replace legacy `SAFETY (...)` style comments at the known gap sites with template-complete AGENTS format.

    Required targets:
    - `vector_store.rs` unsafe prefetch block near verifier line reference 239
    - `vacuum.rs` unsafe `ManuallyDrop::drop` block near verifier line reference 160

    Keep invariant content accurate to actual code behavior (BUG-02 closure requirement) and avoid editing unrelated HNSW logic.
  </action>
  <verify>python scripts/verify_unsafe_safety_template.py --files crates/velesdb-core/src/index/hnsw/vector_store.rs crates/velesdb-core/src/index/hnsw/index/vacuum.rs --strict</verify>
  <done>Targeted HNSW unsafe sites no longer use legacy style and now pass strict SAFETY-template validation.</done>
</task>

<task type="auto">
  <name>Task 4: Record closure evidence and run full gap quality gates</name>
  <files>
    .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md
  </files>
  <action>
    After targeted fixes pass, update `02-unsafe-audit-inventory.md` verification evidence with the exact strict command and results used for full in-scope re-verification.

    Run phase-quality checks to ensure no lint/format/test regressions are introduced by documentation hardening changes.
  </action>
  <verify>python scripts/verify_unsafe_safety_template.py --inventory .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md --strict && cargo fmt --all --check && cargo clippy -p velesdb-core -- -D warnings && cargo test -p velesdb-core simd_native_tests</verify>
  <done>Objective SAFETY coverage check is reproducible, passes for in-scope files, and inventory evidence records the command/results.</done>
</task>

</tasks>

<verification>
Run `python scripts/verify_unsafe_safety_template.py --inventory .planning/phases/02-unsafe-code-audit-testing-foundation/02-unsafe-audit-inventory.md --strict` and confirm zero missing SAFETY-template sites.
Then run `cargo fmt --all --check`, `cargo clippy -p velesdb-core -- -D warnings`, and `cargo test -p velesdb-core simd_native_tests`.
Confirm `rg -n "SAFETY \(" crates/velesdb-core/src/index/hnsw/vector_store.rs crates/velesdb-core/src/index/hnsw/index/vacuum.rs` returns no matches.
</verification>

<success_criteria>
The failed verifier truth is now satisfied: all in-scope unsafe blocks/impls in the gap scope are per-site auditable with template-complete SAFETY docs, and a deterministic command exists to re-verify this claim.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-04-SUMMARY.md`
</output>
