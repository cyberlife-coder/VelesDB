---
phase: 02-unsafe-code-audit-testing-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/velesdb-core/src/velesql/parser/select.rs
  - crates/velesdb-core/src/velesql/parser/values.rs
  - crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
autonomous: true
must_haves:
  truths:
    - "Known parser BUG-marker sites in `select.rs` and `values.rs` are resolved with executable regression assertions"
    - "Parser comments in scope describe current behavior/invariants, not stale bug history"
    - "BUG-02 boundary is explicit for this plan: only parser comments adjacent to targeted BUG-03 sites are audited"
    - "Parser behavior remains backward compatible except for intentional rejection of invalid aggregate wildcard usage"
  artifacts:
    - path: "crates/velesdb-core/src/velesql/parser/select.rs"
      provides: "Stable aggregate/HAVING logic at former BUG-marker sites"
    - path: "crates/velesdb-core/src/velesql/parser/values.rs"
      provides: "Stable correlated-subquery field extraction and dedup behavior"
    - path: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      provides: "Regression tests with direct assertions for each targeted parser hotspot"
  key_links:
    - from: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      to: "crates/velesdb-core/src/velesql/parser/select.rs"
      via: "exact parser regression tests for aggregate wildcard and HAVING operators"
      pattern: "test_bug_10_.*|test_bug_6_.*"
    - from: "crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs"
      to: "crates/velesdb-core/src/velesql/parser/values.rs"
      via: "correlated-subquery extraction/dedup assertions"
      pattern: "correlat|dedup"
---

<objective>
Stabilize parser fragility points and close BUG-03 with assertion-style regression coverage tied to targeted parser sites.

Purpose: Replace non-assertive verification and stale bug-marker dependence with durable parser behavior checks.
Output: Parser logic + comments updated at targeted sites, with explicit tests that fail on regression.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-unsafe-code-audit-testing-foundation/02-RESEARCH.md
@crates/velesdb-core/src/velesql/parser/select.rs
@crates/velesdb-core/src/velesql/parser/values.rs
@crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix targeted parser BUG sites with explicit scope boundary</name>
  <files>
    crates/velesdb-core/src/velesql/parser/select.rs
    crates/velesdb-core/src/velesql/parser/values.rs
  </files>
  <action>
    Resolve BUG-03 fragility at targeted parser sites:
    - `select.rs` aggregate wildcard validation and HAVING operator capture paths
    - `values.rs` correlated-subquery field extraction/dedup paths

    BUG-02 scope for this plan is strict:
    - In scope: comments directly adjacent to edited targeted parser logic.
    - Out of scope: unrelated parser prose and comments outside touched BUG-03 locations.

    Replace stale `BUG-* FIX` comments in edited sections with concise behavior/invariant comments tied to actual parser behavior.
  </action>
  <verify>! rg -n "BUG-" crates/velesdb-core/src/velesql/parser/select.rs crates/velesdb-core/src/velesql/parser/values.rs</verify>
  <done>Targeted parser hotspots are logic-backed (not comment-backed), and in-scope comments accurately describe current behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Add assertion-style regressions for each targeted hotspot</name>
  <files>
    crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
  </files>
  <action>
    Ensure regression tests explicitly assert expected outcomes for each targeted site:
    - Invalid aggregate wildcard rejected: `SUM(*)`, `AVG(*)`, `MIN(*)`, `MAX(*)`
    - Valid aggregate wildcard accepted: `COUNT(*)`
    - HAVING logical operator preservation (`OR` and `AND`) is asserted on parsed AST
    - Correlated-subquery field extraction and dedup behavior is asserted

    Tie test names and assertions to targeted parser logic so future regressions map directly to changed sites.
  </action>
  <verify>cargo test -p velesdb-core test_bug_10_sum_star_should_fail -- --exact && cargo test -p velesdb-core test_bug_10_count_star_should_succeed -- --exact && cargo test -p velesdb-core test_bug_6_having_or_tokens_captured -- --exact && cargo test -p velesdb-core test_bug_6_having_and_tokens_captured -- --exact</verify>
  <done>All targeted parser fragility cases have direct assertion tests that fail if behavior regresses.</done>
</task>

<task type="auto">
  <name>Task 3: Run parser regression + lint quality gates</name>
  <files>
    crates/velesdb-core/src/velesql/parser/select.rs
    crates/velesdb-core/src/velesql/parser/values.rs
    crates/velesdb-core/src/velesql/pr_review_bugfix_tests.rs
  </files>
  <action>
    Run parser-focused and lint validation after targeted fixes and regressions are in place.
  </action>
  <verify>cargo test -p velesdb-core pr_review_bugfix_tests && cargo test -p velesdb-core parser:: && cargo clippy -p velesdb-core -- -D warnings</verify>
  <done>Parser regression suite and parser-focused tests pass, and velesdb-core remains clippy-clean.</done>
</task>

</tasks>

<verification>
Run `cargo test -p velesdb-core pr_review_bugfix_tests`, `cargo test -p velesdb-core parser::`, and `cargo clippy -p velesdb-core -- -D warnings`.
Confirm there are no remaining `BUG-` markers in `select.rs`/`values.rs` and that targeted regression tests are assertion-based.
</verification>

<success_criteria>
BUG-03 is closed for targeted parser hotspots with assertion-style regression coverage, and BUG-02 parser comment edits remain within the explicit scoped boundary.
</success_criteria>

<output>
After completion, create `.planning/phases/02-unsafe-code-audit-testing-foundation/02-02-SUMMARY.md`
</output>
