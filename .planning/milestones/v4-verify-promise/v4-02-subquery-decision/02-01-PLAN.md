---
phase: 2
plan: 1
name: Core Scalar Subquery Executor
wave: 1
depends_on: none
autonomous: true
---

# Phase 2 Plan 1: Core Scalar Subquery Executor

## Objective

Create the subquery execution engine that takes a `Subquery` AST node and executes the inner `SelectStatement` against the collection, returning a scalar `Value`. This is the foundation that both MATCH WHERE and SELECT WHERE paths will use.

## Context

**Requirements addressed:** VP-002
**Phase goal contribution:** Provides the core execution capability for subqueries. Without this, all 4 README business scenarios silently return incorrect results because `Value::Subquery` converts to `Value::Null`.

**Current state:**
- Parser: ✅ Fully parses subqueries with correlation detection
- AST: ✅ `Value::Subquery(Box<Subquery>)` with `SelectStatement` + `Vec<CorrelatedColumn>`
- Execution: ❌ No executor exists — `Value::Subquery` → `Value::Null` in conversion

**Architecture insight:**
- `Collection::execute_query()` already executes `SelectStatement` and returns `Vec<SearchResult>`
- Subquery executor reuses this: execute inner SELECT, extract first result's first column value
- Uncorrelated subqueries: execute as-is (e.g., `SELECT AVG(price) FROM products`)
- Correlated subqueries: inject outer row values into params before execution

## Tasks

### Task 1: Write failing tests for scalar subquery execution (RED)

**Files:** `crates/velesdb-core/src/collection/search/query/subquery_tests.rs`

**Action:**
Create test file with tests for:
1. **Uncorrelated scalar subquery** — `(SELECT MAX(price) FROM products)` returns the max price value
2. **Uncorrelated AVG subquery** — `(SELECT AVG(score) FROM reviews)` returns average
3. **Subquery returning no results** — Returns `Value::Null`
4. **Subquery returning multiple rows** — Uses first row only (scalar subquery contract)
5. **Correlated subquery with outer context** — `(SELECT AVG(price) FROM inventory WHERE category = $outer_category)` with outer row binding

Use existing test patterns from `match_where_eval_tests.rs` for Collection setup with `create_test_collection_with_data`.

Register module in `mod.rs` under `#[cfg(test)]`.

**Verify:**
```powershell
cargo test -p velesdb-core --lib subquery_tests 2>&1 | Select-Object -Last 5
# Should show FAILURES (RED phase)
```

**Done when:**
- Tests compile but fail (no executor implementation yet)
- At least 5 test cases covering uncorrelated, correlated, empty, multi-row scenarios

---

### Task 2: Implement `execute_scalar_subquery` on Collection

**Files:** `crates/velesdb-core/src/collection/search/query/subquery.rs`

**Action:**
Create new module `subquery.rs` with:

```rust
impl Collection {
    /// Executes a scalar subquery and returns the result as a VelesQL Value.
    ///
    /// A scalar subquery must return at most one column and one row.
    /// If no rows match, returns Value::Null.
    /// If multiple rows match, uses the first row (SQL standard for scalar subqueries).
    pub(crate) fn execute_scalar_subquery(
        &self,
        subquery: &crate::velesql::Subquery,
        params: &HashMap<String, serde_json::Value>,
        outer_row: Option<&serde_json::Value>,  // For correlated subqueries
    ) -> Result<crate::velesql::Value>
```

Implementation approach:
1. Build a `Query` from the subquery's `SelectStatement`
2. If correlated: inject outer row values into a cloned params map using `correlations` metadata
3. Call `self.execute_query(&query, &resolved_params)`
4. Extract scalar: first result → first payload column → convert to `velesql::Value`
5. If no results → `Value::Null`

Key decisions:
- Subquery LIMIT is capped at 1 for scalar context (optimization)
- Correlated column resolution: look up `outer_table.outer_column` in `outer_row` payload
- Aggregation results (AVG, COUNT, SUM) appear in SearchResult payload as computed fields

Also add a helper:
```rust
/// Converts a serde_json::Value to a velesql::Value for use in comparisons.
fn json_to_velesql_value(json: &serde_json::Value) -> crate::velesql::Value
```

Register module in `mod.rs`:
```rust
mod subquery;
#[cfg(test)]
mod subquery_tests;
```

**Verify:**
```powershell
cargo test -p velesdb-core --lib subquery_tests 2>&1 | Select-Object -Last 10
# Should show tests passing (GREEN phase)
```

**Done when:**
- All subquery tests pass
- `execute_scalar_subquery` handles uncorrelated and correlated cases
- Returns `Value::Null` for empty results
- Uses first row for multi-row results

---

### Task 3: Add `resolve_subquery_value` helper for condition trees

**Files:** `crates/velesdb-core/src/collection/search/query/subquery.rs`

**Action:**
Add a method that resolves all `Value::Subquery` instances in a `velesql::Value`:

```rust
impl Collection {
    /// Resolves a Value that may contain a subquery into a concrete Value.
    ///
    /// If the value is `Value::Subquery`, executes it and returns the scalar result.
    /// Otherwise returns the value unchanged.
    pub(crate) fn resolve_value(
        &self,
        value: &crate::velesql::Value,
        params: &HashMap<String, serde_json::Value>,
        outer_row: Option<&serde_json::Value>,
    ) -> Result<crate::velesql::Value>
```

This is the reusable entry point that both MATCH WHERE and SELECT WHERE paths will call.

**Verify:**
```powershell
cargo test -p velesdb-core --lib subquery_tests 2>&1 | Select-Object -Last 5
cargo clippy -p velesdb-core -- -D warnings 2>&1 | Select-Object -Last 5
```

**Done when:**
- `resolve_value` delegates to `execute_scalar_subquery` for `Value::Subquery`
- Passes through all other `Value` variants unchanged
- No clippy warnings

---

## Verification

After all tasks complete:

```powershell
cargo fmt --all --check
cargo clippy -p velesdb-core -- -D warnings
cargo test -p velesdb-core --lib subquery_tests
```

## Success Criteria

- [ ] `execute_scalar_subquery` method exists and handles uncorrelated subqueries
- [ ] Correlated subqueries resolve outer references from `outer_row` context
- [ ] Empty subquery results return `Value::Null` (not silent data loss)
- [ ] `resolve_value` helper provides clean API for callers
- [ ] At least 5 tests covering edge cases
- [ ] No clippy warnings

## Output

**Files created:**
- `crates/velesdb-core/src/collection/search/query/subquery.rs` — Core executor
- `crates/velesdb-core/src/collection/search/query/subquery_tests.rs` — Tests

**Files modified:**
- `crates/velesdb-core/src/collection/search/query/mod.rs` — Register new modules
