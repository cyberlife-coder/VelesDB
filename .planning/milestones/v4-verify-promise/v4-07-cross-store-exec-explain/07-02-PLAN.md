# Plan 07-02: EXPLAIN Nodes for NEAR_FUSED & Cross-Store

## Objective

Add EXPLAIN plan nodes for NEAR_FUSED multi-vector fused search and cross-store (Vector + Graph MATCH) query paths, ensuring EXPLAIN output reflects all execution strategies introduced in Phase 6 and 07-01.

**Estimate:** 2-3h
**Wave:** 1 (after 07-01)

---

## Context

### Current State
- EXPLAIN system in `velesql/explain.rs` has 7 `PlanNode` variants:
  `VectorSearch`, `Filter`, `Limit`, `Offset`, `TableScan`, `IndexLookup`, `MatchTraversal`
- `from_select()` detects `VectorSearch` and `VectorFusedSearch` as `has_vector_search` but both map to the same `VectorSearch` plan node — no distinction
- No plan node for NEAR_FUSED (fusion strategy, vector count, fusion type)
- No plan node for cross-store (strategy, over-fetch factor, estimated cost)
- `from_match()` generates `MatchTraversal` but doesn't handle combined SELECT+MATCH
- Rendering in `formatter.rs` handles all existing 7 variants

### Target State
- New `PlanNode::FusedSearch(FusedSearchPlan)` for NEAR_FUSED queries
- New `PlanNode::CrossStoreSearch(CrossStoreSearchPlan)` for V+G combined queries
- `from_select()` detects `VectorFusedSearch` and generates `FusedSearch` node (not generic `VectorSearch`)
- New `from_combined()` method handles SELECT + MATCH combined queries
- `formatter.rs` renders both new plan nodes with strategy details
- JSON serialization works for both new nodes

---

## Tasks

### Task 1: TDD — Write EXPLAIN tests for new nodes

**Files:** `crates/velesdb-core/src/velesql/explain_tests.rs`

**Action:**
1. Add tests:
   - `test_explain_near_fused_query` — NEAR_FUSED generates FusedSearch node
   - `test_explain_fused_search_shows_strategy` — shows fusion strategy name + vector count
   - `test_explain_fused_search_render_tree` — tree rendering has FusedSearch details
   - `test_explain_fused_search_json` — JSON serialization includes all fields
   - `test_explain_cross_store_query` — combined V+G generates CrossStoreSearch node
   - `test_explain_cross_store_shows_strategy` — shows VectorFirst/Parallel/GraphFirst
   - `test_explain_cross_store_render_tree` — tree rendering
   - `test_explain_cross_store_json` — JSON serialization

**Verify:** `cargo test explain -- --no-run`

**Done:** Tests created, compiling

### Task 2: Add FusedSearch PlanNode

**Files:** `crates/velesdb-core/src/velesql/explain.rs`

**Action:**
1. Add struct:
   ```rust
   pub struct FusedSearchPlan {
       pub collection: String,
       pub vector_count: usize,
       pub fusion_strategy: String,
       pub candidates: u32,
   }
   ```
2. Add variant `PlanNode::FusedSearch(FusedSearchPlan)`
3. Update `analyze_condition()` to distinguish `VectorFusedSearch` from `VectorSearch`
4. In `from_select()`, when `VectorFusedSearch` detected → generate `FusedSearch` node
5. Update `node_cost()` for `FusedSearch` (slightly higher than single VectorSearch)

**Verify:** `cargo check --package velesdb-core`

**Done:** FusedSearch node compiles

### Task 3: Add CrossStoreSearch PlanNode

**Files:** `crates/velesdb-core/src/velesql/explain.rs`

**Action:**
1. Add struct:
   ```rust
   pub struct CrossStoreSearchPlan {
       pub collection: String,
       pub strategy: String,
       pub over_fetch_factor: f64,
       pub estimated_cost_ms: f64,
       pub has_metadata_filter: bool,
   }
   ```
2. Add variant `PlanNode::CrossStoreSearch(CrossStoreSearchPlan)`
3. Add `from_combined(stmt, match_clause, stats)` method:
   - Calls `QueryPlanner::choose_hybrid_strategy()` for strategy selection
   - Generates `CrossStoreSearch` node with strategy details
   - Adds child nodes (VectorSearch + MatchTraversal) in Sequence
4. Update `node_cost()` for `CrossStoreSearch`

**Verify:** `cargo check --package velesdb-core`

**Done:** CrossStoreSearch node compiles

### Task 4: Update formatter.rs rendering

**Files:** `crates/velesdb-core/src/velesql/explain/formatter.rs`

**Action:**
1. Add `PlanNode::FusedSearch` rendering:
   ```
   └─ FusedSearch
      ├─ Collection: docs
      ├─ Vectors: 3
      ├─ Fusion: RRF (k=60)
      └─ Candidates: 10
   ```
2. Add `PlanNode::CrossStoreSearch` rendering:
   ```
   └─ CrossStoreSearch
      ├─ Collection: docs
      ├─ Strategy: VectorFirst
      ├─ Over-fetch: 2.0x
      ├─ Est. Cost: 0.15ms
      └─ Has Filter: yes
   ```
3. Ensure JSON serialization includes all fields (already handled by derive(Serialize))

**Verify:** `cargo test explain && cargo clippy -- -D warnings`

**Done:** All rendering works, tests pass

---

## Key Files

| File | Role |
|------|------|
| `velesql/explain.rs` | Add FusedSearchPlan, CrossStoreSearchPlan structs + PlanNode variants |
| `velesql/explain/formatter.rs` | Render new plan nodes in tree format |
| `velesql/explain_tests.rs` | Tests for new EXPLAIN nodes |

## Success Criteria

- [ ] `PlanNode::FusedSearch` exists with fusion strategy, vector count
- [ ] `PlanNode::CrossStoreSearch` exists with strategy, over-fetch, cost
- [ ] `from_select()` distinguishes NEAR_FUSED from NEAR in EXPLAIN
- [ ] `from_combined()` handles SELECT + MATCH combined queries
- [ ] Tree rendering and JSON serialization work for both nodes
- [ ] 8+ new EXPLAIN tests pass
- [ ] No regressions on existing EXPLAIN tests
