# Plan 08-01: Database Query Executor & ColumnStore Builder

**Phase:** 8 — VelesQL Execution Completeness
**Requirement:** VP-014, VP-015 (foundation)
**Estimate:** 4-6h
**Depends on:** None (first plan)

---

## Goal

Create a `Database`-level query executor that wraps `Collection::execute_query()` with cross-collection capabilities. This is the foundation for JOIN and compound query execution.

---

## Tasks

### Task 1: Collection-to-ColumnStore Builder (TDD)

**File:** `crates/velesdb-core/src/column_store/from_collection.rs`

Build a `ColumnStore` from a Collection's point payloads for use as a JOIN target.

```rust
/// Builds a ColumnStore from a Collection's stored points.
///
/// Scans all points in the collection and extracts payload fields
/// into typed columns. The point ID becomes the primary key.
pub fn column_store_from_collection(
    collection: &Collection,
    max_rows: usize,
) -> Result<ColumnStore>
```

**Algorithm:**
1. Scan collection points (up to `max_rows`)
2. For each point, extract payload fields
3. Infer column types from first non-null value per field
4. Insert rows into ColumnStore with point.id as primary key
5. Return populated ColumnStore

**Tests (RED first):**
- `test_column_store_from_empty_collection` — returns empty ColumnStore
- `test_column_store_from_collection_with_payloads` — extracts string, int, float columns
- `test_column_store_primary_key_is_point_id` — PK lookups work
- `test_column_store_max_rows_limit` — respects max_rows cap
- `test_column_store_mixed_types_inferred` — handles mixed payload schemas

### Task 2: Database::execute_query() (TDD)

**File:** `crates/velesdb-core/src/lib.rs` (add method to `Database` impl block)

```rust
impl Database {
    /// Executes a VelesQL query with cross-collection support.
    ///
    /// This method extends `Collection::execute_query()` with:
    /// - JOIN execution (resolves JOIN tables as collections → ColumnStore)
    /// - Compound query execution (UNION/INTERSECT/EXCEPT across collections)
    ///
    /// # Arguments
    /// * `query` - Parsed VelesQL query
    /// * `params` - Query parameters
    ///
    /// # Errors
    /// Returns error if FROM collection not found, JOIN table not found,
    /// or underlying query execution fails.
    pub fn execute_query(
        &self,
        query: &velesql::Query,
        params: &HashMap<String, serde_json::Value>,
    ) -> Result<Vec<SearchResult>>
}
```

**Flow:**
1. Resolve FROM collection → `Collection`
2. Check if aggregation → delegate to `collection.execute_aggregate()`
3. Call `collection.execute_query()` → base results
4. If `stmt.joins` is non-empty → apply JOIN post-processing (Task in Plan 08-02)
5. If `query.compound` is Some → apply compound query (Task in Plan 08-03)
6. Return results

**For this plan, implement steps 1-3 only. Steps 4-5 are stubs returning `Err("not yet implemented")` that Plans 08-02 and 08-03 will fill.**

**Tests (RED first):**
- `test_database_execute_query_basic_select` — delegates to collection correctly
- `test_database_execute_query_collection_not_found` — returns Error::CollectionNotFound
- `test_database_execute_query_with_params` — parameters forwarded correctly
- `test_database_execute_query_aggregation` — routes to execute_aggregate

### Task 3: Wire Database Module

**File:** `crates/velesdb-core/src/lib.rs`

- Add `mod database_query;` if separate file, or add directly to `Database` impl
- Re-export `Database::execute_query()` in public API
- Ensure `#[cfg(feature = "persistence")]` gate is correct

### Task 4: Quality Gates

```powershell
cargo fmt --all --check
cargo clippy -- -D warnings
cargo test --workspace
cargo build --release
```

---

## Acceptance Criteria

- [ ] `column_store_from_collection()` builds ColumnStore from collection payloads
- [ ] `Database::execute_query()` delegates basic SELECT to Collection
- [ ] Error handling for missing collections
- [ ] Aggregation queries routed correctly
- [ ] JOIN stub returns clear "not yet implemented" error (Plan 08-02 fills this)
- [ ] Compound query stub returns clear error (Plan 08-03 fills this)
- [ ] All quality gates pass
- [ ] 8+ new tests

---

## Files

| File | Action |
|------|--------|
| `src/column_store/from_collection.rs` | **New** — ColumnStore builder |
| `src/column_store/mod.rs` | **Modify** — add `mod from_collection` |
| `src/lib.rs` | **Modify** — add `Database::execute_query()` |

---
*Created: 2026-02-09*
