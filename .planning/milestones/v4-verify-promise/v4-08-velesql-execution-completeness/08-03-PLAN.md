# Plan 08-03: Compound Query Execution (UNION/INTERSECT/EXCEPT)

**Phase:** 8 — VelesQL Execution Completeness
**Requirement:** VP-015
**Estimate:** 3-4h
**Depends on:** Plan 08-01 (Database executor)

---

## Goal

Implement execution for compound queries (UNION, UNION ALL, INTERSECT, EXCEPT) so that set operations actually combine results from two SELECT statements.

---

## Tasks

### Task 1: Compound Query Executor (TDD)

**File:** `crates/velesdb-core/src/collection/search/query/compound.rs` (new)

```rust
use crate::point::SearchResult;
use crate::velesql::SetOperator;
use std::collections::HashSet;

/// Applies a set operation to two result sets.
///
/// # Set Operations
/// - `Union`: merge + deduplicate by point.id
/// - `UnionAll`: concatenate (no dedup)
/// - `Intersect`: keep only IDs present in both
/// - `Except`: remove second set IDs from first
#[must_use]
pub fn apply_set_operation(
    left: Vec<SearchResult>,
    right: Vec<SearchResult>,
    operator: SetOperator,
) -> Vec<SearchResult>
```

**Algorithm:**
- **UNION**: Collect all results, deduplicate by `point.id` (keep first occurrence)
- **UNION ALL**: Simple `left.extend(right)`
- **INTERSECT**: Build `HashSet<u64>` of right IDs, filter left to only matching IDs
- **EXCEPT**: Build `HashSet<u64>` of right IDs, filter left to exclude matching IDs

**Tests (RED first):**
- `test_union_deduplicates` — same ID in both sets appears once
- `test_union_merges_different_ids` — different IDs combined
- `test_union_all_keeps_duplicates` — same ID appears twice
- `test_intersect_keeps_common` — only IDs in both sets
- `test_intersect_disjoint_returns_empty` — no common IDs → empty
- `test_except_removes_right_from_left` — right IDs removed from left
- `test_except_with_no_overlap` — all left results kept
- `test_empty_left_set` — edge case
- `test_empty_right_set` — edge case

### Task 2: Wire Compound Queries into Database::execute_query() (TDD)

**File:** `crates/velesdb-core/src/lib.rs` (or `database_query.rs`)

Replace the compound query stub from Plan 08-01:

```rust
// After base query + JOIN processing:
if let Some(ref compound) = query.compound {
    // 1. Resolve second SELECT's FROM collection
    let right_collection = self.get_collection(&compound.right.from)
        .ok_or_else(|| Error::CollectionNotFound(compound.right.from.clone()))?;
    
    // 2. Build a Query for the right side
    let right_query = Query::new_select(*compound.right.clone());
    
    // 3. Execute second query
    let right_results = right_collection.execute_query(&right_query, params)?;
    
    // 4. Apply set operation
    results = compound::apply_set_operation(results, right_results, compound.operator);
}
```

**Tests (RED first):**
- `test_database_union_two_collections` — merges results from two collections
- `test_database_union_all` — keeps duplicates
- `test_database_intersect` — only common points
- `test_database_except` — removes second set
- `test_database_union_same_collection` — same collection with different WHERE
- `test_database_compound_collection_not_found` — right FROM not found → error
- `test_database_compound_with_order_by` — ORDER BY applies to final result

### Task 3: Register Module

**File:** `crates/velesdb-core/src/collection/search/query/mod.rs`

- Add `pub mod compound;`

### Task 4: Quality Gates

```powershell
cargo fmt --all --check
cargo clippy -- -D warnings
cargo test --workspace
cargo build --release
```

---

## Acceptance Criteria

- [ ] `UNION` merges and deduplicates by point.id
- [ ] `UNION ALL` concatenates without dedup
- [ ] `INTERSECT` keeps only common IDs
- [ ] `EXCEPT` removes right set from left
- [ ] Cross-collection compound queries work
- [ ] Same-collection compound queries with different WHERE work
- [ ] Error on non-existent right-side collection
- [ ] All quality gates pass
- [ ] 16+ new tests

---

## Files

| File | Action |
|------|--------|
| `src/collection/search/query/compound.rs` | **New** — set operation executor |
| `src/collection/search/query/compound_tests.rs` | **New** — tests |
| `src/collection/search/query/mod.rs` | **Modify** — add `mod compound` |
| `src/lib.rs` (or `database_query.rs`) | **Modify** — wire compound into Database executor |

---
*Created: 2026-02-09*
