---
phase: 4
plan: 6
name: Cross-Store Scenario & VelesQL API Validation
wave: 2
depends_on: [04-01]
autonomous: true
parallel_safe: true
---

# Phase 4 Plan 06: Cross-Store Scenario & VelesQL API Validation

## Objective

Implement E2E tests for Scenario 0 (Technical Deep-Dive: Vector + Graph + Column + subquery) and validate the REST API examples from the README via direct VelesQL execution. This plan tests the most complex cross-store query and the core VelesQL execution path.

## Context

**Requirements addressed:** VP-007
**Phase goal contribution:** Validates the flagship Scenario 0 that demonstrates VelesDB's unique value proposition (one query across all three stores) and ensures the VelesQL examples from the README execute correctly.

## Tasks

### Task 1: Implement Scenario 0 — Technical Deep-Dive

**Files:** `tests/readme_scenarios/cross_store.rs`

**Action:**
Test the README query:
```sql
MATCH (doc:Document)-[:AUTHORED_BY]->(author:Author)
WHERE 
  similarity(doc.embedding, $research_question) > 0.8
  AND doc.category = 'peer-reviewed'
  AND (SELECT citation_count FROM author_metrics 
       WHERE author_id = author.id) > 50
ORDER BY similarity() DESC
LIMIT 5
```

**Two-level test:**

**Test A — Without subquery (core MATCH + similarity + filter):**
1. Create collection (dim=4, cosine)
2. Insert Document nodes with `_labels: ["Document"]`, `category` ('peer-reviewed', 'preprint'), `title`, vectors
3. Insert Author nodes with `_labels: ["Author"]`, `name`, `citation_count`
4. Add `AUTHORED_BY` edges (Document → Author)
5. Build MatchClause:
   - Pattern: `(doc:Document)-[:AUTHORED_BY]->(author:Author)`
   - WHERE: `similarity(doc.embedding, $q) > 0.8 AND doc.category = 'peer-reviewed'`
   - RETURN: `doc.title, author.name`
   - ORDER BY similarity() DESC, LIMIT 5
6. Assert:
   - Only peer-reviewed documents returned
   - Author names projected correctly
   - Results ordered by similarity

**Test B — With subquery (full cross-store):**
1. Reuse same collection and graph
2. Build MatchClause with subquery in WHERE:
   - `(SELECT citation_count FROM {collection_name} WHERE author_id = author.id) > 50`
   - Uses the scalar subquery executor from Phase 2
3. Assert:
   - Only authors with citation_count > 50 returned
   - Subquery resolves correctly against the same collection
   - Combined result set is correct intersection of all conditions

Note: If subquery correlation (`author.id` resolution) is not fully supported in the scalar subquery path, test with a non-correlated subquery and document the limitation.

**Verify:**
```powershell
cargo test --test readme_scenarios cross_store::test_scenario0 -- --nocapture
```

**Done when:**
- MATCH + similarity + column filter works (Test A)
- Subquery in WHERE evaluates correctly (Test B, or documented limitation)
- Cross-node property projection works (doc.title + author.name)

---

### Task 2: Validate VelesQL query execution examples

**Files:** `tests/readme_scenarios/cross_store.rs`

**Action:**
Test the VelesQL examples from README "Your First Vector Search" section:

**Test 1 — Basic SELECT with NEAR:**
```sql
SELECT * FROM my_vectors WHERE vector NEAR $v LIMIT 10
```
1. Create collection `my_vectors` (dim=4, cosine)
2. Insert 3 points with payloads (matching README example: "AI Introduction", "ML Basics", "History of Computing")
3. Parse and execute via `Parser::parse()` + `collection.execute_query()`
4. Assert: results returned, LIMIT respected

**Test 2 — SELECT with category filter:**
```sql
SELECT * FROM my_vectors WHERE vector NEAR $v AND category = 'tech' LIMIT 5
```
1. Reuse collection from Test 1
2. Assert: only 'tech' category results returned

**Test 3 — VelesQL aggregation (GROUP BY):**
```sql
SELECT category, COUNT(*) FROM products GROUP BY category HAVING COUNT(*) > 1
```
1. Create `products` collection with multiple categories
2. Parse and execute
3. Assert: grouped results with correct counts

**Test 4 — VelesQL UNION (set operations):**
```sql
SELECT * FROM active UNION SELECT * FROM archived
```
Note: If UNION execution is not supported at core level (requires two collections), test parsing only and document.

**Verify:**
```powershell
cargo test --test readme_scenarios cross_store::test_velesql -- --nocapture
```

**Done when:**
- Basic SELECT + NEAR query executes correctly
- Category filter works with vector search
- GROUP BY/HAVING produces correct aggregation
- Unsupported features return clear errors (not silent failures)

---

### Task 3: Manufacturing Quality Control scenario (bonus)

**Files:** `tests/readme_scenarios/cross_store.rs`

**Action:**
Test the small MATCH example from README "Real-World Impact Stories":
```sql
MATCH (part)-[HAS_DEFECT]->(defect)
WHERE defect.vector NEAR $image_vec
AND part.material = 'titanium'
```

Implementation:
1. Create collection (dim=4, cosine)
2. Insert Part nodes with `_labels: ["Part"]`, `material` ('titanium', 'steel', 'aluminum')
3. Insert Defect nodes with `_labels: ["Defect"]`, vectors
4. Add `HAS_DEFECT` edges
5. Build MatchClause and execute
6. Assert: only titanium parts returned, defect nodes reachable

This is a simpler test that validates yet another README example.

**Verify:**
```powershell
cargo test --test readme_scenarios cross_store::test_manufacturing -- --nocapture
```

**Done when:**
- MATCH traversal with material filter works
- Graph edges followed correctly

---

## Verification

After all tasks complete:

```powershell
cargo test --test readme_scenarios cross_store -- --nocapture
cargo clippy --test readme_scenarios -- -D warnings
```

## Success Criteria

- [ ] Scenario 0 Test A: MATCH + similarity + filter + cross-node projection works
- [ ] Scenario 0 Test B: Subquery in WHERE evaluates (or documented limitation)
- [ ] VelesQL basic SELECT + NEAR executes correctly
- [ ] VelesQL SELECT + filter + NEAR works
- [ ] VelesQL GROUP BY/HAVING aggregation works
- [ ] Manufacturing QC MATCH example works
- [ ] All unsupported features return clear errors, not silent failures

## Parallel Safety

**Exclusive write files:** `tests/readme_scenarios/cross_store.rs`
**Shared read files:** `tests/readme_scenarios/helpers.rs` (read), `crates/velesdb-core/src/**` (read)
**Conflicts with:** none (unique write file)

## Output

**Files modified:**
- `tests/readme_scenarios/cross_store.rs` — Replaces stub with cross-store + VelesQL validation tests
