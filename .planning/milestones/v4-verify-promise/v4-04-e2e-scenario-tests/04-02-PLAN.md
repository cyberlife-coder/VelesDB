---
phase: 4
plan: 2
name: SELECT Domain Scenarios
wave: 2
depends_on: [04-01]
autonomous: true
parallel_safe: true
---

# Phase 4 Plan 02: SELECT Domain Scenarios

## Objective

Implement E2E tests for the three SELECT-based domain scenarios from the README: Medical Research (Scenario 1), E-commerce Recommendations (Scenario 2), and Cybersecurity Threat Detection (Scenario 3). Each test sets up realistic data and executes the exact query pattern documented in the README.

## Context

**Requirements addressed:** VP-007
**Phase goal contribution:** Validates that SELECT + NEAR + column filter queries (LIKE, BETWEEN, temporal, multi-ORDER BY) work as documented in Scenarios 1-3.

## Tasks

### Task 1: Implement Scenario 1 — Medical Research Assistant

**Files:** `tests/readme_scenarios/select_domain.rs`

**Action:**
Test the README query:
```sql
SELECT study_id, title, publication_date 
FROM medical_studies 
WHERE vector NEAR $cancer_research_embedding 
  AND content LIKE '%BRCA1%' 
  AND publication_date > '2025-01-01'
ORDER BY similarity() DESC 
LIMIT 5
```

Implementation:
1. Create `medical_studies` collection (128-dim, cosine)
2. Insert 8+ points with payloads: `study_id`, `title`, `content` (some containing "BRCA1"), `publication_date` (mix of pre/post 2025)
3. Execute via `parse_and_execute_query()` helper or direct VelesQL parsing + execution
4. Assert:
   - Results contain only documents matching LIKE '%BRCA1%'
   - Results have publication_date > '2025-01-01'
   - Results are ordered by similarity DESC
   - LIMIT 5 respected

**Verify:**
```powershell
cargo test --test readme_scenarios select_domain::test_scenario1_medical_research -- --nocapture
```

**Done when:**
- LIKE filter correctly matches content containing "BRCA1"
- Date filter excludes old publications
- Results ordered by similarity

---

### Task 2: Implement Scenario 2 — E-commerce Recommendation

**Files:** `tests/readme_scenarios/select_domain.rs`

**Action:**
Test the README query:
```sql
SELECT product_id, name, price 
FROM products 
WHERE vector NEAR $user_preferences 
  AND price BETWEEN 20.00 AND 100.00 
  AND category = 'electronics'
ORDER BY similarity() DESC, price ASC 
LIMIT 8
```

Implementation:
1. Create `products` collection (128-dim, cosine)
2. Insert 12+ products with payloads: `product_id`, `name`, `price` (range $5-$500), `category` (electronics, sports, home)
3. Execute the query via VelesQL
4. Assert:
   - All results have price between 20.00 and 100.00
   - All results have category = 'electronics'
   - Results ordered by similarity DESC (primary), price ASC (secondary)
   - LIMIT 8 respected

**Verify:**
```powershell
cargo test --test readme_scenarios select_domain::test_scenario2_ecommerce -- --nocapture
```

**Done when:**
- BETWEEN filter on price works
- Category equality filter works
- Multi-column ORDER BY verified (similarity DESC, price ASC)

---

### Task 3: Implement Scenario 3 — Cybersecurity Threat Detection

**Files:** `tests/readme_scenarios/select_domain.rs`

**Action:**
Test the README query:
```sql
SELECT malware_hash, threat_level, first_seen 
FROM threat_intel 
WHERE vector NEAR $current_threat_embedding 
  AND first_seen > NOW() - INTERVAL '7 days'
  AND threat_level > 0.8
ORDER BY similarity() DESC, first_seen DESC
LIMIT 10
```

Implementation:
1. Create `threat_intel` collection (128-dim, cosine)
2. Insert 10+ threats with payloads: `malware_hash`, `threat_level` (0.0-1.0), `first_seen` (epoch timestamps, some recent, some old)
3. For temporal: use a fixed epoch timestamp comparison instead of NOW() (deterministic testing). The test proves the comparison operator works; temporal expression parsing is tested in Phase 1.
4. Assert:
   - All results have threat_level > 0.8
   - All results have first_seen > cutoff timestamp
   - Results ordered by similarity DESC
   - LIMIT 10 respected

**Verify:**
```powershell
cargo test --test readme_scenarios select_domain::test_scenario3_cybersecurity -- --nocapture
```

**Done when:**
- Numeric comparison (threat_level > 0.8) works in SELECT WHERE
- Temporal comparison works with epoch integers
- Multi-column ORDER BY verified

---

## Verification

After all tasks complete:

```powershell
cargo test --test readme_scenarios select_domain -- --nocapture
cargo clippy --test readme_scenarios -- -D warnings
```

## Success Criteria

- [ ] Scenario 1 test passes: LIKE + date filter + vector NEAR + ORDER BY
- [ ] Scenario 2 test passes: BETWEEN + equality + vector NEAR + multi ORDER BY
- [ ] Scenario 3 test passes: temporal + numeric comparison + vector NEAR + ORDER BY
- [ ] All results respect LIMIT constraints
- [ ] Each test uses realistic data matching README descriptions

## Parallel Safety

**Exclusive write files:** `tests/readme_scenarios/select_domain.rs`
**Shared read files:** `tests/readme_scenarios/helpers.rs` (read), `crates/velesdb-core/src/**` (read)
**Conflicts with:** none (unique write file)

## Output

**Files modified:**
- `tests/readme_scenarios/select_domain.rs` — Replaces stub with 3 SELECT domain scenario tests
