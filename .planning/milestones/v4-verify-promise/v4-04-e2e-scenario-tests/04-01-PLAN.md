---
phase: 4
plan: 1
name: Test Infrastructure & Hero Query
wave: 1
depends_on: none
autonomous: true
parallel_safe: true
---

# Phase 4 Plan 01: Test Infrastructure & Hero Query

## Objective

Create the `tests/readme_scenarios/` integration test module with shared helpers (DB setup, vector generation, graph construction) and implement the hero query test — the defining VelesDB query from README line 163-170.

## Context

**Requirements addressed:** VP-007
**Phase goal contribution:** Establishes the test infrastructure all other plans depend on, and validates the single most important query in the entire README.

## Tasks

### Task 1: Create integration test module structure

**Files:** `tests/readme_scenarios/main.rs`, `tests/readme_scenarios/helpers.rs`

**Action:**
Create the `tests/readme_scenarios/` directory as a multi-file integration test crate:

1. `main.rs` — Module declarations for ALL test files (including files created by later plans):
   ```rust
   mod helpers;
   mod hero_query;
   mod select_domain;
   mod metrics_and_fusion;
   mod match_simple;
   mod match_complex;
   mod cross_store;
   ```
2. `helpers.rs` — Shared test utilities:
   - `setup_test_db() -> (TempDir, Database)` — Creates a temp DB
   - `generate_embedding(seed: u64, dim: usize) -> Vec<f32>` — Deterministic embeddings
   - `setup_labeled_collection(db, name, dim, metric) -> Collection` — Creates collection
   - `insert_labeled_nodes(collection, nodes: &[(u64, Vec<f32>, serde_json::Value)])` — Bulk insert with payloads
   - `add_edges(collection, edges: &[(u64, u64, u64, &str)])` — Bulk add graph edges
   - `parse_and_execute_query(collection, sql, params) -> Result` — Parse VelesQL + execute
   - `build_match_clause(...)` helper for constructing MatchClause structs programmatically

- Use `tempfile::TempDir` for isolation
- Use `serde_json::json!` for payloads
- All helpers should be `pub(crate)` for use by sibling modules
- Follow existing patterns from `match_where_eval_tests.rs` and `multi_hop_tests.rs`

**Verify:**
```powershell
cargo test --test readme_scenarios -- --list 2>&1 | Select-String "test"
```

**Done when:**
- `tests/readme_scenarios/main.rs` compiles with all mod declarations
- `tests/readme_scenarios/helpers.rs` exports shared utilities
- Module structure matches Rust integration test conventions

---

### Task 2: Implement Hero Query test

**Files:** `tests/readme_scenarios/hero_query.rs`

**Action:**
Test the defining query from README:
```sql
MATCH (doc:Document)-[:AUTHORED_BY]->(author:Person)
WHERE similarity(doc.embedding, $question) > 0.8
  AND doc.category = 'research'
RETURN author.name, author.email, doc.title
ORDER BY similarity() DESC
LIMIT 5;
```

Implementation:
1. Set up collection with 4-dim vectors (sufficient for test)
2. Insert 6+ Document nodes with `_labels: ["Document"]`, `category`, `embedding` vectors, `title`
3. Insert 3+ Person nodes with `_labels: ["Person"]`, `name`, `email`
4. Add `AUTHORED_BY` edges from documents to persons
5. Build `MatchClause` programmatically with:
   - Pattern: `(doc:Document)-[:AUTHORED_BY]->(author:Person)`
   - WHERE: `similarity(doc.embedding, $question) > 0.8 AND doc.category = 'research'`
   - RETURN: `author.name, author.email, doc.title`
   - ORDER BY similarity() DESC, LIMIT 5
6. Execute with `collection.execute_match()`
7. Assert:
   - Results are non-empty
   - All returned docs have `category = 'research'`
   - Results contain projected properties (`author.name`, `doc.title`)
   - Results are ordered by similarity (descending)

**Verify:**
```powershell
cargo test --test readme_scenarios hero_query -- --nocapture
```

**Done when:**
- Hero query test passes
- Results contain correct projected properties from both doc and author nodes
- Similarity filtering works (non-research docs excluded)
- ORDER BY similarity() DESC ordering is verified

---

### Task 3: Create stub files for Wave 2 plans

**Files:** `tests/readme_scenarios/select_domain.rs`, `tests/readme_scenarios/metrics_and_fusion.rs`, `tests/readme_scenarios/match_simple.rs`, `tests/readme_scenarios/match_complex.rs`, `tests/readme_scenarios/cross_store.rs`

**Action:**
Create minimal stub files so `main.rs` compiles:
```rust
//! [Description] — Tests created by Phase 4 Plan XX.
//! Placeholder — implementation in plan 04-XX.
```

Each file should be an empty module (no tests yet) so the crate compiles.

**Verify:**
```powershell
cargo test --test readme_scenarios -- --list
```

**Done when:**
- All 7 files exist under `tests/readme_scenarios/`
- `cargo test --test readme_scenarios` compiles without errors
- Hero query test runs and passes

---

## Verification

After all tasks complete:

```powershell
cargo test --test readme_scenarios -- --nocapture
cargo clippy --test readme_scenarios -- -D warnings
```

## Success Criteria

- [ ] `tests/readme_scenarios/` module structure created with 7 files
- [ ] Shared helpers cover DB setup, vector generation, graph construction
- [ ] Hero query test passes with correct results
- [ ] Projected properties from both `doc` and `author` nodes returned
- [ ] Similarity filtering and ORDER BY verified
- [ ] All stub files compile

## Parallel Safety

**Exclusive write files:**
- `tests/readme_scenarios/main.rs`
- `tests/readme_scenarios/helpers.rs`
- `tests/readme_scenarios/hero_query.rs`
- `tests/readme_scenarios/select_domain.rs` (stub)
- `tests/readme_scenarios/metrics_and_fusion.rs` (stub)
- `tests/readme_scenarios/match_simple.rs` (stub)
- `tests/readme_scenarios/match_complex.rs` (stub)
- `tests/readme_scenarios/cross_store.rs` (stub)
**Shared read files:** `crates/velesdb-core/src/**` (read-only)
**Conflicts with:** none

## Output

**Files created:**
- `tests/readme_scenarios/main.rs` — Module root with all declarations
- `tests/readme_scenarios/helpers.rs` — Shared test utilities
- `tests/readme_scenarios/hero_query.rs` — Hero query E2E test
- `tests/readme_scenarios/select_domain.rs` — Stub for Plan 04-02
- `tests/readme_scenarios/metrics_and_fusion.rs` — Stub for Plan 04-03
- `tests/readme_scenarios/match_simple.rs` — Stub for Plan 04-04
- `tests/readme_scenarios/match_complex.rs` — Stub for Plan 04-05
- `tests/readme_scenarios/cross_store.rs` — Stub for Plan 04-06
