# Plan 06-04: Benchmarks, Validation & Quality Gates

## Objective

Validate performance claims for BM25/Trigram (22x+ vs LIKE scan) and NEAR_FUSED, run comprehensive regression tests, and ensure all quality gates pass.

**Estimate:** 3-4h
**Wave:** 2 (after 06-01, 06-02, 06-03)

---

## Context

### Claims to Validate
- "Trigram Index 22-128x faster" than LIKE scan
- Hybrid search (V + BM25) < 5ms on 10K docs
- NEAR_FUSED overhead < 20% vs single vector
- Cross-store query latency acceptable

### Existing Benchmarks
- `crates/velesdb-core/benches/` has existing criterion benchmarks
- No benchmarks yet for BM25 or trigram

---

## Tasks

### Task 1: Create BM25/Trigram benchmark suite

**Files:** `crates/velesdb-core/benches/bm25_trigram_bench.rs`

**Action:**
1. Create criterion benchmark with:
   - `bm25_search_10k` — BM25 search on 10K documents
   - `bm25_search_100k` — BM25 search on 100K documents
   - `trigram_like_10k` — Trigram-accelerated LIKE on 10K documents
   - `trigram_like_100k` — Trigram-accelerated LIKE on 100K documents
   - `like_scan_10k` — Baseline LIKE scan (brute force) on 10K
   - `like_scan_100k` — Baseline LIKE scan on 100K
2. Generate realistic test data (varied document lengths, vocabulary)
3. Register bench in `Cargo.toml` `[[bench]]` section

**Verify:** `cargo bench --bench bm25_trigram_bench -- --test` (dry run)

**Done:** Benchmark suite compiles and runs

### Task 2: Create NEAR_FUSED benchmark

**Files:** `crates/velesdb-core/benches/near_fused_bench.rs`

**Action:**
1. Create criterion benchmark with:
   - `single_vector_search_10k` — Baseline single NEAR search
   - `near_fused_2vec_rrf_10k` — NEAR_FUSED with 2 vectors, RRF
   - `near_fused_3vec_rrf_10k` — NEAR_FUSED with 3 vectors, RRF
   - `near_fused_2vec_average_10k` — Average fusion
   - `near_fused_overhead` — Measure fusion overhead %
2. Register bench in `Cargo.toml`

**Verify:** `cargo bench --bench near_fused_bench -- --test`

**Done:** Benchmark suite compiles and runs

### Task 2b: Create hybrid search (V+BM25) benchmark

**Files:** `crates/velesdb-core/benches/hybrid_search_bench.rs`

**Action:**
1. Create criterion benchmark with:
   - `vector_only_search_10k` — Baseline NEAR only
   - `text_only_search_10k` — Baseline BM25 only
   - `hybrid_search_10k` — NEAR + BM25 with RRF fusion
   - `hybrid_search_with_filter_10k` — NEAR + BM25 + metadata filter
2. Validate the claim: hybrid search < 5ms on 10K docs
3. Register bench in `Cargo.toml`

**Verify:** `cargo bench --bench hybrid_search_bench -- --test`

**Done:** Hybrid search benchmark compiles and runs

### Task 3: Run benchmarks and document results

**Files:** `docs/BENCHMARKS.md` (update)

**Action:**
1. Run BM25/Trigram benchmarks, record results
2. Run NEAR_FUSED benchmarks, record results
3. Run hybrid search (V+BM25) benchmarks, record results
4. Calculate speedup ratios for all categories
5. Update `docs/BENCHMARKS.md` with new performance tables:
   - BM25/Trigram section: speedup vs LIKE scan
   - NEAR_FUSED section: overhead % vs single vector
   - Hybrid search section: combined latency V+BM25
6. If trigram speedup < 22x, add note about conditions for claimed performance
7. If hybrid > 5ms, document actual latency and adjust claims

**Verify:** Results documented with actual numbers

**Done:** BENCHMARKS.md updated with measured results

### Task 4: E2E integration test for all Phase 6 features

**Files:** `crates/velesdb-core/tests/phase6_integration.rs`

**Action:**
1. Create integration test that exercises all new query paths:
   - NEAR_FUSED with RRF
   - NEAR + MATCH 'keyword' (hybrid)
   - NEAR + MATCH (a)-[:REL]->(b) (cross-store, if implemented)
   - MATCH 'keyword' + metadata filter
   - Combined three-way query
2. Verify no panics, correct result ordering, limits respected

**Verify:** `cargo test --test phase6_integration`

**Done:** Integration tests pass

### Task 5: Quality gates and final validation

**Files:** Various

**Action:**
1. Run full quality gate suite:
   ```powershell
   cargo fmt --all --check
   cargo clippy -- -D warnings
   cargo deny check
   cargo test --workspace
   cargo build --release
   ```
2. Verify test count increased (should be 3,222 + new tests)
3. Verify no new clippy warnings
4. Verify no security advisories

**Verify:** All 5 quality gates pass

**Done:** Phase 6 quality gates complete

---

## Success Criteria

- [ ] BM25/Trigram benchmarks show measurable speedup vs LIKE scan
- [ ] NEAR_FUSED overhead documented (target < 20%)
- [ ] Hybrid search (V+BM25) latency documented (target < 5ms on 10K)
- [ ] E2E integration tests pass for all new query patterns
- [ ] All 5 quality gates pass
- [ ] BENCHMARKS.md updated with real numbers for all 3 categories
- [ ] Test count increased with no regressions
