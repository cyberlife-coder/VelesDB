---
phase: 2
plan: 3
name: Fusion Unification & ParseError
wave: 1
depends_on: none
autonomous: true
---

# Phase 2 Plan 3: Fusion Unification & ParseError

## Objective

Delete the broken `FusionStrategy` enum in `score_fusion/mod.rs` (fake RRF: `1/(k+(1-score)*100)`) and wire the query execution path to use the correct `crate::fusion::FusionStrategy`. Fix fusion parameter parsing to return errors instead of silent `unwrap_or(0.0)`.

## Context

**Requirements addressed:** D-09 (fusion params), C-04/B-03 triage follow-up
**Phase goal contribution:** Eliminates the last source of wrong fusion results. After this, only ONE `FusionStrategy` exists in the codebase.

**Critical discovery:** Two parallel implementations coexist:
- `crate::fusion::FusionStrategy` — **CORRECT** (RRF: `1/(k+rank+1)`, Weighted with 3 weights)
- `collection::search::query::score_fusion::FusionStrategy` — **BROKEN** (RRF: `1/(k+(1-score)*100)`)

The query execution path uses the broken one.

## Tasks

### Task 1: Delete old FusionStrategy enum from score_fusion

**Files:**
- `crates/velesdb-core/src/collection/search/query/score_fusion/mod.rs`

**Action:**
1. Delete the `FusionStrategy` enum (Rrf, Weighted, Maximum, Minimum variants)
2. Delete its `impl` block with the broken `combine()` method containing `1.0 / (k + (1.0 - s) * 100.0)`
3. Import `crate::fusion::FusionStrategy` instead
4. Adapt calling code: the `ScoreBreakdown` or score application logic that calls `strategy.combine(scores)` must now call `strategy.fuse(results)` with the correct signature
5. If `mod.rs` > 300 lines after changes, extract `ScoreBreakdown` into `breakdown.rs`

**Verify:**
```powershell
# No more broken RRF formula
Select-String -Path "crates/velesdb-core/src/collection/search/query/score_fusion/mod.rs" -Pattern "1.0 - s.*100"
# Should find zero matches

cargo check --package velesdb-core --features persistence
```

**Done when:**
- Zero occurrences of `1/(k+(1-score)*100)` formula
- Only ONE `FusionStrategy` type in entire crate (`crate::fusion::FusionStrategy`)
- `cargo check` passes

---

### Task 2: Fix fusion parameter parsing

**Files:**
- `crates/velesdb-core/src/velesql/parser/conditions.rs`
- `crates/velesdb-core/src/velesql/parser/match_parser.rs`

**Action:**
1. In `conditions.rs:224`: Replace `val.as_str().parse::<f64>().unwrap_or(0.0)` with proper error handling:
```rust
let val_f64 = val.as_str().parse::<f64>().map_err(|_| {
    ParseError::InvalidValue(format!("Invalid fusion parameter: '{}'", val.as_str()))
})?;
```
2. In `match_parser.rs:202`: Replace `inner_pair.as_str().parse().unwrap_or(0.0)` with:
```rust
inner_pair.as_str().parse().map_err(|_| {
    ParseError::InvalidValue(format!("Invalid float literal: '{}'", inner_pair.as_str()))
})?
```
3. If `ParseError::InvalidValue` doesn't exist, add it to the error enum.

**Verify:**
```powershell
# No more unwrap_or(0.0) in parser files
Select-String -Path "crates/velesdb-core/src/velesql/parser/conditions.rs" -Pattern "unwrap_or\(0\.0\)"
Select-String -Path "crates/velesdb-core/src/velesql/parser/match_parser.rs" -Pattern "unwrap_or\(0\.0\)"
# Should find zero matches

cargo test --package velesdb-core -- velesql::parser
```

**Done when:**
- Invalid fusion params → `ParseError` (not silent 0.0)
- All parser tests pass
- No `unwrap_or(0.0)` in parser code

---

### Task 3: Add regression tests for fusion unification

**Files:**
- `crates/velesdb-core/src/fusion/strategy_tests.rs`
- `crates/velesdb-core/src/collection/search/query/score_fusion_tests.rs` (or equivalent)

**Action:**
1. Add test: RRF with known rankings produces expected scores (verify formula is `1/(k+rank+1)`)
2. Add test: Weighted with non-uniform weights produces different result than Average
3. Add test: Invalid fusion param string → ParseError (not 0.0)
4. Add test: query execution path uses correct FusionStrategy (integration-level)

**Verify:**
```powershell
cargo test --package velesdb-core -- fusion
cargo test --package velesdb-core -- score_fusion
```

**Done when:**
- RRF formula verified by test with known expected values
- Weighted ≠ Average confirmed by test
- Invalid param → error confirmed by test

---

## Verification

After all tasks complete:

```powershell
# No broken fusion code remaining
Select-String -Path "crates/velesdb-core/src/**/*.rs" -Pattern "1\.0 - s.*100|unwrap_or\(0\.0\)" -Recurse

# Full test suite
cargo test --workspace --features persistence,gpu,update-check --exclude velesdb-python

# Quality gates
cargo fmt --all --check
cargo clippy --workspace --features persistence,gpu,update-check --exclude velesdb-python -- -D warnings
```

## Success Criteria

- [ ] Only ONE `FusionStrategy` in crate: `crate::fusion::FusionStrategy`
- [ ] Old broken RRF formula `1/(k+(1-score)*100)` deleted
- [ ] Query execution path uses correct `fusion::FusionStrategy`
- [ ] Invalid fusion params → `ParseError` (not silent 0.0)
- [ ] `score_fusion/mod.rs` ≤ 300 lines (split if needed)
- [ ] Regression tests for RRF, Weighted, and param validation

## Output

**Files modified:**
- `crates/velesdb-core/src/collection/search/query/score_fusion/mod.rs` — delete old enum, wire to `fusion::FusionStrategy`
- `crates/velesdb-core/src/velesql/parser/conditions.rs` — ParseError instead of unwrap_or
- `crates/velesdb-core/src/velesql/parser/match_parser.rs` — ParseError instead of unwrap_or

**Files created (if needed):**
- `crates/velesdb-core/src/collection/search/query/score_fusion/breakdown.rs` — extracted ScoreBreakdown
